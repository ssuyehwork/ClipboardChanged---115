WriteData1014() {
    Global SQLiteDB, DBPath, ClipboardLock, ProcessingContext, g_CurrentRecord, ContentCache, G_last_insert_rowid
    AddDebugLog("[WriteData1014] å¼€å§‹")
    ClipboardLock := 1
    ProcessingContext := "WriteData1014"

    WinGetTitle, WindowTitle, A
    if (RegExMatch(WindowTitle, "(.+?)\s*-\s*(.+)$", Match)) {
        AppName := Trim(Match2)
    } else {
        AppName := WindowTitle ? WindowTitle : "æœªçŸ¥åº”ç”¨"
    }
    WindowDetail := WindowTitle ? WindowTitle : ""
    Group := ""  ; æ— åˆ†ç»„
    DataType := 1  ; æ–‡æœ¬
    Identifier := "" ; Identifier := "ğŸ“„"
    Format := "CF_UNICODETEXT,æ–‡æœ¬"

    FinalID := ""  ; ç”¨äºfinallyå’Œåˆ†ç±»å­—å…¸_Oneï¼ˆæœ€åä¸€ä¸ªIDï¼‰
    InsertedCount := 0
    FailedCount := 0
    try {
        if (!CheckDBUnlocked(DBPath)) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š455988 æ•°æ®åº“è¢«å ç”¨ï¼Œè¯·ç¨åå†è¯•
            AddDebugLog("[WriteData1014] æ•°æ®åº“è¢«å ç”¨")
            Return
        }

        if (!SQLiteDB) {
            SQLiteDB := New SQLiteDB()
            if (!SQLiteDB.OpenDB(DBPath)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š753594 æ•°æ®åº“æ‰“å¼€å¤±è´¥: %ErrorMsg%
                AddDebugLog("[WriteData1014] æ‰“å¼€æ•°æ®åº“å¤±è´¥: " . ErrorMsg)
                Return
            }
        }

        ; æ£€æŸ¥æ•°æ®æ”¶é›†è¡¨å’Œå…³è”è¡¨å­˜åœ¨ï¼ˆå‚è€ƒClipboardChangedï¼‰
        CheckSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ•°æ®æ”¶é›†';"
        CheckResult := {}
        if (!SQLiteDB.GetTable(CheckSQL, CheckResult) || CheckResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š233830 æ•°æ®æ”¶é›†è¡¨ä¸å­˜åœ¨ï¼
            AddDebugLog("[WriteData1014] æ•°æ®æ”¶é›†è¡¨ä¸å­˜åœ¨")
            Return
        }
        CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ•°æ®æ”¶é›†_å…³è”å±æ€§';"
        PropTableResult := {}
        if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5400063 æ•°æ®æ”¶é›†_å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            Return
        }
        CheckAssocTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='å…³è”å±æ€§è¡¨';"
        AssocTableResult := {}
        if (!SQLiteDB.GetTable(CheckAssocTableSQL, AssocTableResult) || AssocTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š7531900 å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            Return
        }

        GetColumnsSQL := "PRAGMA table_info(æ•°æ®æ”¶é›†);"
        ColumnsResult := {}
        RequiredFields := ["å¤‡æ³¨", "å†…å®¹", "ç½®é¡¶", "ç½®é¡¶ç´¢å¼•", "æ”¶è—", "ç¦åˆ ", "æ˜Ÿçº§", "æ ‡ç­¾", "åˆ†ç»„", "ç±»å‹", "åˆ›å»ºæ—¶é—´", "ä¿®æ”¹æ—¶é—´", "è®¿é—®æ—¶é—´", "è®¿é—®æ¬¡æ•°", "æ›´æ–°æ¬¡æ•°", "å­—èŠ‚", "å­—ç¬¦", "è¡Œæ•°", "æ•°é‡", "æ ‡è¯†", "çª—å£è¯¦æƒ…", "åº”ç”¨åç§°", "å“ˆå¸Œå€¼", "æ’åº", "æ ‡è®°çŠ¶æ€"]
        MissingFields := []
        if (SQLiteDB.GetTable(GetColumnsSQL, ColumnsResult)) {
            ExistingColumns := []
            Loop, % ColumnsResult.RowCount {
                ExistingColumns.Insert(ColumnsResult.Rows[A_Index][2])
            }
            for index, field in RequiredFields {
                if (!ArrayContains(ExistingColumns, field)) {
                    MissingFields.Insert(field)
                }
            }
            if (MissingFields.MaxIndex() > 0) {
                MissingFieldsList := Join(MissingFields, ", ")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š2741609 æ•°æ®æ”¶é›†è¡¨ç¼ºå°‘å¿…è¦å­—æ®µï¼š%MissingFieldsList%
                Return
            }
        } else {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1840275 æŸ¥è¯¢è¡¨ç»“æ„å¤±è´¥: %ErrorMsg%
            Return
        }

        Sleep, 100  ; é˜²å¡é¡¿ï¼Œå‚è€ƒClipboardChanged

        if (!BeginSafeTransaction("WriteData1014-Batch")) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1928523 å¼€å§‹æ‰¹é‡äº‹åŠ¡å¤±è´¥ï¼
            Return
        }

        AddDebugLog("[WriteData1014] ContentCache æ€»è¡Œæ•°: " . ContentCache.MaxIndex())

        ; å¤„ç†ContentCacheä¸­çš„æ¯ä¸ªå†…å®¹ï¼ˆæŒ‰è¡Œå­˜å‚¨ï¼Œç»Ÿä¸€äº‹åŠ¡å†…ï¼‰
        for index, ClipData in ContentCache {
            AddDebugLog("[WriteData1014] å¤„ç†ç¬¬ " . index . " è¡Œï¼ŒåŸå§‹é•¿åº¦: " . StrLen(ClipData))
            AddDebugLog("[WriteData1014] åŸå§‹å†…å®¹å‰100å­—ç¬¦: " . SubStr(ClipData, 1, 100))

            ; æ¸…ç†å†…å®¹
            ClipData := RegExReplace(ClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", "")
            ClipData := Trim(ClipData)
            if (ClipData = "" || StrLen(ClipData) > 5000000) {
                FailedCount++
                AddDebugLog("[WriteData1014] ç¬¬ " . index . " è¡Œè·³è¿‡: ç©ºå†…å®¹æˆ–è¶…é•¿")
                continue
            }

            ; â­ ç®€åŒ–ï¼šç§»é™¤åŒè¯­åˆ†ç¦»ï¼Œç›´æ¥ç”¨å…¨ ClipData å¤„ç†ï¼ˆæ— éœ€åŒºåˆ†è¯­è¨€ï¼‰
            AddDebugLog("[WriteData1014] å…¨å†…å®¹é•¿åº¦: " . StrLen(ClipData))

            Remark := SubStr(ClipData, 1, 1000)  ; Remark ç”¨å‰ 1000 å­—ç¬¦
            Remark := RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ")
            Content := ClipData  ; Content ç”¨å…¨æ–‡æœ¬

            ; è®¡ç®—å­—èŠ‚ (åŸºäºå…¨ ClipData)
            ByteCount := StrPut(ClipData, "UTF-8") - 1
            Bytes := ""
            if (ByteCount > 0) {
                if (ByteCount < 1024)
                    Bytes := ByteCount . " B"
                else if (ByteCount < 1024 * 1024)
                    Bytes := Round(ByteCount / 1024,2) . " KB"
                else if (ByteCount < 1024 * 1024 * 1024)
                    Bytes := Round(ByteCount / (1024 * 1024),2) . " MB"
                else
                    Bytes := Round(ByteCount / (1024 * 1024 * 1024),2) . " GB"
            }

            AddDebugLog("[WriteData1014] å­—èŠ‚ç»Ÿè®¡: " . Bytes)

            try {
                HashValue := Crypt.Hash.Str(ClipData, "SHA256")  ; å“ˆå¸ŒåŸºäºå…¨æ–‡æœ¬
                AddDebugLog("[WriteData1014] å“ˆå¸Œå€¼: " . SubStr(HashValue, 1, 16) . "...")
            } catch e {
                eMessage := e.Message
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š542882 è®¡ç®—å“ˆå¸Œå€¼å¤±è´¥: %eMessage%
                AddDebugLog("[WriteData1014] è®¡ç®—å“ˆå¸Œå€¼å¤±è´¥: " . eMessage)
                FailedCount++
                continue
            }

            ; â­ ä¿®æ”¹2ï¼šä½¿ç”¨åˆ†ç±»å­—å…¸_Oneè¡¨ç»´æŠ¤æ’åºæœ€å¤§å€¼ï¼ˆå‚è€ƒClipboardChangedï¼‰
            GetMaxSortSQL := "SELECT COALESCE(""Record_Value"", 0) FROM ""åˆ†ç±»å­—å…¸_One"" WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' LIMIT 1;"
            MaxSortResult := {}
            CurrentMax := 0
            if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                CurrentMax := MaxSortResult.Rows[1][1] + 0
            } else {
                ; åˆå§‹åŒ–
                InitSQL := "INSERT OR IGNORE INTO ""åˆ†ç±»å­—å…¸_One"" (""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('æ’åºå€¼', 'æœ€å¤§å€¼', '0', 0, datetime('now','localtime'));"
                if (!SQLiteDB.Exec(InitSQL)) {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("[WriteData1014] æ’åºåˆå§‹åŒ–å¤±è´¥: " . ErrorMsg)
                }
                CurrentMax := 0
            }

            ; å¾ªç¯è·å–å”¯ä¸€æ’åºå€¼
            NewSortValue := 0
            Loop {
                NewSortValue := CurrentMax + 1
                ; å°è¯•æ›´æ–°æœ€å¤§å€¼
                UpdateMaxSQL := "UPDATE ""åˆ†ç±»å­—å…¸_One"" SET ""Record_Value"" = ?, ""Update_Time"" = datetime('now','localtime') "
                              . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' AND ""Record_Value"" = ?;"
                Success := false
                RetryCount := 3
                while (RetryCount > 0) {
                    if (SQLiteDB.ExecuteWithParams) {
                        if (SQLiteDB.ExecuteWithParams(UpdateMaxSQL, [NewSortValue, CurrentMax])) {
                            Success := true
                            break
                        }
                    } else {
                        FallbackSQL := "UPDATE ""åˆ†ç±»å­—å…¸_One"" SET ""Record_Value"" = '" . NewSortValue . "', ""Update_Time"" = datetime('now','localtime') "
                                     . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' AND ""Record_Value"" = '" . CurrentMax . "';"
                        if (SQLiteDB.Exec(FallbackSQL)) {
                            Success := true
                            break
                        }
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 50
                        RetryCount--
                        continue
                    }
                    if (InStr(ErrorMsg, "UNIQUE constraint failed")) {
                        ; é‡æ–°è¯»å–
                        if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                            CurrentMax := MaxSortResult.Rows[1][1] + 0
                        } else {
                            CurrentMax := 0
                        }
                        break
                    }
                    break
                }
                if (Success) {
                    break
                } else {
                    ; æ›´æ–°å¤±è´¥ï¼Œé‡æ–°è¯»å–å½“å‰æœ€å¤§å€¼
                    if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                        CurrentMax := MaxSortResult.Rows[1][1] + 0
                    } else {
                        CurrentMax := 0
                    }
                }
            }

            AddDebugLog("[WriteData1014] æ–°æ’åºå€¼: " . NewSortValue)

            ExistingID := ""
            CheckSQL := "SELECT ID FROM æ•°æ®æ”¶é›† WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
            CheckResult := {}
            if (SQLiteDB.GetTable(CheckSQL, CheckResult, [HashValue]) && CheckResult.RowCount >= 1) {
                ExistingID := CheckResult.Rows[1][1]
                AddDebugLog("[WriteData1014] å‘ç°é‡å¤è®°å½• ID: " . ExistingID)
            } else {
                AddDebugLog("[WriteData1014] æœªå‘ç°é‡å¤ï¼Œå‡†å¤‡æ–°å¢")
            }

            if (StrLen(Content) > 1000000) {
                Content := SubStr(Content, 1, 1000000)
            }
            if (StrLen(Remark) > 1000) {
                Remark := SubStr(Remark, 1, 1000)
            }
            HashValue := HashValue ? HashValue : ""
            Bytes := Bytes ? Bytes : ""
            WindowDetail := WindowDetail ? WindowDetail : ""
            Identifier := Identifier ? Identifier : ""
            Format := Format ? Format : ""
            NewSortValue := NewSortValue ? NewSortValue : 1
            Remark := Remark ? RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            Content := Content ? RegExReplace(Content, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            Group := Group ? RegExReplace(Group, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            AppName := AppName ? RegExReplace(AppName, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : "æœªçŸ¥åº”ç”¨"

            EscapedHashValue := StrReplace(HashValue, "'", "''")
            EscapedBytes := StrReplace(Bytes, "'", "''")
            EscapedWindowDetail := StrReplace(WindowDetail, "'", "''")
            EscapedIdentifier := StrReplace(Identifier, "'", "''")
            EscapedFormat := StrReplace(Format, "'", "''")
            EscapedRemark := StrReplace(Remark, "'", "''")
            EscapedContent := StrReplace(Content, "'", "''")
            EscapedGroup := StrReplace(Group, "'", "''")
            EscapedAppName := StrReplace(AppName, "'", "''")
            EscapedClipData := StrReplace(ClipData, "'", "''")  ; ooData ç”¨å…¨ ClipData

            AddDebugLog("[WriteData1014] å‡†å¤‡æ’å…¥åˆ°ä¸»è¡¨å†…å®¹å­—æ®µçš„é•¿åº¦: " . StrLen(EscapedContent))
            AddDebugLog("[WriteData1014] å‡†å¤‡æ’å…¥åˆ° ooData çš„å†…å®¹é•¿åº¦: " . StrLen(EscapedClipData))

            Success := false
            RetryCount := 3
            LocalG_last_insert_rowid := ""

            if (ExistingID != "") {
                ; â­ ä¿®æ”¹3ï¼šUPDATEæ—¶åŒæ—¶æ›´æ–°å†…å®¹å­—æ®µ
                UpdateSQL := "UPDATE æ•°æ®æ”¶é›† SET æ’åº = " . NewSortValue . ", æ›´æ–°æ¬¡æ•° = COALESCE(æ›´æ–°æ¬¡æ•°, 0) + 1, ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime'), è®¿é—®æ—¶é—´ = datetime('now', 'localtime'), å¤‡æ³¨ = '" . EscapedRemark . "', å†…å®¹ = '" . EscapedContent . "', å­—èŠ‚ = '" . EscapedBytes . "', çª—å£è¯¦æƒ… = '', æ ‡è¯† = '', ç±»å‹ = '', åˆ†ç»„ = '', åº”ç”¨åç§° = '' WHERE ID = " . ExistingID . ";"

                AddDebugLog("[WriteData1014] æ‰§è¡Œ UPDATE ä¸»è¡¨ SQL")

                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(UpdateSQL)) {
                        Success := true
                        FinalID := ExistingID
                        LocalG_last_insert_rowid := ExistingID
                        AddDebugLog("[WriteData1014] UPDATE ä¸»è¡¨æˆåŠŸï¼ŒID: " . ExistingID)
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("[WriteData1014] UPDATE ä¸»è¡¨å¤±è´¥: " . ErrorMsg)
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    AddDebugLog("[WriteData1014] UPDATE ä¸»è¡¨æœ€ç»ˆå¤±è´¥")
                    continue
                }

                DeleteDataSQL := "DELETE FROM Data_æ•°æ®æ”¶é›† WHERE lParentID = " . FinalID . ";"
                RetryCount := 3
                Success := false

                AddDebugLog("[WriteData1014] åˆ é™¤æ—§ Data_æ•°æ®æ”¶é›† è®°å½•")

                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(DeleteDataSQL)) {
                        Success := true
                        AddDebugLog("[WriteData1014] åˆ é™¤æ—§ Data æˆåŠŸ")
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("[WriteData1014] åˆ é™¤æ—§ Data å¤±è´¥: " . ErrorMsg)
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    AddDebugLog("[WriteData1014] åˆ é™¤æ—§ Data æœ€ç»ˆå¤±è´¥")
                    continue
                }

                DeletePropSQL := "DELETE FROM æ•°æ®æ”¶é›†_å…³è”å±æ€§ WHERE ID = " . FinalID . ";"
                RetryCount := 3
                Success := false

                AddDebugLog("[WriteData1014] åˆ é™¤æ—§å…³è”å±æ€§")

                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(DeletePropSQL)) {
                        Success := true
                        AddDebugLog("[WriteData1014] åˆ é™¤æ—§å±æ€§æˆåŠŸ")
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("[WriteData1014] åˆ é™¤æ—§å±æ€§å¤±è´¥: " . ErrorMsg)
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    AddDebugLog("[WriteData1014] åˆ é™¤æ—§å±æ€§æœ€ç»ˆå¤±è´¥")
                    continue
                }

                InsertDataSQL := "INSERT INTO Data_æ•°æ®æ”¶é›† (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", 'CF_UNICODETEXT', '" . EscapedClipData . "');"
                RetryCount := 3
                Success := false

                AddDebugLog("[WriteData1014] æ’å…¥æ–° Data_æ•°æ®æ”¶é›†ï¼ŒooData é•¿åº¦: " . StrLen(EscapedClipData))

                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertDataSQL)) {
                        Success := true
                        AddDebugLog("[WriteData1014] æ’å…¥æ–° Data æˆåŠŸ")
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("[WriteData1014] æ’å…¥æ–° Data å¤±è´¥: " . ErrorMsg)
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    AddDebugLog("[WriteData1014] æ’å…¥æ–° Data æœ€ç»ˆå¤±è´¥")
                    continue
                }
            } else {
                ; â­ ä¿®æ”¹4ï¼šINSERTæ—¶åŒæ—¶æ’å…¥å†…å®¹å­—æ®µ
                InsertMainSQL := "INSERT INTO æ•°æ®æ”¶é›† (å“ˆå¸Œå€¼, å­—èŠ‚, çª—å£è¯¦æƒ…, æ ‡è¯†, ç±»å‹, æ’åº, æ›´æ–°æ¬¡æ•°, åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´, è®¿é—®æ—¶é—´, å¤‡æ³¨, å†…å®¹, åˆ†ç»„, åº”ç”¨åç§°, ç¦åˆ ) VALUES ('" . EscapedHashValue . "', '" . EscapedBytes . "', '', '', '', " . NewSortValue . ", 0, datetime('now', 'localtime'), datetime('now', 'localtime'), datetime('now', 'localtime'), '" . EscapedRemark . "', '" . EscapedContent . "', '', '', 1);"
                RetryCount := 3
                Success := false

                AddDebugLog("[WriteData1014] æ‰§è¡Œ INSERT ä¸»è¡¨ SQL")

                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertMainSQL)) {
                        Success := true
                        LastIDResult := {}
                        if (SQLiteDB.GetTable("SELECT last_insert_rowid() AS newid;", LastIDResult) && LastIDResult.RowCount > 0) {
                            FinalID := LastIDResult.Rows[1][1]
                            LocalG_last_insert_rowid := FinalID
                            AddDebugLog("[WriteData1014] INSERT ä¸»è¡¨æˆåŠŸï¼Œæ–° ID: " . FinalID)
                        } else {
                            AddDebugLog("[WriteData1014] è·å– last_insert_rowid å¤±è´¥")
                            FinalID := ""
                        }
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("[WriteData1014] INSERT ä¸»è¡¨å¤±è´¥: " . ErrorMsg)
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    if (InStr(ErrorMsg, "UNIQUE constraint failed: æ•°æ®æ”¶é›†.æ’åº")) {
                        ; æ’åºå€¼å†²çªï¼Œé‡æ–°è·å–
                        if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                            CurrentMax := MaxSortResult.Rows[1][1] + 0
                        } else {
                            CurrentMax := 0
                        }
                        NewSortValue := CurrentMax + 1
                        InsertMainSQL := RegExReplace(InsertMainSQL, "æ’åº, \d+", "æ’åº, " . NewSortValue)
                        Sleep, 50
                        RetryCount--
                        continue
                    }
                    break
                }

                if (!Success || FinalID = "" || FinalID <= 0) {
                    FailedCount++
                    AddDebugLog("[WriteData1014] INSERT ä¸»è¡¨æœ€ç»ˆå¤±è´¥æˆ– ID æ— æ•ˆ")
                    continue
                }

                InsertDataSQL := "INSERT INTO Data_æ•°æ®æ”¶é›† (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", 'CF_UNICODETEXT', '" . EscapedClipData . "');"
                RetryCount := 3
                Success := false

                AddDebugLog("[WriteData1014] æ’å…¥ Data_æ•°æ®æ”¶é›†ï¼ŒFinalID=" . FinalID . ", ooData é•¿åº¦: " . StrLen(EscapedClipData))

                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertDataSQL)) {
                        Success := true
                        AddDebugLog("[WriteData1014] æ’å…¥ Data æˆåŠŸ")
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("[WriteData1014] æ’å…¥ Data å¤±è´¥: " . ErrorMsg)
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    AddDebugLog("[WriteData1014] æ’å…¥ Data æœ€ç»ˆå¤±è´¥")
                    continue
                }
            }

            ; å±æ€§æ’å…¥
            Attributes := []
            Attributes.Push({Format: "æ˜Ÿçº§", Value: "0"})

            if (WindowDetail != "") {
                Attributes.Push({Format: "çª—å£è¯¦æƒ…", Value: WindowDetail})
            }

            if (Identifier != "") {
                Attributes.Push({Format: "æ ‡è¯†", Value: Identifier})
            }

            if (Format != "") {
                FormatParts := StrSplit(Format, ",")
                Loop, % FormatParts.Length() {
                    TypeValue := Trim(FormatParts[A_Index])
                    if (TypeValue != "" && TypeValue != "CF_UNICODETEXT") {
                        Attributes.Push({Format: "ç±»å‹", Value: TypeValue})
                    }
                }
            }

            if (Group != "") {
                Attributes.Push({Format: "åˆ†ç»„", Value: Group})
            }

            if (AppName != "" && AppName != "æœªçŸ¥åº”ç”¨") {
                Attributes.Push({Format: "åº”ç”¨åç§°", Value: AppName})
                Tags := []
                if (RegExMatch(AppName, "^(.+?)\s*-\s*(.+)$", Match)) {
                    FirstPart := Trim(Match1)
                    SecondPart := Trim(Match2)
                    if (!RegExMatch(FirstPart, "\.[a-zA-Z0-9]{1,4}$")) {
                        Tags.Push(FirstPart)
                    }
                    if (SecondPart = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(SecondPart)
                    }
                } else {
                    if (AppName = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(AppName)
                    }
                }
                for idx, TagItem in Tags {
                    if (TagItem != "" && TagItem != "æœªçŸ¥åº”ç”¨") {
                        Attributes.Push({Format: "å…³é”®å­—", Value: TagItem})
                    }
                }
            }

            AddDebugLog("[WriteData1014] å‡†å¤‡æ’å…¥ " . Attributes.Length() . " ä¸ªå±æ€§")

            LocalAttrErrors := 0
            for idx, attr in Attributes {
                Result := InsertAttribute("æ•°æ®æ”¶é›†", FinalID, attr.Format, attr.Value)
                ErrorMsg := Result.ErrorMsg
                if (!Result.Success && ErrorMsg != "æ˜Ÿçº§ä¸º 0ï¼Œè·³è¿‡æ’å…¥" && ErrorMsg != "å±æ€§æ ¼å¼æˆ–å€¼ä¸ºç©ºï¼Œè·³è¿‡") {
                    LocalAttrErrors++
                    AddDebugLog("[WriteData1014] å±æ€§æ’å…¥å¤±è´¥: " . attr.Format . " = " . attr.Value . ", é”™è¯¯: " . ErrorMsg)
                    continue
                } else {
                    AddDebugLog("[WriteData1014] å±æ€§æ’å…¥æˆåŠŸ: " . attr.Format . " = " . SubStr(attr.Value, 1, 50))
                }
            }
            if (LocalAttrErrors > 0) {
                AddDebugLog("[WriteData1014] å±æ€§æ’å…¥è­¦å‘Š: " . LocalAttrErrors . " ä¸ªå¤±è´¥ for ID " . FinalID)
            }

            AttrCount := VerifyAllAttributes(FinalID, "æ•°æ®æ”¶é›†")
            if (AttrCount < 0) {
                AddDebugLog("[WriteData1014] å±æ€§éªŒè¯å¤±è´¥ for ID " . FinalID)
            } else {
                AddDebugLog("[WriteData1014] å±æ€§éªŒè¯é€šè¿‡ï¼Œå…± " . AttrCount . " ä¸ªå±æ€§")
            }

            if (LocalG_last_insert_rowid != "") {
                G_last_insert_rowid := LocalG_last_insert_rowid
            }

            InsertedCount++
            AddDebugLog("[WriteData1014] æˆåŠŸå¤„ç†è¡Œ " . index . "ï¼ŒID: " . FinalID)
        }

        if (!CommitSafeTransaction("WriteData1014-Batch")) {
            RollbackSafeTransaction("WriteData1014-Batch")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4338280 æ‰¹é‡äº‹åŠ¡æäº¤å¤±è´¥ï¼æˆåŠŸ %InsertedCount% æ¡ï¼Œå¤±è´¥ %FailedCount% æ¡
            Return
        }

        AddDebugLog("[WriteData1014] äº‹åŠ¡æäº¤æˆåŠŸ")

        DeleteRecordSQL := "DELETE FROM åˆ†ç±»å­—å…¸_One WHERE Category_Main = 'æœ€åæ’å…¥ID';"
        if (!SQLiteDB.Exec(DeleteRecordSQL)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š6839150 åˆ é™¤åˆ†ç±»å­—å…¸_Oneå¤±è´¥: %ErrorMsg%
            Return
        }

        InsertRecordSQL := "INSERT OR REPLACE INTO åˆ†ç±»å­—å…¸_One (Category_Main, Category_Sub, Record_Value) VALUES ('æœ€åæ’å…¥ID', '', " . (FinalID ? FinalID : "NULL") . ");"
        if (!SQLiteDB.Exec(InsertRecordSQL)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5307196 æ’å…¥åˆ†ç±»å­—å…¸_Oneå¤±è´¥: %ErrorMsg%
            Return
        }

        SB_SetText("WriteData1014: æ‰¹é‡æ’å…¥å®Œæˆï¼ŒæˆåŠŸ " . InsertedCount . " æ¡" . (FailedCount > 0 ? "ï¼Œå¤±è´¥ " . FailedCount . " æ¡" : ""))
        AddDebugLog("[WriteData1014] æ‰¹é‡å®Œæˆ: æˆåŠŸ " . InsertedCount . "ï¼Œå¤±è´¥ " . FailedCount)
    } catch e {
        eMessage := e.Message
        RollbackSafeTransaction("WriteData1014-Batch")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4851383 WriteData1014 å¼‚å¸¸: %eMessage%
        AddDebugLog("[WriteData1014] å¼‚å¸¸: " . eMessage)
        SB_SetText("WriteData1014: æ‰¹é‡å¼‚å¸¸ï¼Œå¤±è´¥ " . FailedCount . " æ¡")
    } finally {
        g_CurrentRecord.ID := G_last_insert_rowid
        g_CurrentRecord.TableName := "æ•°æ®æ”¶é›†"

        RetryPersist := 2
        while (RetryPersist > 0) {
            try {
                SQL := "INSERT OR REPLACE INTO åˆ†ç±»å­—å…¸_One (Category_Main, Category_Sub, Record_Value) VALUES ('CurrentRecord', '', " . (FinalID ? FinalID : "NULL") . ");"
                if (SQLiteDB.Exec(SQL)) {
                    break
                }
            } catch e {
                ErrorMsg := e.Message
            }
            Sleep, 50
            RetryPersist--
        }

        SB_SetText("WriteData1014: å¡«å……ç¼“å­˜ ID=" . SubStr(FinalID, 1, 8) . "..." . (InsertedCount > 0 ? " (æˆåŠŸ " . InsertedCount . ")" : ""))

        ProcessingContext := ""
        if (ClipboardLock = 1) {
            ClipboardLock := 0
            PostMessage, 0x0400 + 1, 0, 0, , ahk_class AutoHotkey
        }
        LoadData()
        GetGlobalMaxSortValue()  ; â­ ä»»åŠ¡ç»“æŸæ—¶æ›´æ–°å…¨å±€æœ€å¤§æ’åºå€¼
        SaveDataTip()
        SetTimer, WatchDatabaseDir, 3000
    }

    AddDebugLog("[WriteData1014] ç»“æŸ")
}

WriteData1015() {
    Global SQLiteDB, DBPath, ClipboardLock, ProcessingContext, g_CurrentRecord, ContentCache, G_last_insert_rowid
    ClipboardLock := 1
    ProcessingContext := "WriteData1015"

    WinGetTitle, WindowTitle, A
    if (RegExMatch(WindowTitle, "(.+?)\s*-\s*(.+)$", Match)) {
        AppName := Trim(Match2)
    } else {
        AppName := WindowTitle ? WindowTitle : "æœªçŸ¥åº”ç”¨"
    }
    WindowDetail := WindowTitle ? WindowTitle : ""
    Group := ""
    DataType := 1
    Identifier := ""
    Format := "CF_UNICODETEXT,æ–‡æœ¬"

    FinalID := ""
    InsertedCount := 0
    FailedCount := 0
    try {
        if (!CheckDBUnlocked(DBPath)) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š274754 æ•°æ®åº“è¢«å ç”¨ï¼Œè¯·ç¨åå†è¯•
            Return
        }

        if (!SQLiteDB) {
            SQLiteDB := New SQLiteDB()
            if (!SQLiteDB.OpenDB(DBPath)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š882623 æ•°æ®åº“æ‰“å¼€å¤±è´¥: %ErrorMsg%
                Return
            }
        }

        CheckSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ•°æ®æ”¶é›†';"
        CheckResult := {}
        if (!SQLiteDB.GetTable(CheckSQL, CheckResult) || CheckResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š972832 æ•°æ®æ”¶é›†è¡¨ä¸å­˜åœ¨ï¼
            Return
        }
        CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ•°æ®æ”¶é›†_å…³è”å±æ€§';"
        PropTableResult := {}
        if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5407851 æ•°æ®æ”¶é›†_å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            Return
        }
        CheckAssocTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='å…³è”å±æ€§è¡¨';"
        AssocTableResult := {}
        if (!SQLiteDB.GetTable(CheckAssocTableSQL, AssocTableResult) || AssocTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š6676530 å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            Return
        }

        GetColumnsSQL := "PRAGMA table_info(æ•°æ®æ”¶é›†);"
        ColumnsResult := {}
        RequiredFields := ["å¤‡æ³¨", "å†…å®¹", "ç½®é¡¶", "ç½®é¡¶ç´¢å¼•", "æ”¶è—", "ç¦åˆ ", "æ˜Ÿçº§", "æ ‡ç­¾", "åˆ†ç»„", "ç±»å‹", "åˆ›å»ºæ—¶é—´", "ä¿®æ”¹æ—¶é—´", "è®¿é—®æ—¶é—´", "è®¿é—®æ¬¡æ•°", "æ›´æ–°æ¬¡æ•°", "å­—èŠ‚", "å­—ç¬¦", "è¡Œæ•°", "æ•°é‡", "æ ‡è¯†", "çª—å£è¯¦æƒ…", "åº”ç”¨åç§°", "å“ˆå¸Œå€¼", "æ’åº", "æ ‡è®°çŠ¶æ€"]
        MissingFields := []
        if (SQLiteDB.GetTable(GetColumnsSQL, ColumnsResult)) {
            ExistingColumns := []
            Loop, % ColumnsResult.RowCount {
                ExistingColumns.Insert(ColumnsResult.Rows[A_Index][2])
            }
            for index, field in RequiredFields {
                if (!ArrayContains(ExistingColumns, field)) {
                    MissingFields.Insert(field)
                }
            }
            if (MissingFields.MaxIndex() > 0) {
                MissingFieldsList := Join(MissingFields, ", ")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5145204 æ•°æ®æ”¶é›†è¡¨ç¼ºå°‘å¿…è¦å­—æ®µï¼š%MissingFieldsList%
                Return
            }
        } else {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5209176 æŸ¥è¯¢è¡¨ç»“æ„å¤±è´¥: %ErrorMsg%
            Return
        }

        Sleep, 100

        if (!BeginSafeTransaction("WriteData1015-Batch")) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1933330 å¼€å§‹æ‰¹é‡äº‹åŠ¡å¤±è´¥ï¼
            Return
        }

        for index, ClipData in ContentCache {
            ClipData := RegExReplace(ClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", "")
            ClipData := Trim(ClipData)
            if (ClipData = "" || StrLen(ClipData) > 5000000) {
                FailedCount++
                continue
            }

            chineseText := ""
            nonChineseText := ""
            hasThai := false
            Tag := ""
            Loop, Parse, ClipData
            {
                char := A_LoopField
                if (IsChinese(char) || RegExMatch(char, "\d") || RegExMatch(char, "\p{P}"))
                    chineseText .= char
                else
                    nonChineseText .= char
                if (IsThai(char))
                    hasThai := true
            }

            Remark := chineseText != "" ? chineseText : SubStr(nonChineseText, 1, 1000)
            Remark := RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ")
            Content := nonChineseText

            if (hasThai) {
                Tag := "æ³°æ–‡"
            }

            ByteCount := StrPut(Content, "UTF-8") - 1
            Bytes := ""
            if (ByteCount > 0) {
                if (ByteCount < 1024)
                    Bytes := ByteCount . " B"
                else if (ByteCount < 1024 * 1024)
                    Bytes := Round(ByteCount / 1024,2) . " KB"
                else if (ByteCount < 1024 * 1024 * 1024)
                    Bytes := Round(ByteCount / (1024 * 1024),2) . " MB"
                else
                    Bytes := Round(ByteCount / (1024 * 1024 * 1024),2) . " GB"
            }

            try {
                HashValue := Crypt.Hash.Str(nonChineseText, "SHA256")
            } catch e {
                eMessage := e.Message
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š968710 è®¡ç®—å“ˆå¸Œå€¼å¤±è´¥: %eMessage%
                FailedCount++
                continue
            }

            ; === ä½¿ç”¨åˆ†ç±»å­—å…¸_Oneè¡¨ç»´æŠ¤æ’åºæœ€å¤§å€¼ï¼ˆå¸¦å”¯ä¸€æ€§å¤„ç†ï¼‰===
            GetMaxSortSQL := "SELECT COALESCE(""Record_Value"", 0) FROM ""åˆ†ç±»å­—å…¸_One"" WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' LIMIT 1;"
            MaxSortResult := {}
            CurrentMax := 0
            if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                CurrentMax := MaxSortResult.Rows[1][1] + 0 ; å¼ºåˆ¶è½¬ä¸ºæ•°å­—
            } else {
                ; åˆå§‹åŒ–
                InitSQL := "INSERT OR IGNORE INTO ""åˆ†ç±»å­—å…¸_One"" (""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('æ’åºå€¼', 'æœ€å¤§å€¼', '0', 0, datetime('now','localtime'));"
                if (!SQLiteDB.Exec(InitSQL)) {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼šæ–°ID-æ’åºåˆå§‹åŒ–å¤±è´¥: %ErrorMsg%
                    FailedCount++
                    continue
                }
                CurrentMax := 0
            }
            ; å¾ªç¯è·å–å”¯ä¸€æ’åºå€¼
            Loop {
                NewSortValue := CurrentMax + 1
                ; å°è¯•æ›´æ–°æœ€å¤§å€¼
                UpdateMaxSQL := "UPDATE ""åˆ†ç±»å­—å…¸_One"" SET ""Record_Value"" = ?, ""Update_Time"" = datetime('now','localtime') "
                              . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' AND ""Record_Value"" = ?;"
                Success := false
                RetryCount := 3
                while (RetryCount > 0) {
                    if (SQLiteDB.ExecuteWithParams) {
                        if (SQLiteDB.ExecuteWithParams(UpdateMaxSQL, [NewSortValue, CurrentMax])) {
                            Success := true
                            break
                        }
                    } else {
                        FallbackSQL := "UPDATE ""åˆ†ç±»å­—å…¸_One"" SET ""Record_Value"" = '" . NewSortValue . "', ""Update_Time"" = datetime('now','localtime') "
                                     . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' AND ""Record_Value"" = '" . CurrentMax . "';"
                        if (SQLiteDB.Exec(FallbackSQL)) {
                            Success := true
                            break
                        }
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 50
                        RetryCount--
                        continue
                    }
                    ; æ–°å¢ï¼šæ£€æŸ¥å”¯ä¸€çº¦æŸå¤±è´¥
                    if (InStr(ErrorMsg, "UNIQUE constraint failed")) {
                        ; é‡æ–°è¯»å–ï¼ˆä½¿ç”¨ä¿®å¤åçš„ SQLï¼‰
                        if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                            CurrentMax := MaxSortResult.Rows[1][1] + 0
                        } else {
                            CurrentMax := 0
                        }
                        break ; é€€å‡º whileï¼Œé‡è¯•å¤–å±‚ Loop
                    }
                    break
                }
                if (Success) {
                    ; æ›´æ–°æˆåŠŸï¼Œè¯´æ˜ NewSortValue å¯ç”¨
                    break
                } else {
                    ; æ›´æ–°å¤±è´¥ï¼Œè¯´æ˜æœ‰å¹¶å‘ï¼Œé‡æ–°è¯»å–å½“å‰æœ€å¤§å€¼
                    if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                        CurrentMax := MaxSortResult.Rows[1][1] + 0
                    } else {
                        CurrentMax := 0
                    }
                }
            }

            ExistingID := ""
            CheckSQL := "SELECT ID FROM æ•°æ®æ”¶é›† WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
            CheckResult := {}
            if (SQLiteDB.GetTable(CheckSQL, CheckResult, [HashValue]) && CheckResult.RowCount >= 1) {
                ExistingID := CheckResult.Rows[1][1]
            }

            if (StrLen(Content) > 1000000) {
                Content := SubStr(Content, 1, 1000000)
            }
            if (StrLen(Remark) > 1000) {
                Remark := SubStr(Remark, 1, 1000)
            }
            HashValue := HashValue ? HashValue : ""
            Bytes := Bytes ? Bytes : ""
            WindowDetail := WindowDetail ? WindowDetail : ""
            Identifier := Identifier ? Identifier : ""
            Format := Format ? Format : ""
            NewSortValue := NewSortValue ? NewSortValue : 1
            Remark := Remark ? RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            Content := Content ? RegExReplace(Content, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            Group := Group ? RegExReplace(Group, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            AppName := AppName ? RegExReplace(AppName, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : "æœªçŸ¥åº”ç”¨"

            EscapedHashValue := StrReplace(HashValue, "'", "''")
            EscapedBytes := StrReplace(Bytes, "'", "''")
            EscapedWindowDetail := StrReplace(WindowDetail, "'", "''")
            EscapedIdentifier := StrReplace(Identifier, "'", "''")
            EscapedRemark := StrReplace(Remark, "'", "''")
            EscapedContent := StrReplace(Content, "'", "''")
            EscapedGroup := StrReplace(Group, "'", "''")
            EscapedAppName := StrReplace(AppName, "'", "''")
            EscapedClipData := StrReplace(nonChineseText, "'", "''")

            Success := false
            RetryCount := 3
            LocalG_last_insert_rowid := ""

            ; ========== å…³é”®ä¿®æ”¹ï¼šä¸å†æŠŠ Format å†™å…¥ä¸»è¡¨ç±»å‹å­—æ®µ ==========
            if (ExistingID != "") {
                UpdateSQL := "UPDATE æ•°æ®æ”¶é›† SET æ’åº = " . NewSortValue . ", æ›´æ–°æ¬¡æ•° = COALESCE(æ›´æ–°æ¬¡æ•°, 0) + 1, ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime'), è®¿é—®æ—¶é—´ = datetime('now', 'localtime'), å¤‡æ³¨ = '" . EscapedRemark . "', å†…å®¹ = '" . EscapedContent . "', å­—èŠ‚ = '" . EscapedBytes . "', çª—å£è¯¦æƒ… = '', æ ‡è¯† = '', ç±»å‹ = '', åˆ†ç»„ = '" . EscapedGroup . "', åº”ç”¨åç§° = '" . EscapedAppName . "', ç¦åˆ  = 1 WHERE ID = " . ExistingID . ";"
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(UpdateSQL)) {
                        Success := true
                        FinalID := ExistingID
                        LocalG_last_insert_rowid := ExistingID
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }

                DeleteDataSQL := "DELETE FROM Data_æ•°æ®æ”¶é›† WHERE lParentID = " . FinalID . ";"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(DeleteDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }

                InsertDataSQL := "INSERT INTO Data_æ•°æ®æ”¶é›† (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", 'CF_UNICODETEXT', '" . EscapedClipData . "');"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }
            } else {
                InsertMainSQL := "INSERT INTO æ•°æ®æ”¶é›† (å“ˆå¸Œå€¼, å­—èŠ‚, çª—å£è¯¦æƒ…, æ ‡è¯†, ç±»å‹, æ’åº, æ›´æ–°æ¬¡æ•°, åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´, è®¿é—®æ—¶é—´, å¤‡æ³¨, å†…å®¹, åˆ†ç»„, åº”ç”¨åç§°, ç¦åˆ ) VALUES ('" . EscapedHashValue . "', '" . EscapedBytes . "', '', '', '', " . NewSortValue . ", 0, datetime('now', 'localtime'), datetime('now', 'localtime'), datetime('now', 'localtime'), '" . EscapedRemark . "', '" . EscapedContent . "', '" . EscapedGroup . "', '" . EscapedAppName . "', 1);"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertMainSQL)) {
                        Success := true
                        FinalID := SQLiteDB.LastInsertRowID
                        LocalG_last_insert_rowid := FinalID
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "UNIQUE constraint failed: æ•°æ®æ”¶é›†.æ’åº")) {
                        if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                            CurrentMax := MaxSortResult.Rows[1][1] + 0
                        } else {
                            CurrentMax := 0
                        }
                        NewSortValue := CurrentMax + 1
                        InsertMainSQL := RegExReplace(InsertMainSQL, "æ’åº = \d+", "æ’åº = " . NewSortValue)
                        Sleep, 50
                        RetryCount--
                        continue
                    }
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }

                InsertDataSQL := "INSERT INTO Data_æ•°æ®æ”¶é›† (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", 'CF_UNICODETEXT', '" . EscapedClipData . "');"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }
            }

            ; ========== å±æ€§æ’å…¥ï¼šå¤„ç† Format â†’ åªä¿ç•™ç”¨æˆ·å¯è¯»éƒ¨åˆ†ä½œä¸ºâ€œç±»å‹â€ ==========
            Attributes := []
            Attributes.Push({Format: "æ˜Ÿçº§", Value: "0"})
            if (Tag != "") {
                Attributes.Push({Format: "æ ‡ç­¾", Value: Tag})
            }
            if (Group != "") {
                Attributes.Push({Format: "åˆ†ç»„", Value: Group})
            }
            if (AppName != "" && AppName != "æœªçŸ¥åº”ç”¨") {
                Attributes.Push({Format: "åº”ç”¨åç§°", Value: AppName})
                Tags := []
                if (RegExMatch(AppName, "^(.+?)\s*-\s*(.+)$", Match)) {
                    FirstPart := Trim(Match1)
                    SecondPart := Trim(Match2)
                    if (!RegExMatch(FirstPart, "\.[a-zA-Z0-9]{1,4}$")) {
                        Tags.Push(FirstPart)
                    }
                    if (SecondPart = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(SecondPart)
                    }
                } else {
                    if (AppName = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(AppName)
                    }
                }
                for idx, t in Tags {
                    if (t != "" && t != "æœªçŸ¥åº”ç”¨") {
                        Attributes.Push({Format: "æ ‡ç­¾", Value: t})
                    }
                }
            }
            if (Identifier != "") {
                Attributes.Push({Format: "æ ‡è¯†", Value: Identifier})
            }

            ; **å…³é”®ä¿®æ”¹**ï¼šå¤„ç† Format â†’ æ‹†åˆ†ï¼Œåªä¿ç•™é CF_ éƒ¨åˆ†ä½œä¸ºâ€œç±»å‹â€
            if (Format != "") {
                FormatParts := StrSplit(Format, ",")
                Loop, % FormatParts.Length() {
                    TypeValue := Trim(FormatParts[A_Index])
                    if (TypeValue != "" && SubStr(TypeValue, 1, 3) != "CF_") {
                        Attributes.Push({Format: "ç±»å‹", Value: TypeValue})
                    }
                }
            }

            LocalAttrErrors := 0
            for idx, attr in Attributes {
                Result := InsertAttribute("æ•°æ®æ”¶é›†", FinalID, attr.Format, attr.Value)
                ErrorMsg := Result.ErrorMsg
                if (!Result.Success && ErrorMsg != "æ˜Ÿçº§ä¸º 0ï¼Œè·³è¿‡æ’å…¥" && ErrorMsg != "å±æ€§æ ¼å¼æˆ–å€¼ä¸ºç©ºï¼Œè·³è¿‡") {
                    LocalAttrErrors++
                    continue
                }
            }

            AttrCount := VerifyAllAttributes(FinalID, "æ•°æ®æ”¶é›†")
            if (AttrCount < 0) {
                ;
            }

            if (LocalG_last_insert_rowid != "") {
                G_last_insert_rowid := LocalG_last_insert_rowid
            }

            InsertedCount++
        }

        if (!CommitSafeTransaction("WriteData1015-Batch")) {
            RollbackSafeTransaction("WriteData1015-Batch")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4341889 æ‰¹é‡äº‹åŠ¡æäº¤å¤±è´¥ï¼æˆåŠŸ %InsertedCount% æ¡ï¼Œå¤±è´¥ %FailedCount% æ¡
            Return
        }

        ; === ä¿å­˜æœ€åæ’å…¥IDï¼šCategory_Main = Category_Sub = 'æœ€åæ’å…¥ID' ===
        DeleteRecordSQL := "DELETE FROM ""åˆ†ç±»å­—å…¸_One"" WHERE ""Category_Main"" = 'æœ€åæ’å…¥ID' AND ""Category_Sub"" = 'æœ€åæ’å…¥ID';"
        SQLiteDB.Exec(DeleteRecordSQL)

        LastIDValue := (G_last_insert_rowid ? G_last_insert_rowid : "")
        InsertRecordSQL := "INSERT OR REPLACE INTO ""åˆ†ç±»å­—å…¸_One"" "
                         . "(""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('æœ€åæ’å…¥ID', 'æœ€åæ’å…¥ID', ?, 1, datetime('now','localtime'));"

        if (SQLiteDB.ExecuteWithParams) {
            SQLiteDB.ExecuteWithParams(InsertRecordSQL, [LastIDValue])
        } else {
            EscapedLastID := StrReplace(LastIDValue, "'", "''")
            FallbackSQL := "INSERT OR REPLACE INTO ""åˆ†ç±»å­—å…¸_One"" "
                         . "(""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('æœ€åæ’å…¥ID', 'æœ€åæ’å…¥ID', '" . EscapedLastID . "', 1, datetime('now','localtime'));"
            SQLiteDB.Exec(FallbackSQL)
        }

        SB_SetText("WriteData1015: æ‰¹é‡æ’å…¥å®Œæˆï¼ŒæˆåŠŸ " . InsertedCount . " æ¡" . (FailedCount > 0 ? "ï¼Œå¤±è´¥ " . FailedCount . " æ¡" : ""))
    } catch e {
        eMessage := e.Message
        RollbackSafeTransaction("WriteData1015-Batch")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4856558 WriteData1015 å¼‚å¸¸: %eMessage%
        SB_SetText("WriteData1015: æ‰¹é‡å¼‚å¸¸ï¼Œå¤±è´¥ " . FailedCount . " æ¡")
    } finally {
        g_CurrentRecord.ID := G_last_insert_rowid
        g_CurrentRecord.TableName := "æ•°æ®æ”¶é›†"

        SB_SetText("WriteData1015: å¡«å……ç¼“å­˜ ID=" . SubStr(FinalID, 1, 8) . "..." . (InsertedCount > 0 ? " (æˆåŠŸ " . InsertedCount . ")" : ""))

        ProcessingContext := ""
        if (ClipboardLock = 1) {
            ClipboardLock := 0
            PostMessage, 0x0400 + 1, 0, 0, , ahk_class AutoHotkey
        }
        LoadData()
        GetGlobalMaxSortValue()
        SaveDataTip()
        SetTimer, WatchDatabaseDir, 3000
    }
}

WriteData1016() {
    Global SQLiteDB, DBPath, ClipboardLock, ProcessingContext, g_CurrentRecord, ContentCache, G_last_insert_rowid
    AddDebugLog("[WriteData1016] å¼€å§‹")
    ClipboardLock := 1
    ProcessingContext := "WriteData1016"

    WinGetTitle, WindowTitle, A
    if (RegExMatch(WindowTitle, "(.+?)\s*-\s*(.+)$", Match)) {
        AppName := Trim(Match2)
    } else {
        AppName := WindowTitle ? WindowTitle : "æœªçŸ¥åº”ç”¨"
    }
    WindowDetail := WindowTitle ? WindowTitle : ""
    Group := "" ; æ— åˆ†ç»„
    DataType := 1 ; æ–‡æœ¬
    Identifier := "" ; Identifier := "ğŸ“„"
    Format := "CF_UNICODETEXT,æ–‡æœ¬"
    FinalID := "" ; ç”¨äºfinallyå’Œåˆ†ç±»å­—å…¸_Oneï¼ˆæœ€åä¸€ä¸ªIDï¼‰
    InsertedCount := 0
    FailedCount := 0
    try {
        if (!CheckDBUnlocked(DBPath)) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š912808 æ•°æ®åº“è¢«å ç”¨ï¼Œè¯·ç¨åå†è¯•
            AddDebugLog("[WriteData1016] æ•°æ®åº“è¢«å ç”¨")
            Return
        }
        if (!SQLiteDB) {
            SQLiteDB := New SQLiteDB()
            if (!SQLiteDB.OpenDB(DBPath)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š430657 æ•°æ®åº“æ‰“å¼€å¤±è´¥: %ErrorMsg%
                AddDebugLog("[WriteData1016] æ‰“å¼€æ•°æ®åº“å¤±è´¥: " . ErrorMsg)
                Return
            }
        }
        ; æ£€æŸ¥æ•°æ®æ”¶é›†è¡¨å’Œå…³è”è¡¨å­˜åœ¨ï¼ˆå‚è€ƒClipboardChangedï¼‰
        CheckSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ•°æ®æ”¶é›†';"
        CheckResult := {}
        if (!SQLiteDB.GetTable(CheckSQL, CheckResult) || CheckResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š850420 æ•°æ®æ”¶é›†è¡¨ä¸å­˜åœ¨ï¼
            AddDebugLog("[WriteData1016] æ•°æ®æ”¶é›†è¡¨ä¸å­˜åœ¨")
            Return
        }
        CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ•°æ®æ”¶é›†_å…³è”å±æ€§';"
        PropTableResult := {}
        if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5411518 æ•°æ®æ”¶é›†_å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            Return
        }
        CheckAssocTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='å…³è”å±æ€§è¡¨';"
        AssocTableResult := {}
        if (!SQLiteDB.GetTable(CheckAssocTableSQL, AssocTableResult) || AssocTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1929759 å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            Return
        }
        GetColumnsSQL := "PRAGMA table_info(æ•°æ®æ”¶é›†);"
        ColumnsResult := {}
        RequiredFields := ["å¤‡æ³¨", "å†…å®¹", "ç½®é¡¶", "ç½®é¡¶ç´¢å¼•", "æ”¶è—", "ç¦åˆ ", "æ˜Ÿçº§", "æ ‡ç­¾", "åˆ†ç»„", "ç±»å‹", "åˆ›å»ºæ—¶é—´", "ä¿®æ”¹æ—¶é—´", "è®¿é—®æ—¶é—´", "è®¿é—®æ¬¡æ•°", "æ›´æ–°æ¬¡æ•°", "å­—èŠ‚", "å­—ç¬¦", "è¡Œæ•°", "æ•°é‡", "æ ‡è¯†", "çª—å£è¯¦æƒ…", "åº”ç”¨åç§°", "å“ˆå¸Œå€¼", "æ’åº", "æ ‡è®°çŠ¶æ€"]
        MissingFields := []
        if (SQLiteDB.GetTable(GetColumnsSQL, ColumnsResult)) {
            ExistingColumns := []
            Loop, % ColumnsResult.RowCount {
                ExistingColumns.Insert(ColumnsResult.Rows[A_Index][2])
            }
            for index, field in RequiredFields {
                if (!ArrayContains(ExistingColumns, field)) {
                    MissingFields.Insert(field)
                }
            }
            if (MissingFields.MaxIndex() > 0) {
                MissingFieldsList := Join(MissingFields, ", ")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š9153746 æ•°æ®æ”¶é›†è¡¨ç¼ºå°‘å¿…è¦å­—æ®µï¼š%MissingFieldsList%
                Return
            }
        } else {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5158123 æŸ¥è¯¢è¡¨ç»“æ„å¤±è´¥: %ErrorMsg%
            Return
        }
        Sleep, 100 ; é˜²å¡é¡¿ï¼Œå‚è€ƒClipboardChanged
        if (!BeginSafeTransaction("WriteData1016-Batch")) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1936036 å¼€å§‹æ‰¹é‡äº‹åŠ¡å¤±è´¥ï¼
            Return
        }
        AddDebugLog("[WriteData1016] ContentCache æ€»è¡Œæ•°: " . ContentCache.MaxIndex())
        ; å¤„ç†ContentCacheä¸­çš„æ¯å¯¹å†…å®¹ï¼ˆå¶æ•°è¡Œåˆå¹¶å¤„ç†ï¼Œç»Ÿä¸€äº‹åŠ¡å†…ï¼‰
        total := ContentCache.MaxIndex()
        Loop, % total//2 {
            i := (A_Index-1)*2+1
            line1 := ContentCache[i]
            line2 := ContentCache[i+1]
            ClipData := line1 . line2

            AddDebugLog("[WriteData1016] å¤„ç†ç¬¬ " . A_Index . " å¯¹ï¼ˆè¡Œ" . i . "+" . (i+1) . "ï¼‰ï¼ŒåŸå§‹é•¿åº¦: " . StrLen(ClipData))

            ; æ¸…ç†å†…å®¹
            ClipData := RegExReplace(ClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", "")
            ClipData := Trim(ClipData)
            if (ClipData = "" || StrLen(ClipData) > 5000000) {
                FailedCount++
                AddDebugLog("[WriteData1016] ç¬¬ " . A_Index . " å¯¹è·³è¿‡: ç©ºå†…å®¹æˆ–è¶…é•¿")
                continue
            }
            ; åŒè¯­åˆ†ç¦»å¤„ç†
            chineseText := ""
            nonChineseText := ""
            hasThai := false
            Tag := ""
            Loop, Parse, ClipData
            {
                char := A_LoopField
                if (IsChinese(char) || RegExMatch(char, "\d") || RegExMatch(char, "\p{P}"))
                    chineseText .= char
                else
                    nonChineseText .= char
                if (IsThai(char))
                    hasThai := true
            }
            AddDebugLog("[WriteData1016] ä¸­æ–‡éƒ¨åˆ†é•¿åº¦: " . StrLen(chineseText) . ", éä¸­æ–‡éƒ¨åˆ†é•¿åº¦: " . StrLen(nonChineseText) . ", hasThai: " . hasThai)
            Remark := chineseText != "" ? chineseText : SubStr(nonChineseText, 1, 1000)
            Remark := RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ")
            Content := nonChineseText ; ä¿®æ”¹ï¼šå°†éä¸­æ–‡éƒ¨åˆ†ä¹Ÿæ’å…¥åˆ°ä¸»è¡¨å†…å®¹å­—æ®µ
            if (hasThai) {
                Tag := "æ³°æ–‡"
                AddDebugLog("[WriteData1016] æ£€æµ‹åˆ°æ³°æ–‡ï¼Œè®¾ç½® Tag = æ³°æ–‡")
            }
            ; è®¡ç®—å­—èŠ‚ (åŸºäº nonChineseText)
            ByteCount := StrPut(nonChineseText, "UTF-8") - 1
            Bytes := ""
            if (ByteCount > 0) {
                if (ByteCount < 1024)
                    Bytes := ByteCount . " B"
                else if (ByteCount < 1024 * 1024)
                    Bytes := Round(ByteCount / 1024,2) . " KB"
                else if (ByteCount < 1024 * 1024 * 1024)
                    Bytes := Round(ByteCount / (1024 * 1024),2) . " MB"
                else
                    Bytes := Round(ByteCount / (1024 * 1024 * 1024),2) . " GB"
            }
            try {
                HashValue := Crypt.Hash.Str(nonChineseText, "SHA256")
                AddDebugLog("[WriteData1016] å“ˆå¸Œå€¼: " . SubStr(HashValue, 1, 16) . "...")
            } catch e {
                eMessage := e.Message
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š688037 è®¡ç®—å“ˆå¸Œå€¼å¤±è´¥: %eMessage%
                AddDebugLog("[WriteData1016] è®¡ç®—å“ˆå¸Œå€¼å¤±è´¥: " . eMessage)
                FailedCount++
                continue
            }
            ; â­ ä¿®æ”¹ï¼šä½¿ç”¨åˆ†ç±»å­—å…¸_Oneè¡¨ç»´æŠ¤æ’åºæœ€å¤§å€¼ï¼ˆå¸¦å”¯ä¸€æ€§å¤„ç†ï¼‰
            GetMaxSortSQL := "SELECT COALESCE(""Record_Value"", 0) FROM ""åˆ†ç±»å­—å…¸_One"" WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' LIMIT 1;"
            MaxSortResult := {}
            CurrentMax := 0
            if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                CurrentMax := MaxSortResult.Rows[1][1] + 0 ; å¼ºåˆ¶è½¬ä¸ºæ•°å­—
            } else {
                ; åˆå§‹åŒ–
                InitSQL := "INSERT OR IGNORE INTO ""åˆ†ç±»å­—å…¸_One"" (""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('æ’åºå€¼', 'æœ€å¤§å€¼', '0', 0, datetime('now','localtime'));"
                if (!SQLiteDB.Exec(InitSQL)) {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("[WriteData1016] æ’åºåˆå§‹åŒ–å¤±è´¥: " . ErrorMsg)
                }
                CurrentMax := 0
            }
            ; å¾ªç¯è·å–å”¯ä¸€æ’åºå€¼
            Loop {
                NewSortValue := CurrentMax + 1
                ; å°è¯•æ›´æ–°æœ€å¤§å€¼
                UpdateMaxSQL := "UPDATE ""åˆ†ç±»å­—å…¸_One"" SET ""Record_Value"" = ?, ""Update_Time"" = datetime('now','localtime') "
                              . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' AND ""Record_Value"" = ?;"
                Success := false
                RetryCount := 3
                while (RetryCount > 0) {
                    if (SQLiteDB.ExecuteWithParams) {
                        if (SQLiteDB.ExecuteWithParams(UpdateMaxSQL, [NewSortValue, CurrentMax])) {
                            Success := true
                            break
                        }
                    } else {
                        FallbackSQL := "UPDATE ""åˆ†ç±»å­—å…¸_One"" SET ""Record_Value"" = '" . NewSortValue . "', ""Update_Time"" = datetime('now','localtime') "
                                     . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' AND ""Record_Value"" = '" . CurrentMax . "';"
                        if (SQLiteDB.Exec(FallbackSQL)) {
                            Success := true
                            break
                        }
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 50
                        RetryCount--
                        continue
                    }
                    ; æ–°å¢ï¼šæ£€æŸ¥å”¯ä¸€çº¦æŸå¤±è´¥
                    if (InStr(ErrorMsg, "UNIQUE constraint failed")) {
                        ; é‡æ–°è¯»å–ï¼ˆä½¿ç”¨ä¿®å¤åçš„ SQLï¼‰
                        if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                            CurrentMax := MaxSortResult.Rows[1][1] + 0
                        } else {
                            CurrentMax := 0
                        }
                        break ; é€€å‡º whileï¼Œé‡è¯•å¤–å±‚ Loop
                    }
                    break
                }
                if (Success) {
                    ; æ›´æ–°æˆåŠŸï¼Œè¯´æ˜ NewSortValue å¯ç”¨
                    break
                } else {
                    ; æ›´æ–°å¤±è´¥ï¼Œè¯´æ˜æœ‰å¹¶å‘ï¼Œé‡æ–°è¯»å–å½“å‰æœ€å¤§å€¼
                    if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                        CurrentMax := MaxSortResult.Rows[1][1] + 0
                    } else {
                        CurrentMax := 0
                    }
                }
            }
            AddDebugLog("[WriteData1016] æ–°æ’åºå€¼: " . NewSortValue)
            ExistingID := ""
            CheckSQL := "SELECT ID FROM æ•°æ®æ”¶é›† WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
            CheckResult := {}
            if (SQLiteDB.GetTable(CheckSQL, CheckResult, [HashValue]) && CheckResult.RowCount >= 1) {
                ExistingID := CheckResult.Rows[1][1]
                AddDebugLog("[WriteData1016] å‘ç°é‡å¤è®°å½• ID: " . ExistingID)
            } else {
                AddDebugLog("[WriteData1016] æœªå‘ç°é‡å¤ï¼Œå‡†å¤‡æ–°å¢")
            }
            if (StrLen(Content) > 1000000) {
                Content := SubStr(Content, 1, 1000000)
            }
            if (StrLen(Remark) > 1000) {
                Remark := SubStr(Remark, 1, 1000)
            }
            HashValue := HashValue ? HashValue : ""
            Bytes := Bytes ? Bytes : ""
            WindowDetail := WindowDetail ? WindowDetail : ""
            Identifier := Identifier ? Identifier : ""
            Format := Format ? Format : ""
            NewSortValue := NewSortValue ? NewSortValue : 1
            Remark := Remark ? RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            Content := Content ? RegExReplace(Content, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            Group := Group ? RegExReplace(Group, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            AppName := AppName ? RegExReplace(AppName, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : "æœªçŸ¥åº”ç”¨"
            EscapedHashValue := StrReplace(HashValue, "'", "''")
            EscapedBytes := StrReplace(Bytes, "'", "''")
            EscapedWindowDetail := StrReplace(WindowDetail, "'", "''")
            EscapedIdentifier := StrReplace(Identifier, "'", "''")
            EscapedFormat := StrReplace(Format, "'", "''")
            EscapedRemark := StrReplace(Remark, "'", "''")
            EscapedContent := StrReplace(Content, "'", "''")  ; â­ ç»Ÿä¸€ä½¿ç”¨ EscapedContent æ’å…¥ä¸»è¡¨å†…å®¹
            EscapedGroup := StrReplace(Group, "'", "''")
            EscapedAppName := StrReplace(AppName, "'", "''")
            EscapedClipData := StrReplace(nonChineseText, "'", "''")
            AddDebugLog("[WriteData1016] å‡†å¤‡æ’å…¥åˆ°ä¸»è¡¨å†…å®¹å­—æ®µçš„é•¿åº¦: " . StrLen(EscapedContent))
            AddDebugLog("[WriteData1016] å‡†å¤‡æ’å…¥åˆ° ooData çš„å†…å®¹é•¿åº¦: " . StrLen(EscapedClipData))
            Success := false
            RetryCount := 3
            LocalG_last_insert_rowid := ""

            if (ExistingID != "") {
                UpdateSQL := "UPDATE æ•°æ®æ”¶é›† SET æ’åº = " . NewSortValue . ", æ›´æ–°æ¬¡æ•° = COALESCE(æ›´æ–°æ¬¡æ•°, 0) + 1, ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime'), è®¿é—®æ—¶é—´ = datetime('now', 'localtime'), å¤‡æ³¨ = '" . EscapedRemark . "', å†…å®¹ = '" . EscapedContent . "', å­—èŠ‚ = '" . EscapedBytes . "', çª—å£è¯¦æƒ… = '', æ ‡è¯† = '', ç±»å‹ = '', åˆ†ç»„ = '', åº”ç”¨åç§° = '' WHERE ID = " . ExistingID . ";"

                AddDebugLog("[WriteData1016] æ‰§è¡Œ UPDATE ä¸»è¡¨ SQL")

                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(UpdateSQL)) {
                        Success := true
                        FinalID := ExistingID
                        LocalG_last_insert_rowid := ExistingID
                        AddDebugLog("[WriteData1016] UPDATE ä¸»è¡¨æˆåŠŸï¼ŒID: " . ExistingID)
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("[WriteData1016] UPDATE ä¸»è¡¨å¤±è´¥: " . ErrorMsg)
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    AddDebugLog("[WriteData1016] UPDATE ä¸»è¡¨æœ€ç»ˆå¤±è´¥")
                    continue
                }
                DeleteDataSQL := "DELETE FROM Data_æ•°æ®æ”¶é›† WHERE lParentID = " . FinalID . ";"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(DeleteDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }
                DeletePropSQL := "DELETE FROM æ•°æ®æ”¶é›†_å…³è”å±æ€§ WHERE ID = " . FinalID . ";"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(DeletePropSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }
                InsertDataSQL := "INSERT INTO Data_æ•°æ®æ”¶é›† (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", 'CF_UNICODETEXT', '" . EscapedClipData . "');"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }
            } else {
                InsertMainSQL := "INSERT INTO æ•°æ®æ”¶é›† (å“ˆå¸Œå€¼, å­—èŠ‚, çª—å£è¯¦æƒ…, æ ‡è¯†, ç±»å‹, æ’åº, æ›´æ–°æ¬¡æ•°, åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´, è®¿é—®æ—¶é—´, å¤‡æ³¨, å†…å®¹, åˆ†ç»„, åº”ç”¨åç§°, ç¦åˆ ) VALUES ('" . EscapedHashValue . "', '" . EscapedBytes . "', '', '', '', " . NewSortValue . ", 0, datetime('now', 'localtime'), datetime('now', 'localtime'), datetime('now', 'localtime'), '" . EscapedRemark . "', '" . EscapedContent . "', '', '', 1);"
                RetryCount := 3
                Success := false

                AddDebugLog("[WriteData1016] æ‰§è¡Œ INSERT ä¸»è¡¨ SQL")

                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertMainSQL)) {
                        Success := true
                        LastIDResult := {}
                        if (SQLiteDB.GetTable("SELECT last_insert_rowid() AS newid;", LastIDResult) && LastIDResult.RowCount > 0) {
                            FinalID := LastIDResult.Rows[1][1]
                            LocalG_last_insert_rowid := FinalID
                            AddDebugLog("[WriteData1016] INSERT ä¸»è¡¨æˆåŠŸï¼Œæ–° ID: " . FinalID)
                        } else {
                            AddDebugLog("[WriteData1016] è·å– last_insert_rowid å¤±è´¥")
                            FinalID := ""
                        }
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("[WriteData1016] INSERT ä¸»è¡¨å¤±è´¥: " . ErrorMsg)
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    if (InStr(ErrorMsg, "UNIQUE constraint failed: æ•°æ®æ”¶é›†.æ’åº")) {
                        ; æ’åºå€¼å†²çªï¼Œé‡æ–°è·å–
                        if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                            CurrentMax := MaxSortResult.Rows[1][1] + 0
                        } else {
                            CurrentMax := 0
                        }
                        NewSortValue := CurrentMax + 1
                        InsertMainSQL := RegExReplace(InsertMainSQL, "æ’åº = \d+", "æ’åº = " . NewSortValue)
                        Sleep, 50
                        RetryCount--
                        continue
                    }
                    break
                }

                if (!Success || FinalID = "" || FinalID <= 0) {
                    FailedCount++
                    AddDebugLog("[WriteData1016] INSERT ä¸»è¡¨æœ€ç»ˆå¤±è´¥æˆ– ID æ— æ•ˆ")
                    continue
                }
                InsertDataSQL := "INSERT INTO Data_æ•°æ®æ”¶é›† (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", 'CF_UNICODETEXT', '" . EscapedClipData . "');"
                RetryCount := 3
                Success := false

                AddDebugLog("[WriteData1016] æ’å…¥ Data_æ•°æ®æ”¶é›†ï¼ŒFinalID=" . FinalID . ", ooData é•¿åº¦: " . StrLen(EscapedClipData))

                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertDataSQL)) {
                        Success := true
                        AddDebugLog("[WriteData1016] æ’å…¥ Data æˆåŠŸ")
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("[WriteData1016] æ’å…¥ Data å¤±è´¥: " . ErrorMsg)
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    AddDebugLog("[WriteData1016] æ’å…¥ Data æœ€ç»ˆå¤±è´¥")
                    continue
                }
            }
            ; å±æ€§æ’å…¥ (åŠ Tagï¼Œå‚è€ƒClipboardChangedï¼Œç”¨DataID)
            Attributes := []
            Attributes.Push({Format: "æ˜Ÿçº§", Value: "0"})

            ; æ·»åŠ çª—å£è¯¦æƒ…
            if (WindowDetail != "") {
                Attributes.Push({Format: "çª—å£è¯¦æƒ…", Value: WindowDetail})
            }

            ; æ·»åŠ æ ‡è¯†
            if (Identifier != "") {
                Attributes.Push({Format: "æ ‡è¯†", Value: Identifier})
            }

            ; æ·»åŠ ç±»å‹ï¼ˆæ‹†åˆ†Formatå­—ç¬¦ä¸²ï¼‰
            if (Format != "") {
                FormatParts := StrSplit(Format, ",")
                Loop, % FormatParts.Length() {
                    TypeValue := Trim(FormatParts[A_Index])
                    if (TypeValue != "" && TypeValue != "CF_UNICODETEXT") { ; è¿‡æ»¤ç³»ç»Ÿå‰ç¼€
                        Attributes.Push({Format: "ç±»å‹", Value: TypeValue})
                    }
                }
            }

            ; æ·»åŠ åˆ†ç»„
            if (Group != "") {
                Attributes.Push({Format: "åˆ†ç»„", Value: Group})
            }

            ; æ·»åŠ åº”ç”¨åç§°ï¼ˆå¹¶æ‹†åˆ†æ ‡ç­¾ï¼‰
            if (AppName != "" && AppName != "æœªçŸ¥åº”ç”¨") {
                Attributes.Push({Format: "åº”ç”¨åç§°", Value: AppName})
                Tags := []
                if (RegExMatch(AppName, "^(.+?)\s*-\s*(.+)$", Match)) {
                    FirstPart := Trim(Match1)
                    SecondPart := Trim(Match2)
                    if (!RegExMatch(FirstPart, "\.[a-zA-Z0-9]{1,4}$")) {
                        Tags.Push(FirstPart)
                    }
                    if (SecondPart = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(SecondPart)
                    }
                } else {
                    if (AppName = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(AppName)
                    }
                }
                for idx, t in Tags {
                    if (t != "" && t != "æœªçŸ¥åº”ç”¨") {
                        Attributes.Push({Format: "å…³é”®å­—", Value: t})
                    }
                }
            }

            ; ç°æœ‰æ ‡ç­¾ï¼ˆå¦‚æ³°æ–‡ï¼‰
            if (Tag != "") {
                Attributes.Push({Format: "å…³é”®å­—", Value: Tag})
                AddDebugLog("[WriteData1016] æ·»åŠ æ³°æ–‡å…³é”®å­—: " . Tag)
            }
            AddDebugLog("[WriteData1016] å‡†å¤‡æ’å…¥ " . Attributes.Length() . " ä¸ªå±æ€§")
            LocalAttrErrors := 0
            for idx, attr in Attributes {
                Result := InsertAttribute("æ•°æ®æ”¶é›†", FinalID, attr.Format, attr.Value) ; æ·»åŠ  TableName å‚æ•°
                ErrorMsg := Result.ErrorMsg
                if (!Result.Success && ErrorMsg != "æ˜Ÿçº§ä¸º 0ï¼Œè·³è¿‡æ’å…¥" && ErrorMsg != "å±æ€§æ ¼å¼æˆ–å€¼ä¸ºç©ºï¼Œè·³è¿‡") {
                    LocalAttrErrors++
                    AddDebugLog("[WriteData1016] å±æ€§æ’å…¥å¤±è´¥: " . attr.Format . " = " . attr.Value . ", é”™è¯¯: " . ErrorMsg)
                    continue ; å•ä¸ªå±æ€§å¤±è´¥ä¸ä¸­æ–­æ•´ä½“
                } else {
                    AddDebugLog("[WriteData1016] å±æ€§æ’å…¥æˆåŠŸ: " . attr.Format . " = " . SubStr(attr.Value, 1, 50))
                }
            }
            if (LocalAttrErrors > 0) {
                AddDebugLog("[WriteData1016] å±æ€§æ’å…¥è­¦å‘Š: " . LocalAttrErrors . " ä¸ªå¤±è´¥ for ID " . FinalID)
            }
            ; éªŒè¯å±æ€§ï¼ˆç”¨IDï¼‰
            AttrCount := VerifyAllAttributes(FinalID, "æ•°æ®æ”¶é›†") ; è°ƒæ•´ä¸ºID + è¡¨å
            if (AttrCount < 0) {
                AddDebugLog("[WriteData1016] å±æ€§éªŒè¯å¤±è´¥ for ID " . FinalID)
            } else {
                AddDebugLog("[WriteData1016] å±æ€§éªŒè¯é€šè¿‡ï¼Œå…± " . AttrCount . " ä¸ªå±æ€§")
            }
            ; æ›´æ–°å…¨å±€IDï¼ˆå½“å‰è¡Œï¼‰
            if (LocalG_last_insert_rowid != "") {
                G_last_insert_rowid := LocalG_last_insert_rowid
            }
            InsertedCount++
            AddDebugLog("[WriteData1016] æˆåŠŸå¤„ç†å¯¹ " . A_Index . "ï¼ŒID: " . FinalID)
        }
        ; ç»Ÿä¸€æäº¤äº‹åŠ¡ï¼ˆå‚è€ƒTogglePinnedæ‰¹é‡ï¼‰
        if (!CommitSafeTransaction("WriteData1016-Batch")) {
            RollbackSafeTransaction("WriteData1016-Batch")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4344295 æ‰¹é‡äº‹åŠ¡æäº¤å¤±è´¥ï¼æˆåŠŸ %InsertedCount% æ¡ï¼Œå¤±è´¥ %FailedCount% æ¡
            Return
        }
        AddDebugLog("[WriteData1016] äº‹åŠ¡æäº¤æˆåŠŸ")
        ; åˆ†ç±»å­—å…¸_Oneï¼ˆæœ€åæ’å…¥IDä¸ºæœ€åä¸€ä¸ªFinalIDï¼‰
        DeleteRecordSQL := "DELETE FROM åˆ†ç±»å­—å…¸_One WHERE Category_Main = 'æœ€åæ’å…¥ID';"
        if (!SQLiteDB.Exec(DeleteRecordSQL)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š7291456 åˆ é™¤åˆ†ç±»å­—å…¸_Oneå¤±è´¥: %ErrorMsg%
            Return
        }
        InsertRecordSQL := "INSERT OR REPLACE INTO åˆ†ç±»å­—å…¸_One (Category_Main, Category_Sub, Record_Value) VALUES ('æœ€åæ’å…¥ID', '', " . (FinalID ? FinalID : "NULL") . ");"
        if (!SQLiteDB.Exec(InsertRecordSQL)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š8592666 æ’å…¥åˆ†ç±»å­—å…¸_Oneå¤±è´¥: %ErrorMsg%
            Return
        }
        SB_SetText("WriteData1016: æ‰¹é‡æ’å…¥å®Œæˆï¼ŒæˆåŠŸ " . InsertedCount . " æ¡" . (FailedCount > 0 ? "ï¼Œå¤±è´¥ " . FailedCount . " æ¡" : ""))
        AddDebugLog("[WriteData1016] æ‰¹é‡å®Œæˆ: æˆåŠŸ " . InsertedCount . "ï¼Œå¤±è´¥ " . FailedCount)
    } catch e {
        eMessage := e.Message
        RollbackSafeTransaction("WriteData1016-Batch")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4901779 WriteData1016 å¼‚å¸¸: %eMessage%
        AddDebugLog("[WriteData1016] å¼‚å¸¸: " . eMessage)
        SB_SetText("WriteData1016: æ‰¹é‡å¼‚å¸¸ï¼Œå¤±è´¥ " . FailedCount . " æ¡")
    } finally {
        ; ç¼“å­˜å½“å‰è®°å½•ï¼ˆæœ€åä¸€ä¸ªï¼‰
        g_CurrentRecord.ID := G_last_insert_rowid
        g_CurrentRecord.TableName := "æ•°æ®æ”¶é›†"
        ; æŒä¹…åŒ–CurrentRecordï¼ˆé‡è¯•ï¼Œå‚è€ƒClipboardChangedï¼Œç®€åŒ–ï¼‰
        RetryPersist := 2
        while (RetryPersist > 0) {
            try {
                SQL := "INSERT OR REPLACE INTO åˆ†ç±»å­—å…¸_One (Category_Main, Category_Sub, Record_Value) VALUES ('CurrentRecord', '', " . (FinalID ? FinalID : "NULL") . ");"
                if (SQLiteDB.Exec(SQL)) {
                    break
                }
            } catch e {
                ErrorMsg := e.Message
            }
            Sleep, 50
            RetryPersist--
        }
        SB_SetText("WriteData1016: å¡«å……ç¼“å­˜ ID=" . SubStr(FinalID, 1, 8) . "..." . (InsertedCount > 0 ? " (æˆåŠŸ " . InsertedCount . ")" : ""))
        ProcessingContext := ""
        if (ClipboardLock = 1) {
            ClipboardLock := 0
            PostMessage, 0x0400 + 1, 0, 0, , ahk_class AutoHotkey
        }
        LoadData()
        GetGlobalMaxSortValue()  ; â­ æ·»åŠ ï¼šä»»åŠ¡ç»“æŸæ—¶æ›´æ–°å…¨å±€æœ€å¤§æ’åºå€¼
        SaveDataTip()
        SetTimer, WatchDatabaseDir, 3000
    }

    AddDebugLog("[WriteData1016] ç»“æŸ")
}

;===================|===================

ä¸‹é¢æ˜¯å‚è€ƒä»£ç 
ClipboardChanged(type) {
    Global SQLiteDB, DBPath, IsCopying, ClipboardLock, ProcessingContext, TransactionActive, TransactionOwner, G_last_insert_rowid, G_last_insert_Main_ID, G_last_insert_Main_TableName
	; ğŸ”¥ æ·»åŠ è¿™ä¸ªæ£€æŸ¥ - ä»»ä½•éé›¶çš„ ClipboardLock éƒ½åº”è¯¥é˜»æ­¢æ‰§è¡Œ
    if (ClipboardLock != 0) {
        Return
    }
    SetTimer, WatchDatabaseDir, Off

    WinGet, ActiveID, ID, A
    WinGetTitle, WindowTitle, ahk_id %ActiveID%
    if (InStr(WindowTitle, "å°è±¡è®°å¿†_5")) {
        Return
    }
    if (type != 1 && type != 2) {
        Return
    }
    ClipboardLock := 3
    ProcessingContext := "Clipboard"
    FinalID := ""
    try {
        if (!CheckDBUnlocked(DBPath)) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4100220 ; æ•°æ®åº“è¢«é”å®šï¼
            LoadData()
            Return
        }
        if (!SQLiteDB) {
            SQLiteDB := New SQLiteDB()
            if (!SQLiteDB.OpenDB(DBPath)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4103692 æ•°æ®åº“æ‰“å¼€å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
        }
        MainTable := "å†å²æ•°æ®"
        OldMainTable := MainTable . "_temp_old"
        DataTable := "Data_" . MainTable
        OldDataTable := DataTable . "_temp_old"
        PropTable := MainTable . "_å…³è”å±æ€§"
        OldPropTable := PropTable . "_temp_old"
        SQLiteDB.Exec("PRAGMA foreign_keys = OFF;")
        CheckMainSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . MainTable . "';"
        MainResult := {}
        if (SQLiteDB.GetTable(CheckMainSQL, MainResult) && MainResult.RowCount = 0) {
            CheckOldMainSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldMainTable . "';"
            OldMainResult := {}
            if (SQLiteDB.GetTable(CheckOldMainSQL, OldMainResult) && OldMainResult.RowCount > 0) {
                RenameMainSQL := "ALTER TABLE [" . OldMainTable . "] RENAME TO [" . MainTable . "];"
                if (SQLiteDB.Exec(RenameMainSQL)) {
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4111311 æ— æ³•æ¢å¤ä¸»è¡¨: %ErrorMsg%
                    SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
                    LoadData()
                    Return
                }
            } else {
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4113412 ä¸»è¡¨ç¼ºå¤±ä¸”æ— å¤‡ä»½ï¼
                SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
                LoadData()
                Return
            }
        } else {
            CheckOldMainSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldMainTable . "';"
            OldMainResult := {}
            if (SQLiteDB.GetTable(CheckOldMainSQL, OldMainResult) && OldMainResult.RowCount > 0) {
                if (SQLiteDB.Exec("DROP TABLE [" . OldMainTable . "];")) {
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                }
            }
        }
        CheckDataSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . DataTable . "';"
        DataResult := {}
        if (SQLiteDB.GetTable(CheckDataSQL, DataResult) && DataResult.RowCount = 0) {
            CheckOldDataSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldDataTable . "';"
            OldDataResult := {}
            if (SQLiteDB.GetTable(CheckOldDataSQL, OldDataResult) && OldDataResult.RowCount > 0) {
                RenameDataSQL := "ALTER TABLE [" . OldDataTable . "] RENAME TO [" . DataTable . "];"
                if (SQLiteDB.Exec(RenameDataSQL)) {
                    AlterDataSQL := "ALTER TABLE [" . DataTable . "] ADD FOREIGN KEY(lParentID) REFERENCES [" . MainTable . "](ID);"
                    SQLiteDB.Exec(AlterDataSQL)
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4119130 æ— æ³•æ¢å¤æ•°æ®è¡¨: %ErrorMsg%
                    SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
                    LoadData()
                    Return
                }
            }
        } else {
            CheckOldDataSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldDataTable . "';"
            OldDataResult := {}
            if (SQLiteDB.GetTable(CheckOldDataSQL, OldDataResult) && OldDataResult.RowCount > 0) {
                if (SQLiteDB.Exec("DROP TABLE [" . OldDataTable . "];")) {
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                }
            }
        }
        CheckPropSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . PropTable . "';"
        PropResult := {}
        if (SQLiteDB.GetTable(CheckPropSQL, PropResult) && PropResult.RowCount = 0) {
            CheckOldPropSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldPropTable . "';"
            OldPropResult := {}
            if (SQLiteDB.GetTable(CheckOldPropSQL, OldPropResult) && OldPropResult.RowCount > 0) {
                RenamePropSQL := "ALTER TABLE [" . OldPropTable . "] RENAME TO [" . PropTable . "];"
                if (SQLiteDB.Exec(RenamePropSQL)) {
                    AlterPropFK1SQL := "ALTER TABLE [" . PropTable . "] ADD FOREIGN KEY(å±æ€§ID) REFERENCES å…³è”å±æ€§è¡¨(ID);"
                    AlterPropFK2SQL := "ALTER TABLE [" . PropTable . "] ADD FOREIGN KEY(ID) REFERENCES [" . MainTable . "](ID) ON DELETE CASCADE;"
                    SQLiteDB.Exec(AlterPropFK1SQL)
                    SQLiteDB.Exec(AlterPropFK2SQL)
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4127581 æ— æ³•æ¢å¤å±æ€§è¡¨: %ErrorMsg%
                    SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
                    LoadData()
                    Return
                }
            }
        } else {
            CheckOldPropSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='" . OldPropTable . "';"
            OldPropResult := {}
            if (SQLiteDB.GetTable(CheckOldPropSQL, OldPropResult) && OldPropResult.RowCount > 0) {
                if (SQLiteDB.Exec("DROP TABLE [" . OldPropTable . "];")) {
                } else {
                    ErrorMsg := SQLiteDB._ErrMsg()
                }
            }
        }
        SQLiteDB.Exec("PRAGMA foreign_keys = ON;")
        CheckAssocTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='å…³è”å±æ€§è¡¨';"
        CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='å†å²æ•°æ®_å…³è”å±æ€§';"
        CheckMainTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='å†å²æ•°æ®';"
        AssocTableResult := {}
        PropTableResult := {}
        MainTableResult := {}
        if (!SQLiteDB.GetTable(CheckAssocTableSQL, AssocTableResult) || AssocTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4133064 å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            LoadData()
            Return
        }
        if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4135569 å†å²æ•°æ®_å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            LoadData()
            Return
        }
        if (!SQLiteDB.GetTable(CheckMainTableSQL, MainTableResult) || MainTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4140580 å†å²æ•°æ®è¡¨ä¸å­˜åœ¨ï¼
            LoadData()
            Return
        }
        GetColumnsSQL := "PRAGMA table_info(å†å²æ•°æ®);"
        ColumnsResult := {}
        RequiredFields := ["å¤‡æ³¨", "å†…å®¹", "ç½®é¡¶", "ç½®é¡¶ç´¢å¼•", "æ”¶è—", "ç¦åˆ ", "æ˜Ÿçº§", "æ ‡ç­¾", "åˆ†ç»„", "ç±»å‹", "åˆ›å»ºæ—¶é—´", "ä¿®æ”¹æ—¶é—´", "è®¿é—®æ—¶é—´", "è®¿é—®æ¬¡æ•°", "æ›´æ–°æ¬¡æ•°", "å­—èŠ‚", "å­—ç¬¦", "è¡Œæ•°", "æ•°é‡", "æ ‡è¯†", "çª—å£è¯¦æƒ…", "åº”ç”¨åç§°", "å“ˆå¸Œå€¼", "æ’åº", "æ ‡è®°çŠ¶æ€"]
        MissingFields := []
        if (SQLiteDB.GetTable(GetColumnsSQL, ColumnsResult)) {
            ExistingColumns := []
            Loop, % ColumnsResult.RowCount {
                ExistingColumns.Insert(ColumnsResult.Rows[A_Index][2])
            }
            for index, field in RequiredFields {
                if (!ArrayContains(ExistingColumns, field)) {
                    MissingFields.Insert(field)
                }
            }
            if (MissingFields.MaxIndex() > 0) {
                MissingFieldsList := Join(MissingFields, ", ")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4146625 å†å²æ•°æ®è¡¨ç¼ºå°‘å¿…è¦å­—æ®µï¼š%MissingFieldsList%
                LoadData()
                Return
            }
        } else {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4149159 æŸ¥è¯¢è¡¨ç»“æ„å¤±è´¥: %ErrorMsg%
            LoadData()
            Return
        }
        Sleep, 100
        ClipData := ""
        Format := ""
        DataType := 1
        Identifier := ""
        FileCount := 0
        ValidCount := 0
        TotalSize := 0
        Bytes := ""
        Group := ""
        Remark := ""
        AllPaths := []
        FolderPath := ""
        if (!BeginSafeTransaction("ClipboardChanged")) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1938940 å¼€å§‹äº‹åŠ¡å¤±è´¥ï¼
            LoadData()
            Return
        }
        if (DllCall("IsClipboardFormatAvailable", "UInt", 15)) {
            Format := "CF_HDROP"
            ClipData := Clipboard
            FilePathsList := ""

            Loop, Parse, Clipboard, `n, `r
            {
                Path := Trim(A_LoopField)
                if (Path != "" && FileExist(Path)) {
                    AllPaths.Push(Path)
                    FileCount++
                }
            }

            if (FileCount = 0) {
                RollbackSafeTransaction("ClipboardChanged")
                LoadData()
                Return
            }

            Path := AllPaths[1]
            FileAttrib := FileExist(Path)
            isFolderMode := InStr(FileAttrib, "D")

            SplitPath, Path, FileName, FileDir, FileExt, FileNameNoExt
            SplitPath, FileDir, , , , ParentDir
            Group := FileDir ? ParentDir : ""

            if (isFolderMode) {
                Loop, % AllPaths.MaxIndex() {
                    CurrentPath := AllPaths[A_Index]
                    CurrentAttrib := FileExist(CurrentPath)
                    if (!InStr(CurrentAttrib, "D")) {
                        continue
                    }

                    LocalValidCount := 0
                    LocalTotalSize := 0
                    LocalFilePathsList := ""
                    Loop, Files, %CurrentPath%\*.*, FR
                    {
                        if (FileExist(A_LoopFileFullPath)) {
                            LocalValidCount++
                            FileGetSize, FileSize, %A_LoopFileFullPath%, B
                            LocalTotalSize += FileSize
                            LocalFilePathsList .= A_LoopFileFullPath . "`n"
                        }
                    }
                    LocalFilePathsList := RTrim(LocalFilePathsList, "`n")
                    LocalClipData := LocalFilePathsList

                    LocalSizeStr := ""
                    if (LocalTotalSize > 0) {
                        if (LocalTotalSize < 1024)
                            LocalSizeStr := LocalTotalSize . " B"
                        else if (LocalTotalSize < 1024 * 1024)
                            LocalSizeStr := Round(LocalTotalSize / 1024,2) . " KB"
                        else if (LocalTotalSize < 1024 * 1024 * 1024)
                            LocalSizeStr := Round(LocalTotalSize / (1024 * 1024),2) . " MB"
                        else
                            LocalSizeStr := Round(LocalTotalSize / (1024 * 1024 * 1024),2) . " GB"
                    }

                    SplitPath, CurrentPath, LocalFileName, LocalFileDir, , LocalFileNameNoExt
                    SplitPath, LocalFileDir, , , , LocalParentDir
                    LocalGroup := LocalFileDir ? LocalParentDir : ""

                    LocalTempRemark := "Copied Folder - " . LocalFileNameNoExt . " | æ•°é‡: 1 | æœ‰æ•ˆ: " . LocalValidCount . " | å¤§å°: " . LocalSizeStr
                    LocalContent := LocalTempRemark
                    LocalRemark := CurrentPath

                    LocalIdentifier := "ğŸ“"
                    LocalFormat := "CF_HDROP,ğŸ“"

                    ClipData := LocalClipData
                    Content := LocalContent
                    Remark := LocalRemark
                    Identifier := LocalIdentifier
                    Format := LocalFormat
                    Group := LocalGroup

                    gosub, InsertCommon
                    if (FinalID = "" || FinalID <= 0) {
                        return
                    }
                }
            } else {
                ValidCount := 0
                TotalSize := 0
                FilePathsList := ""
                Loop, % AllPaths.MaxIndex() {
                    CurrentPath := AllPaths[A_Index]
                    FilePathsList .= CurrentPath . "`n"
                    FileGetSize, FileSize, %CurrentPath%, B
                    TotalSize += FileSize
                    ValidCount++
                }
                FilePathsList := RTrim(FilePathsList, "`n")
                ClipData := FilePathsList

                SizeStr := ""
                if (TotalSize > 0) {
                    if (TotalSize < 1024)
                        SizeStr := TotalSize . " B"
                    else if (TotalSize < 1024 * 1024)
                        SizeStr := Round(TotalSize / 1024,2) . " KB"
                    else if (TotalSize < 1024 * 1024 * 1024)
                        SizeStr := Round(TotalSize / (1024 * 1024),2) . " MB"
                    else
                        SizeStr := Round(TotalSize / (1024 * 1024 * 1024),2) . " GB"
                }

                ; ä½¿ç”¨ GetFileTypeSymbol å‡½æ•°è·å–æ ‡è¯†ç¬¦
                Identifier := GetFileTypeSymbol(Path, FileExt)
                Format := "CF_HDROP," . Identifier
                if (FileExt != "") {
                    Format .= "," . FileExt
                }
                TempRemark := "Copied File - " . FileNameNoExt . " | æ•°é‡: " . FileCount . " | æœ‰æ•ˆ: " . ValidCount . " | å¤§å°: " . SizeStr
                Content := TempRemark
                Remark := FileName

                gosub, InsertCommon
                if (FinalID = "" || FinalID <= 0) {
                    return
                }
            }
        } else {
            ClipData := Clipboard
            Format := "CF_UNICODETEXT"
            ClipData := RegExReplace(ClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", "")
            ClipData := Trim(ClipData)
            if (ClipData = "" || RegExMatch(ClipData, "^\s*$")) {
                RollbackSafeTransaction("ClipboardChanged")
                LoadData()
                Return
            }
            if (StrLen(ClipData) > 5000000) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4159040 æ–‡æœ¬å‰ªè´´æ¿å†…å®¹è¿‡å¤§ï¼ˆè¶…è¿‡ 5MBï¼‰ï¼
                LoadData()
                Return
            }
            lines := StrSplit(ClipData, "`n")
            FirstLine := Trim(lines[1])
            if (RegExMatch(FirstLine, "^[A-Za-z]:\\.*$") || RegExMatch(FirstLine, "^\\\\.*$")) {
                FirstAttrib := FileExist(FirstLine)
                SplitPath, FirstLine, FileName, FileDir, FileExt, FileNameNoExt
                if (InStr(FirstAttrib, "D")) {
                    Identifier := "ğŸ“ğ“Ÿ"
                    Format := "CF_UNICODETEXT,ğŸ“ğ“Ÿ"
                } else {
                    ; ä½¿ç”¨ GetFileTypeSymbol å‡½æ•°è·å–æ ‡è¯†ç¬¦
                    Identifier := GetFileTypeSymbol(FirstLine, FileExt) . "ğ“Ÿ"
                    Format := "CF_UNICODETEXT," . Identifier
                    if (FileExt != "") {
                        Format .= "," . FileExt
                    }
                }
                FileCount := 0
                ValidCount := 0
                TotalSize := 0
                Loop, % lines.Length() {
                    Path := Trim(lines[A_Index])
                    if (Path != "" && FileExist(Path)) {
                        FileAttrib := FileExist(Path)
                        FileCount++
                        if (InStr(FileAttrib, "D")) {
                            Loop, Files, %Path%\*.*, F
                            {
                                if (FileExist(A_LoopFileFullPath)) {
                                    ValidCount++
                                    FileGetSize, FileSize, %A_LoopFileFullPath%, B
                                    TotalSize += FileSize
                                }
                            }
                        } else {
                            ValidCount++
                            FileGetSize, FileSize, %Path%, B
                            TotalSize += FileSize
                        }
                    }
                }
                SizeStr := ""
                if (TotalSize > 0) {
                    if (TotalSize < 1024)
                        SizeStr := TotalSize . " B"
                    else if (TotalSize < 1024 * 1024)
                        SizeStr := Round(TotalSize / 1024,2) . " KB"
                    else if (TotalSize < 1024 * 1024 * 1024)
                        SizeStr := Round(TotalSize / (1024 * 1024),2) . " MB"
                    else
                        SizeStr := Round(TotalSize / (1024 * 1024 * 1024),2) . " GB"
                }
                SplitPath, FileDir, , , , ParentDir
                Group := FileDir ? ParentDir : ""
                if (InStr(FirstAttrib, "D")) {
                    TempRemark := "Copied Folder Path - " . FileNameNoExt . " | æ•°é‡: " . FileCount . " | æœ‰æ•ˆ: " . ValidCount . " | å¤§å°: " . SizeStr
                } else {
                    TempRemark := "Copied File Path - " . FileNameNoExt . " | æ•°é‡: " . FileCount . " | æœ‰æ•ˆ: " . ValidCount . " | å¤§å°: " . SizeStr
                }
                Content := RegExReplace(ClipData, "[\r\n]+", " ")
                Remark := Content
                Content := TempRemark
            } else {
                if (RegExMatch(ClipData, "^(https?|ftp)://[A-Za-z0-9\-\.]+(:[0-9]+)?(/[A-Za-z0-9\-\._~:/?#\[\]@!$&'()*+,;=%]*)?$")) {
                    Format := "CF_UNICODETEXT,ğŸ”—"
                    Identifier := "ğŸ”—"
                    Content := ClipData
                    if (RegExMatch(ClipData, "://([^/]+)", domainMatch)) {
                        fullDomain := domainMatch1
                        if (RegExMatch(fullDomain, "^(?:www\.)?([^.]+)\.[^.]+$", mainDomainMatch)) {
                            Remark := mainDomainMatch1
                        } else {
                            Remark := fullDomain
                        }
                    } else {
                        Remark := SubStr(ClipData, 1, 200)
                    }
                } else {
                    Remark := FirstLine
                    ByteCount := StrPut(ClipData, "UTF-8") - 1
                    if (ByteCount < 1024)
                        Bytes := ByteCount . " B"
                    else if (ByteCount < 1024 * 1024)
                        Bytes := Round(ByteCount / 1024,2) . " KB"
                    else if (ByteCount < 1024 * 1024 * 1024)
                        Bytes := Round(ByteCount / (1024 * 1024),2) . " MB"
                    else
                        Bytes := Round(ByteCount / (1024 * 1024 * 1024),2) . " GB"
                    CharCount := StrLen(ClipData)
                    LineCount := lines.Length()
                    Content := "[æ–‡æœ¬] | " . CharCount . " å­—ç¬¦ | " . Bytes . " | " . LineCount . " è¡Œ"
                }
            }

            gosub, InsertCommon
            if (FinalID = "" || FinalID <= 0) {
                return
            }
        }
        ; === åˆ†ç±»å­—å…¸_Oneï¼šæœ€åæ’å…¥IDï¼ˆç»Ÿä¸€ç»“æ„ï¼‰===
        DeleteRecordSQL := "DELETE FROM ""åˆ†ç±»å­—å…¸_One"" WHERE ""Category_Main"" = 'æœ€åæ’å…¥ID' AND ""Category_Sub"" = 'æœ€åæ’å…¥ID';"
        SQLiteDB.Exec(DeleteRecordSQL)
        LastIDValue := (FinalID ? FinalID : "")
        InsertRecordSQL := "INSERT OR REPLACE INTO ""åˆ†ç±»å­—å…¸_One"" "
                         . "(""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('æœ€åæ’å…¥ID', 'æœ€åæ’å…¥ID', ?, 1, datetime('now','localtime'));"
        if (SQLiteDB.ExecuteWithParams) {
            SQLiteDB.ExecuteWithParams(InsertRecordSQL, [LastIDValue])
        } else {
            EscapedLastID := StrReplace(LastIDValue, "'", "''")
            FallbackSQL := "INSERT OR REPLACE INTO ""åˆ†ç±»å­—å…¸_One"" "
                         . "(""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('æœ€åæ’å…¥ID', 'æœ€åæ’å…¥ID', '" . EscapedLastID . "', 1, datetime('now','localtime'));"
            SQLiteDB.Exec(FallbackSQL)
        }
        if (!CommitSafeTransaction("ClipboardChanged")) {
            RollbackSafeTransaction("ClipboardChanged")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3828190 äº‹åŠ¡æäº¤å¤±è´¥ï¼
            LoadData()
            Return
        }
        AttrCount := VerifyAllAttributes(FinalID, "å†å²æ•°æ®")
        if (AttrCount < 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5020111 å±æ€§å…³è”éªŒè¯å¤±è´¥
        }
        return
    InsertCommon:
        HashValue := ""
        try {
            if (ClipData != "") {
                HashValue := Crypt.Hash.Str(ClipData, "SHA256")
            }
        } catch e {
            eMessage := e.Message
            RollbackSafeTransaction("ClipboardChanged")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5334156 è®¡ç®—å“ˆå¸Œå€¼å¤±è´¥: %eMessage%
            LoadData()
            Return
        }
        ; === ä½¿ç”¨åˆ†ç±»å­—å…¸_Oneè¡¨ç»´æŠ¤æ’åºæœ€å¤§å€¼ï¼ˆå¸¦å”¯ä¸€æ€§å¤„ç†ï¼‰===
        GetMaxSortSQL := "SELECT COALESCE(""Record_Value"", 0) FROM ""åˆ†ç±»å­—å…¸_One"" WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' LIMIT 1;"
        MaxSortResult := {}
        CurrentMax := 0
        if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
            CurrentMax := MaxSortResult.Rows[1][1] + 0 ; å¼ºåˆ¶è½¬ä¸ºæ•°å­—
        } else {
            ; åˆå§‹åŒ–
            InitSQL := "INSERT OR IGNORE INTO ""åˆ†ç±»å­—å…¸_One"" (""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                     . "VALUES ('æ’åºå€¼', 'æœ€å¤§å€¼', '0', 0, datetime('now','localtime'));"
            if (!SQLiteDB.Exec(InitSQL)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3646934 æ–°ID-æ’åºåˆå§‹åŒ–å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
            CurrentMax := 0
        }
        ; å¾ªç¯è·å–å”¯ä¸€æ’åºå€¼
        Loop {
            NewSortValue := CurrentMax + 1
            ; å°è¯•æ›´æ–°æœ€å¤§å€¼
            UpdateMaxSQL := "UPDATE ""åˆ†ç±»å­—å…¸_One"" SET ""Record_Value"" = ?, ""Update_Time"" = datetime('now','localtime') "
                          . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' AND ""Record_Value"" = ?;"
            Success := false
            RetryCount := 3
            while (RetryCount > 0) {
                if (SQLiteDB.ExecuteWithParams) {
                    if (SQLiteDB.ExecuteWithParams(UpdateMaxSQL, [NewSortValue, CurrentMax])) {
                        Success := true
                        break
                    }
                } else {
                    FallbackSQL := "UPDATE ""åˆ†ç±»å­—å…¸_One"" SET ""Record_Value"" = '" . NewSortValue . "', ""Update_Time"" = datetime('now','localtime') "
                                 . "WHERE ""Category_Main"" = 'æ’åºå€¼' AND ""Category_Sub"" = 'æœ€å¤§å€¼' AND ""Record_Value"" = '" . CurrentMax . "';"
                    if (SQLiteDB.Exec(FallbackSQL)) {
                        Success := true
                        break
                    }
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 50
                    RetryCount--
                    continue
                }
                ; æ–°å¢ï¼šæ£€æŸ¥å”¯ä¸€çº¦æŸå¤±è´¥
                if (InStr(ErrorMsg, "UNIQUE constraint failed")) {
                    ; é‡æ–°è¯»å–ï¼ˆä½¿ç”¨ä¿®å¤åçš„ SQLï¼‰
                    if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                        CurrentMax := MaxSortResult.Rows[1][1] + 0
                    } else {
                        CurrentMax := 0
                    }
                    break ; é€€å‡º whileï¼Œé‡è¯•å¤–å±‚ Loop
                }
                break
            }
            if (Success) {
                ; æ›´æ–°æˆåŠŸï¼Œè¯´æ˜ NewSortValue å¯ç”¨
                break
            } else {
                ; æ›´æ–°å¤±è´¥ï¼Œè¯´æ˜æœ‰å¹¶å‘ï¼Œé‡æ–°è¯»å–å½“å‰æœ€å¤§å€¼
                if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                    CurrentMax := MaxSortResult.Rows[1][1] + 0
                } else {
                    CurrentMax := 0
                }
            }
        }
        ExistingID := ""
        CheckSQL := "SELECT ID FROM å†å²æ•°æ® WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
        CheckResult := {}
        if (SQLiteDB.GetTable(CheckSQL, CheckResult, [HashValue]) && CheckResult.RowCount >= 1) {
            ExistingID := CheckResult.Rows[1][1]
        }
        if (StrLen(Content) > 1000000) {
            Content := SubStr(Content, 1, 1000000)
        }
        if (StrLen(Remark) > 1000) {
            Remark := SubStr(Remark, 1, 1000)
        }
        HashValue := HashValue ? HashValue : ""
        Bytes := Bytes ? Bytes : ""
        WindowDetail := WindowTitle ? WindowTitle : ""
        Identifier := Identifier ? Identifier : ""
        Format := Format ? Format : ""
        Remark := Remark ? RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
        Content := Content ?RegExReplace(Content, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
        Group := Group ? RegExReplace(Group, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
        AppName := AppName ? RegExReplace(AppName, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : "æœªçŸ¥åº”ç”¨"
        if (RegExMatch(WindowTitle, "(.+)\s*-\s*(.+)$", Match)) {
            AppName := Trim(Match2)
        } else {
            AppName := WindowTitle ? WindowTitle : "æœªçŸ¥åº”ç”¨"
        }
        EscapedHashValue := StrReplace(HashValue, "'", "''")
        EscapedBytes := StrReplace(Bytes, "'", "''")
        EscapedWindowDetail := StrReplace(WindowTitle, "'", "''")
        EscapedIdentifier := StrReplace(Identifier, "'", "''")
        EscapedFormat := StrReplace(Format, "'", "''")
        EscapedRemark := StrReplace(Remark, "'", "''")
        EscapedContent := StrReplace(Content, "'", "''")
        EscapedGroup := StrReplace(Group, "'", "''")
        EscapedAppName := StrReplace(AppName, "'", "''")
        EscapedClipData := StrReplace(ClipData, "'", "''")
        Success := false
        RetryCount := 3
        G_last_insert_rowid := ""

        if (ExistingID != "") {
            ; ğŸ”¥ ä¿®æ”¹ï¼šUPDATE è¯­å¥ä¸­ ç±»å‹ã€åˆ†ç»„ã€åº”ç”¨åç§°ã€æ ‡è¯† è®¾ä¸ºç©º
            UpdateSQL := "UPDATE å†å²æ•°æ® SET æ’åº = " . NewSortValue . ", æ›´æ–°æ¬¡æ•° = COALESCE(æ›´æ–°æ¬¡æ•°, 0) + 1, ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime'), è®¿é—®æ—¶é—´ = datetime('now', 'localtime'), å†…å®¹ = '" . EscapedContent . "', å­—èŠ‚ = '" . EscapedBytes . "', çª—å£è¯¦æƒ… = '" . EscapedWindowDetail . "', ç±»å‹ = '', åˆ†ç»„ = '', åº”ç”¨åç§° = '', æ ‡è¯† = '', å¤„ç†çŠ¶æ€ = NULL, æç¤ºæ—¶é—´ = NULL, æç¤º = NULL WHERE ID = " . ExistingID . ";"
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(UpdateSQL)) {
                    Success := true
                    FinalID := ExistingID
                    G_last_insert_rowid := ExistingID
                    G_last_insert_Main_ID := ExistingID
                    G_last_insert_Main_TableName := "å†å²æ•°æ®"
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3720054 æ›´æ–°ä¸»è¡¨å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
            DeleteDataSQL := "DELETE FROM Data_å†å²æ•°æ® WHERE lParentID = " . ExistingID . ";"
            RetryCount := 3
            Success := false
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(DeleteDataSQL)) {
                    Success := true
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3724787 ; åˆ é™¤æ•°æ®è¡¨å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
            InsertDataSQL := "INSERT INTO Data_å†å²æ•°æ® (lParentID, strClipBoardFormat, ooData) VALUES (" . ExistingID . ", '" . EscapedFormat . "', '" . EscapedClipData . "');"
            RetryCount := 3
            Success := false
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(InsertDataSQL)) {
                    Success := true
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š3958064 ; æ’å…¥æ•°æ®è¡¨å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
        } else {
            AllocSQL := "INSERT INTO ä¸­å¿ƒåŒ– (æ ‡è®°çŠ¶æ€) VALUES (0);"
            if (!SQLiteDB.Exec(AllocSQL)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5142862 ; åˆ†é…å…¨å±€IDå¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }

            LastIDResult := {}
            G_last_insert_rowid := ""
            FinalID := ""
            if (SQLiteDB.GetTable("SELECT last_insert_rowid() AS newid;", LastIDResult) && LastIDResult.RowCount > 0) {
                G_last_insert_rowid := LastIDResult.Rows[1][1]
                FinalID := G_last_insert_rowid
            } else {
                ErrorMsg := SQLiteDB._ErrMsg()
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5224280 ;  è·å–å…¨å±€IDå¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }

            if (FinalID = "" || FinalID <= 0) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5234045 ;  å…¨å±€IDæ— æ•ˆ: FinalID = %FinalID%
                LoadData()
                Return
            }

            ; ğŸ”¥ ä¿®æ”¹ï¼šINSERT è¯­å¥ä¸­ ç±»å‹ã€åˆ†ç»„ã€åº”ç”¨åç§°ã€æ ‡è¯† è®¾ä¸ºç©ºå­—ç¬¦ä¸²
            InsertMainSQL := "INSERT INTO å†å²æ•°æ® (ID, å“ˆå¸Œå€¼, å­—èŠ‚, çª—å£è¯¦æƒ…, ç±»å‹, æ’åº, æ›´æ–°æ¬¡æ•°, åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´, è®¿é—®æ—¶é—´, å¤‡æ³¨, å†…å®¹, åˆ†ç»„, åº”ç”¨åç§°, æ ‡è¯†, å¤„ç†çŠ¶æ€, æç¤ºæ—¶é—´, æç¤º) VALUES (" . FinalID . ", '" . EscapedHashValue . "', '" . EscapedBytes . "', '" . EscapedWindowDetail . "', '', " . NewSortValue . ", 0, datetime('now', 'localtime'), datetime('now', 'localtime'), datetime('now', 'localtime'), '" . EscapedRemark . "', '" . EscapedContent . "', '', '', '', NULL, NULL, NULL);"

            RetryCount := 3
            Success := false
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(InsertMainSQL)) {
                    Success := true
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "UNIQUE constraint failed: å†å²æ•°æ®.æ’åº")) {
                    ; æ’åºå€¼å†²çªï¼Œé‡æ–°è·å–
                    if (SQLiteDB.GetTable(GetMaxSortSQL, MaxSortResult) && MaxSortResult.RowCount > 0) {
                        CurrentMax := MaxSortResult.Rows[1][1] + 0
                    } else {
                        CurrentMax := 0
                    }
                    NewSortValue := CurrentMax + 1
                    InsertMainSQL := RegExReplace(InsertMainSQL, "æ’åº = \d+", "æ’åº = " . NewSortValue)
                    Sleep, 50
                    RetryCount--
                    continue
                }
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                ; MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1333744 æ’å…¥ä¸»è¡¨å¤±è´¥: %ErrorMsg%`n`nSQL: %InsertMainSQL%
				GetGlobalMaxSortValue()
				ClipboardChanged(type)
                ; LoadData()
                Return
            }

            MarkSQL := "UPDATE ä¸­å¿ƒåŒ– SET æ ‡è®°çŠ¶æ€ = 1 WHERE Local_ID = " . FinalID . ";"
            if (!SQLiteDB.Exec(MarkSQL)) {
            }

            InsertDataSQL := "INSERT INTO Data_å†å²æ•°æ® (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", '" . EscapedFormat . "', '" . EscapedClipData . "');"
            RetryCount := 3
            Success := false
            while (RetryCount > 0) {
                if (SQLiteDB.Exec(InsertDataSQL)) {
                    Success := true
                    break
                }
                ErrorMsg := SQLiteDB._ErrMsg()
                if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                    Sleep, 100
                    RetryCount--
                    continue
                }
                break
            }
            if (!Success) {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4653894 æ’å…¥æ•°æ®è¡¨å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
            G_last_insert_Main_ID := FinalID
            G_last_insert_Main_TableName := "å†å²æ•°æ®"
        }

        ; ğŸ”¥ å±æ€§æ’å…¥éƒ¨åˆ† - å¼€å§‹ï¼ˆå°† ç±»å‹ã€åˆ†ç»„ã€åº”ç”¨åç§°ã€æ ‡è¯† æ’å…¥åˆ°å…³è”å±æ€§è¡¨ï¼‰
        Attributes := []
        Attributes.Push({Format: "æ˜Ÿçº§", Value: "0"})

        ; å°†ç±»å‹å­—æ®µæ‹†åˆ†åæ’å…¥åˆ°å…³è”å±æ€§è¡¨
        if (Format != "") {
            ; æ‹†åˆ†æ ¼å¼å­—ç¬¦ä¸²ï¼ˆå¦‚ "CF_HDROP,ğŸ“,exe" -> ["CF_HDROP", "ğŸ“", "exe"]ï¼‰
            FormatParts := StrSplit(Format, ",")
            Loop, % FormatParts.Length() {
                TypeValue := Trim(FormatParts[A_Index])
                if (TypeValue != "" && TypeValue != "CF_HDROP" && TypeValue != "CF_UNICODETEXT") {
                    ; è¿‡æ»¤æ‰ç³»ç»Ÿæ ¼å¼æ ‡è¯†ï¼Œåªä¿ç•™æœ‰æ„ä¹‰çš„ç±»å‹
                    Attributes.Push({Format: "ç±»å‹", Value: TypeValue})
                }
            }
        }

        ; å°†æ ‡è¯†ç¬¦ä¹Ÿæ’å…¥åˆ°å…³è”å±æ€§è¡¨
        if (Identifier != "") {
            Attributes.Push({Format: "æ ‡è¯†", Value: Identifier})
        }

        if (DataType = 1 && ClipData != "") {
            if (InStr(ClipData, ";") || InStr(ClipData, "{") || InStr(ClipData, "}") || InStr(ClipData, "function") || InStr(ClipData, "def ") || InStr(ClipData, "#include") || InStr(ClipData, "public ") || InStr(ClipData, "private ") || InStr(ClipData, "class ") || InStr(ClipData, "var ") || InStr(ClipData, "let ") || InStr(ClipData, "const ") || InStr(ClipData, "if (") || InStr(ClipData, "else") || InStr(ClipData, "for (") || InStr(ClipData, "while (")) {
                Attributes.Push({Format: "å…³é”®å­—", Value: "ä»£ç "})
            }
        }

        ; å°†åˆ†ç»„æ’å…¥åˆ°å…³è”å±æ€§è¡¨
        if (Group != "") {
            Attributes.Push({Format: "åˆ†ç»„", Value: Group})
        }

        ; å°†åº”ç”¨åç§°æ’å…¥åˆ°å…³è”å±æ€§è¡¨
        if (AppName != "" && AppName != "æœªçŸ¥åº”ç”¨") {
            Attributes.Push({Format: "åº”ç”¨åç§°", Value: AppName})
            IsFolderPath := (RegExMatch(AppName, "^[A-Za-z]:\\.*$") && InStr(FileExist(AppName), "D"))
            if (!IsFolderPath) {
                Tags := []
                if (RegExMatch(AppName, "^(.+)\s*-\s*(.+)$", Match)) {
                    FirstPart := Trim(Match1)
                    SecondPart := Trim(Match2)
                    if (!RegExMatch(FirstPart, "\.[a-zA-Z0-9]{1,4}$")) {
                        Tags.Push(FirstPart)
                    }
                    if (SecondPart = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(SecondPart)
                    }
                } else {
                    if (AppName = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(AppName)
                    }
                }
                for index, Tag in Tags {
                    if (Tag != "" && Tag != "æœªçŸ¥åº”ç”¨") {
                        Attributes.Push({Format: "å…³é”®å­—", Value: Tag})
                    }
                }
            }
        }

        for index, attr in Attributes {
            Result := InsertAttribute("å†å²æ•°æ®", FinalID, attr.Format, attr.Value)
            ErrorMsg := Result.ErrorMsg
            if (!Result.Success && ErrorMsg != "æ˜Ÿçº§ä¸º 0ï¼Œè·³è¿‡æ’å…¥" && ErrorMsg != "å±æ€§æ ¼å¼æˆ–å€¼ä¸ºç©ºï¼Œè·³è¿‡") {
                RollbackSafeTransaction("ClipboardChanged")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š2125567 æ’å…¥å±æ€§å¤±è´¥: %ErrorMsg%
                LoadData()
                Return
            }
        }
        ; ğŸ”¥ å±æ€§æ’å…¥éƒ¨åˆ† - ç»“æŸ

        return

    } catch e {
        eMessage := e.Message
        RollbackSafeTransaction("ClipboardChanged")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4846379 ClipboardChanged å¼‚å¸¸: %eMessage%
    } finally {
        G_last_insert_rowid := FinalID
        g_CurrentRecord.ID := FinalID
        g_CurrentRecord.TableName := "å†å²æ•°æ®"
        SB_SetText("ClipboardChanged: å¡«å……ç¼“å­˜ ID=" . FinalID)
        ProcessingContext := ""
        if (ClipboardLock = 3) {
            ClipboardLock := 0
            PostMessage, 0x0400 + 1, 0, 0, , ahk_class AutoHotkey
        }
        LoadData()
		GetGlobalMaxSortValue()
        SetTimer, WatchDatabaseDir, 3000
    }
    Return
}

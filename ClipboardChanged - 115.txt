; ===========================================
; å®Œæ•´ä¿®å¤ç‰ˆæœ¬ - æ–‡ä»¶ç›‘å¬ç³»ç»Ÿ
; ===========================================

; å®šä¹‰å…¨å±€å˜é‡
Global IsCopying, ClipboardLock, retryCount, textData, GlobalFileList, SQLiteDB, DBPath, ProcessingContext
Global TransactionActive := false
Global TransactionOwner := ""

; åˆå§‹åŒ–å…¨å±€é‡è¯•è®¡æ•°
retryCount := 0
textData := ""
ProcessingContext := ""

; è®°å½•æ–‡ä»¶å¤¹å’Œæ–‡ä»¶çŠ¶æ€
FolderStates := {}

; ===========================================
; ä¸»ç›‘å¬å‡½æ•°
; ===========================================
WatchDatabaseDir:
    Global SQLiteDB, DBPath, ProcessingContext, TransactionActive, TransactionOwner, FolderStates
    ProcessingContext := "WatchDir"
    AddDebugLog("WatchDatabaseDir - å¼€å§‹æ‰§è¡Œç›‘å¬...")

    if (!CheckDBUnlocked(DBPath)) {
        AddDebugLog("WatchDatabaseDir - é”™è¯¯: æ•°æ®åº“è¢«é”å®šã€‚")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š503643 æ•°æ®åº“è¢«å ç”¨ï¼Œè¯·ç¨åå†è¯•
        ProcessingContext := ""
        Return
    }

    if (!SQLiteDB) {
        SQLiteDB := New SQLiteDB()
        if (!SQLiteDB.OpenDB(DBPath)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            AddDebugLog("WatchDatabaseDir - é”™è¯¯: æ‰“å¼€æ•°æ®åº“å¤±è´¥ - " . ErrorMsg)
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š525077 æ‰“å¼€æ•°æ®åº“å¤±è´¥: %ErrorMsg%
            ProcessingContext := ""
            Return
        }
    }

    try {
        AddDebugLog("WatchDatabaseDir - æ­£åœ¨æ£€æŸ¥ 'æ³¨å†Œç™»è®°è·¯å¾„' è¡¨...")
        ; === å…ˆæ£€æŸ¥æ³¨å†Œç™»è®°è·¯å¾„è¡¨çš„ç»“æ„ ===
        CheckTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ³¨å†Œç™»è®°è·¯å¾„';"
        CheckTableResult := {}
        TableExists := false
        if (SQLiteDB.GetTable(CheckTableSQL, CheckTableResult) && CheckTableResult.RowCount > 0) {
            TableExists := true
        }

        ; ç¡®ä¿æ³¨å†Œç™»è®°è·¯å¾„è¡¨å­˜åœ¨
        if (!TableExists) {
            AddDebugLog("WatchDatabaseDir - 'æ³¨å†Œç™»è®°è·¯å¾„' è¡¨ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º...")
            CreateTableSQL := "CREATE TABLE IF NOT EXISTS æ³¨å†Œç™»è®°è·¯å¾„ (Local_ID INTEGER PRIMARY KEY AUTOINCREMENT, æ ‡è¯† TEXT, æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶åç§° TEXT, è·¯å¾„ TEXT NOT NULL UNIQUE, æ–‡ä»¶å¤¹å¤§å° TEXT, è¯¦ç»†èµ„æ–™ TEXT DEFAULT '', æ–‡ä»¶æ•°é‡ INTEGER, è®¿é—®æ—¶é—´ DATETIME DEFAULT (datetime('now', 'localtime')), ID INTEGER, ä¸»è¡¨åç§° TEXT);"
            if (!SQLiteDB.Exec(CreateTableSQL)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                AddDebugLog("WatchDatabaseDir - é”™è¯¯: åˆ›å»º 'æ³¨å†Œç™»è®°è·¯å¾„' è¡¨å¤±è´¥ - " . ErrorMsg)
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212116 åˆ›å»ºæ³¨å†Œç™»è®°è·¯å¾„è¡¨å¤±è´¥: %ErrorMsg%
                ProcessingContext := ""
                Return
            }
        } else {
            ; æ£€æŸ¥å¹¶æ·»åŠ ç¼ºå¤±çš„åˆ—
            PRAGMASQL := "PRAGMA table_info(æ³¨å†Œç™»è®°è·¯å¾„);"
            ColumnInfo := {}
            SQLiteDB.GetTable(PRAGMASQL, ColumnInfo)

            hasIDColumn := false
            hasMainTableColumn := false
            Loop, % ColumnInfo.RowCount {
                if (ColumnInfo.Rows[A_Index][2] = "ID") {
                    hasIDColumn := true
                }
                if (ColumnInfo.Rows[A_Index][2] = "ä¸»è¡¨åç§°") {
                    hasMainTableColumn := true
                }
            }

            if (!hasIDColumn) {
                AddDebugLog("WatchDatabaseDir - 'æ³¨å†Œç™»è®°è·¯å¾„' è¡¨ç¼ºå°‘ 'ID' åˆ—ï¼Œæ­£åœ¨æ·»åŠ ...")
                AlterTableSQL1 := "ALTER TABLE æ³¨å†Œç™»è®°è·¯å¾„ ADD COLUMN ID INTEGER;"
                if (!SQLiteDB.Exec(AlterTableSQL1)) {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("WatchDatabaseDir - é”™è¯¯: æ·»åŠ  'ID' åˆ—å¤±è´¥ - " . ErrorMsg)
                }
            }

            if (!hasMainTableColumn) {
                AddDebugLog("WatchDatabaseDir - 'æ³¨å†Œç™»è®°è·¯å¾„' è¡¨ç¼ºå°‘ 'ä¸»è¡¨åç§°' åˆ—ï¼Œæ­£åœ¨æ·»åŠ ...")
                AlterTableSQL2 := "ALTER TABLE æ³¨å†Œç™»è®°è·¯å¾„ ADD COLUMN ä¸»è¡¨åç§° TEXT;"
                if (!SQLiteDB.Exec(AlterTableSQL2)) {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("WatchDatabaseDir - é”™è¯¯: æ·»åŠ  'ä¸»è¡¨åç§°' åˆ—å¤±è´¥ - " . ErrorMsg)
                }
            }
        }

        ; æ£€æŸ¥Databaseè¡¨
        CheckSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='Database';"
        CheckResult := {}
        if (!SQLiteDB.GetTable(CheckSQL, CheckResult) || CheckResult.RowCount = 0) {
            AddDebugLog("WatchDatabaseDir - é”™è¯¯: 'Database' è¡¨ä¸å­˜åœ¨ã€‚")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212114 Databaseè¡¨ä¸å­˜åœ¨
            ProcessingContext := ""
            Return
        }

        ; æ„å»ºç›‘å¬ç›®å½•åˆ—è¡¨
        dirList := []
        dirList.Push(A_ScriptDir . "\Database")
        AddDebugLog("WatchDatabaseDir - æ·»åŠ é»˜è®¤ç›‘å¬ç›®å½•: " . A_ScriptDir . "\Database")

        ; === ä»åˆ†ç±»å­—å…¸_Oneè¡¨è¯»å–ç›‘å¬æ–‡ä»¶å¤¹ï¼ˆä¸»è¦æ–¹å¼ï¼‰===
        sqlMonitorFolders := "SELECT Category_Sub FROM åˆ†ç±»å­—å…¸_One WHERE Category_Main = 'ç›‘å¬æ–‡ä»¶å¤¹' AND Flag_Status = 1;"
        ResultMonitor := {}
        if (SQLiteDB.GetTable(sqlMonitorFolders, ResultMonitor) && ResultMonitor.RowCount >= 1) {
            Loop, % ResultMonitor.RowCount {
                folderPath := ResultMonitor.Rows[A_Index][1]
                if (folderPath = "") {
                    continue
                }
                found := false
                for index, dir in dirList {
                    if (dir = folderPath) {
                        found := true
                        break
                    }
                }
                if (!found && FileExist(folderPath)) {
                    dirList.Push(folderPath)
                    AddDebugLog("WatchDatabaseDir - ä» 'åˆ†ç±»å­—å…¸_One' æ·»åŠ ç›‘å¬ç›®å½•: " . folderPath)
                }
            }
        }

        ; === å…¼å®¹æ—§çš„å±æ€§è¡¨ï¼ˆå¦‚æœè¿˜åœ¨ä½¿ç”¨ï¼‰===
        sqlFolders := "SELECT å±æ€§å€¼ FROM å±æ€§ WHERE å±æ€§æ ¼å¼ = 'æ–‡ä»¶å¤¹è·¯å¾„';"
        ResultFolders := {}
        if (SQLiteDB.GetTable(sqlFolders, ResultFolders) && ResultFolders.RowCount >= 1) {
            Loop, % ResultFolders.RowCount {
                folderPath := ResultFolders.Rows[A_Index][1]
                found := false
                for index, dir in dirList {
                    if (dir = folderPath) {
                        found := true
                        break
                    }
                }
                if (!found && FileExist(folderPath)) {
                    dirList.Push(folderPath)
                    AddDebugLog("WatchDatabaseDir - ä» 'å±æ€§' è¡¨æ·»åŠ ç›‘å¬ç›®å½•: " . folderPath)
                }
            }
        }

        AddDebugLog("WatchDatabaseDir - å…± " . dirList.Length() . " ä¸ªç›®å½•å¾…å¤„ç†ã€‚")
        ; å¤„ç†æ‰€æœ‰ç›‘å¬ç›®å½•
        for dirIndex, dirPath in dirList {
            if (!FileExist(dirPath)) {
                AddDebugLog("WatchDatabaseDir - ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡: " . dirPath)
                continue
            }

            AddDebugLog("WatchDatabaseDir - æ­£åœ¨å¤„ç†ç›®å½•: " . dirPath)
            ; å¤„ç†å­æ–‡ä»¶å¤¹
            Loop, Files, %dirPath%\*, D R
            {
                item := A_LoopFileFullPath
                SB_SetText("æ­£åœ¨å¤„ç†å­æ–‡ä»¶å¤¹: " . item)
                ProcessSingleFolder(item)
            }

            ; å¤„ç†ç›´å±æ–‡ä»¶
            Loop, Files, %dirPath%\*, F
            {
                item := A_LoopFileFullPath
                if (FileExist(item) && !InStr(FileExist(item), "D")) {
                    SplitPath, item, fileName
                    SB_SetText("æ­£åœ¨å¤„ç†ç›´å±æ–‡ä»¶: " . fileName)
                    ProcessSingleFile(item)
                }
            }
        }

        RegisterAndValidateFolders()
        ValidatePaths()
        FixNullSortValues("")
        SB_SetText("ç›‘å¬å¤„ç†å®Œæˆ - å·²å¤„ç† " . dirList.Length() . " ä¸ªç›‘å¬ç›®å½•")
        AddDebugLog("WatchDatabaseDir - ç›‘å¬å¤„ç†å®Œæˆã€‚")

    } catch e {
        ErrorMsg := e.Message
        AddDebugLog("WatchDatabaseDir - å¼‚å¸¸: " . ErrorMsg)
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š503644 WatchDatabaseDirå¼‚å¸¸: %ErrorMsg%
    } finally {
        if (TransactionActive && TransactionOwner = "WatchDatabaseDir") {
            RollbackSafeTransaction("WatchDatabaseDir")
        }
        ProcessingContext := ""
    }
Return

; ===========================================
; å¤„ç†å•ä¸ªæ–‡ä»¶å¤¹
; ===========================================
ProcessSingleFolder(folderPath) {
    Global SQLiteDB, FolderStates, ProcessingContext
    AddDebugLog("ProcessSingleFolder - å¼€å§‹å¤„ç†æ–‡ä»¶å¤¹: " . folderPath)

    if (!SQLiteDB) {
        AddDebugLog("ProcessSingleFolder - é”™è¯¯: æ•°æ®åº“è¿æ¥æœªåˆå§‹åŒ–ã€‚")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š717798 æ•°æ®åº“è¿æ¥æœªåˆå§‹åŒ–
        Return false
    }

    if (!FileExist(folderPath) || !InStr(FileExist(folderPath), "D")) {
        AddDebugLog("ProcessSingleFolder - æ–‡ä»¶å¤¹ä¸å­˜åœ¨æˆ–ä¸æ˜¯ç›®å½•: " . folderPath)
        Return false
    }

    folderState := GetFolderState(folderPath)
    SplitPath, folderPath, folderName
    sizeText := FormatSize(folderState.totalSize)
    AddDebugLog("ProcessSingleFolder - æ–‡ä»¶å¤¹çŠ¶æ€: " . folderName . ", å¤§å°: " . sizeText . ", æ–‡ä»¶æ•°: " . folderState.fileCount)

    if (ProcessingContext = "WatchDir") {
        transactionStarted := BeginSafeTransaction("ProcessSingleFolder")
        if (!transactionStarted) {
            AddDebugLog("ProcessSingleFolder - é”™è¯¯: äº‹åŠ¡å¼€å¯å¤±è´¥ã€‚")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212610 äº‹åŠ¡å¼€å§‹å¤±è´¥
            Return false
        }

        try {
            ; æ£€æŸ¥æ–‡ä»¶å¤¹è·¯å¾„æ˜¯å¦å·²ç™»è®°
            CheckFolderSQL := "SELECT Local_ID FROM æ³¨å†Œç™»è®°è·¯å¾„ WHERE è·¯å¾„ = ?;"
            CheckFolderResult := {}
            if (!SQLiteDB.GetTable(CheckFolderSQL, CheckFolderResult, [folderPath])) {
                ErrorMsg := SQLiteDB._ErrMsg()
                AddDebugLog("ProcessSingleFolder - é”™è¯¯: æŸ¥è¯¢æ–‡ä»¶å¤¹ç™»è®°çŠ¶æ€å¤±è´¥ - " . ErrorMsg)
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212611 æŸ¥è¯¢æ–‡ä»¶å¤¹å¤±è´¥: %ErrorMsg%
                RollbackSafeTransaction("ProcessSingleFolder")
                Return false
            }

            if (CheckFolderResult.RowCount = 0) {
                AddDebugLog("ProcessSingleFolder - æ–°æ–‡ä»¶å¤¹ï¼Œæœªç™»è®°ï¼Œæ­£åœ¨å¤„ç†: " . folderPath)
                ; === è·¯å¾„æœªç™»è®°ï¼Œéœ€è¦å¤„ç† ===

                ; 1. å…ˆç™»è®°è·¯å¾„ï¼ˆLocal_ID è‡ªå¢ï¼Œä¸éœ€è¦æ‰‹åŠ¨æŒ‡å®šï¼‰
                InsertFolderSQL := "INSERT INTO æ³¨å†Œç™»è®°è·¯å¾„ (æ ‡è¯†, æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶åç§°, è·¯å¾„, æ–‡ä»¶å¤¹å¤§å°, è¯¦ç»†èµ„æ–™, æ–‡ä»¶æ•°é‡, è®¿é—®æ—¶é—´) VALUES (?, ?, ?, ?, ?, ?, datetime('now', 'localtime'));"
                InsertSuccess := false
                if (SQLiteDB.ExecuteWithParams) {
                    InsertSuccess := SQLiteDB.ExecuteWithParams(InsertFolderSQL, ["ğŸ“", folderName, folderPath, sizeText, folderState.fileList, folderState.fileCount])
                } else {
                    EscapedFolderName := StrReplace(folderName, "'", "''")
                    EscapedFolderPath := StrReplace(folderPath, "'", "''")
                    EscapedSizeText := StrReplace(sizeText, "'", "''")
                    EscapedFileList := StrReplace(folderState.fileList, "'", "''")
                    FallbackSQL := "INSERT INTO æ³¨å†Œç™»è®°è·¯å¾„ (æ ‡è¯†, æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶åç§°, è·¯å¾„, æ–‡ä»¶å¤¹å¤§å°, è¯¦ç»†èµ„æ–™, æ–‡ä»¶æ•°é‡, è®¿é—®æ—¶é—´) VALUES ('ğŸ“', '" . EscapedFolderName . "', '" . EscapedFolderPath . "', '" . EscapedSizeText . "', '" . EscapedFileList . "', " . folderState.fileCount . ", datetime('now', 'localtime'));"
                    InsertSuccess := SQLiteDB.Exec(FallbackSQL)
                }

                if (!InsertSuccess) {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("ProcessSingleFolder - é”™è¯¯: ç™»è®°æ–°æ–‡ä»¶å¤¹å¤±è´¥ - " . ErrorMsg)
                    MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212630 ç™»è®°æ–‡ä»¶å¤¹å¤±è´¥: %ErrorMsg%
                    RollbackSafeTransaction("ProcessSingleFolder")
                    Return false
                }

                ; 2. ä¿å­˜çŠ¶æ€
                FolderStates[folderPath] := folderState

                ; 3. åŒæ­¥åˆ°Databaseä¸»è¡¨ï¼ˆè¿™æ‰æ˜¯çœŸæ­£çš„æ•°æ®ï¼‰
                GlobalFileList := folderPath
                GlobalComment := folderName
                AddDebugLog("ProcessSingleFolder - æ­£åœ¨åŒæ­¥æ–°æ–‡ä»¶å¤¹åˆ° Database è¡¨...")
                newID := SavePathMerged()
                if (newID > 0) {
                    FolderStates[folderPath].processedTime := A_Now
                    AddDebugLog("ProcessSingleFolder - åŒæ­¥æˆåŠŸï¼Œè·å¾—æ–°ID: " . newID)

                    ; 4. å°†æ–°IDæ›´æ–°å›æ³¨å†Œç™»è®°è·¯å¾„è¡¨
                    UpdateLinkSQL := "UPDATE æ³¨å†Œç™»è®°è·¯å¾„ SET ID = ?, ä¸»è¡¨åç§° = 'Database' WHERE è·¯å¾„ = ?;"
                    if (!SQLiteDB.ExecuteWithParams(UpdateLinkSQL, [newID, folderPath])) {
                        ErrorMsg := SQLiteDB._ErrMsg()
                        AddDebugLog("ProcessSingleFolder - é”™è¯¯: å…³è”æ–°æ–‡ä»¶å¤¹è®°å½•IDå¤±è´¥ - " . ErrorMsg)
                        ; è¿™æ˜¯ä¸€ä¸ªè­¦å‘Šï¼Œä¸æ˜¯è‡´å‘½é”™è¯¯ï¼Œæ‰€ä»¥ä¸å›æ»š
                    } else {
                        AddDebugLog("ProcessSingleFolder - æˆåŠŸå…³è”ID " . newID . " åˆ°è·¯å¾„ " . folderPath)
                    }
                } else {
                    AddDebugLog("ProcessSingleFolder - é”™è¯¯: åŒæ­¥å¤±è´¥ï¼Œæœªè·å¾—æ–°IDã€‚")
                }

            } else {
                ; === è·¯å¾„å·²ç™»è®°ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–° ===
                needsUpdate := false
                oldState := {}
                if (!FolderStates.HasKey(folderPath)) {
                    needsUpdate := true
                    AddDebugLog("ProcessSingleFolder - æ–‡ä»¶å¤¹å·²ç™»è®°ï¼Œä½†æ— ç¼“å­˜çŠ¶æ€ï¼Œéœ€è¦æ›´æ–°ã€‚")
                } else {
                    oldState := FolderStates[folderPath]
                    if (folderState.fileCount != oldState.fileCount || folderState.totalSize != oldState.totalSize || folderState.lastModified != oldState.lastModified) {
                        needsUpdate := true
                        AddDebugLog("ProcessSingleFolder - æ–‡ä»¶å¤¹çŠ¶æ€å˜åŒ–ï¼Œéœ€è¦æ›´æ–°ã€‚æ—§çŠ¶æ€: " . oldState.fileCount . "ä¸ªæ–‡ä»¶, " . oldState.totalSize . "å­—èŠ‚ã€‚æ–°çŠ¶æ€: " . folderState.fileCount . "ä¸ªæ–‡ä»¶, " . folderState.totalSize . "å­—èŠ‚ã€‚")
                    }
                }

                if (needsUpdate) {
                    AddDebugLog("ProcessSingleFolder - æ­£åœ¨æ›´æ–°å·²ç™»è®°çš„æ–‡ä»¶å¤¹ä¿¡æ¯: " . folderPath)

                    ; 1. å…ˆä»ç™»è®°è¡¨è·å–ä¸»è¡¨ID
                    GetIDSQL := "SELECT ID FROM æ³¨å†Œç™»è®°è·¯å¾„ WHERE è·¯å¾„ = ?;"
                    IDResult := {}
                    dbID := 0
                    if (SQLiteDB.GetTable(GetIDSQL, IDResult, [folderPath]) && IDResult.RowCount > 0) {
                        dbID := IDResult.Rows[1][1]
                    }

                    ; 2. æ›´æ–°æ³¨å†Œç™»è®°è·¯å¾„è¡¨
                    UpdateRegisterSQL := "UPDATE æ³¨å†Œç™»è®°è·¯å¾„ SET æ ‡è¯† = ?, æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶åç§° = ?, æ–‡ä»¶å¤¹å¤§å° = ?, è¯¦ç»†èµ„æ–™ = ?, æ–‡ä»¶æ•°é‡ = ?, è®¿é—®æ—¶é—´ = datetime('now', 'localtime') WHERE è·¯å¾„ = ?;"
                    if (!SQLiteDB.ExecuteWithParams(UpdateRegisterSQL, ["ğŸ“", folderName, sizeText, folderState.fileList, folderState.fileCount, folderPath])) {
                         ErrorMsg := SQLiteDB._ErrMsg()
                        AddDebugLog("ProcessSingleFolder - é”™è¯¯: æ›´æ–°æ–‡ä»¶å¤¹ç™»è®°ä¿¡æ¯å¤±è´¥ - " . ErrorMsg)
                        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212660 æ›´æ–°æ–‡ä»¶å¤¹ç™»è®°å¤±è´¥: %ErrorMsg%
                        RollbackSafeTransaction("ProcessSingleFolder")
                        Return false
                    }

                    if (dbID > 0) {
                        ; 3. å¦‚æœæœ‰IDï¼Œç›´æ¥æ›´æ–°Databaseä¸»è¡¨
                        AddDebugLog("ProcessSingleFolder - æ‰¾åˆ°å…³è”ID: " . dbID . "ï¼Œæ­£åœ¨ç›´æ¥æ›´æ–° Database è¡¨...")
                        newHash := Crypt.Hash.Str(folderPath . folderState.totalSize . folderState.fileCount, "SHA256", "UTF-8")
                        newContent := "[æ–‡ä»¶å¤¹] æ–‡ä»¶æ•°é‡: " . folderState.fileCount . " | å¤§å°: " . sizeText . "`n" . folderPath

                        UpdateMainDBSQL := "UPDATE Database SET å“ˆå¸Œå€¼ = ?, å­—èŠ‚ = ?, å†…å®¹ = ?, å¤‡æ³¨ = ?, æ ‡ç­¾ = ?, å­—ç¬¦ = ?, è¡Œæ•° = ?, æ•°é‡ = ?, ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime') WHERE ID = ?;"
                        if (!SQLiteDB.ExecuteWithParams(UpdateMainDBSQL, [newHash, sizeText, newContent, folderName, folderName, folderState.fileCount, folderState.fileCount, folderState.fileCount, dbID])) {
                            ErrorMsg := SQLiteDB._ErrMsg()
                            AddDebugLog("ProcessSingleFolder - é”™è¯¯: ç›´æ¥æ›´æ–° Database è¡¨å¤±è´¥ - " . ErrorMsg)
                            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212661 æ›´æ–° Database è¡¨å¤±è´¥: %ErrorMsg%
                            RollbackSafeTransaction("ProcessSingleFolder")
                            Return false
                        } else {
                             AddDebugLog("ProcessSingleFolder - Database è¡¨æ›´æ–°æˆåŠŸã€‚")
                             FolderStates[folderPath] := folderState
                             FolderStates[folderPath].processedTime := A_Now
                        }
                    } else {
                        ; 4. å¦‚æœæ²¡æœ‰IDï¼ˆæ—§æ•°æ®ï¼‰ï¼Œåˆ™å›é€€åˆ°åˆ é™¤+æ’å…¥çš„é€»è¾‘ä»¥å®ç°å…¼å®¹
                        AddDebugLog("ProcessSingleFolder - æœªæ‰¾åˆ°å…³è”IDï¼Œå›é€€åˆ°åˆ é™¤/æ’å…¥é€»è¾‘ã€‚")

                        if (oldState.totalSize) {
                            oldHash := Crypt.Hash.Str(folderPath . oldState.totalSize . oldState.fileCount, "SHA256", "UTF-8")
                            DeleteSQL := "DELETE FROM Database WHERE å“ˆå¸Œå€¼ = ?;"
                            if (!SQLiteDB.ExecuteWithParams(DeleteSQL, [oldHash])) {
                                ErrorMsg := SQLiteDB._ErrMsg()
                                AddDebugLog("ProcessSingleFolder - è­¦å‘Š: åˆ é™¤æ—§æ–‡ä»¶å¤¹è®°å½•å¤±è´¥ (å“ˆå¸Œ: " . oldHash . ") - " . ErrorMsg)
                            } else {
                                AddDebugLog("ProcessSingleFolder - å·²ä» Database è¡¨åˆ é™¤æ—§è®°å½• (å“ˆå¸Œ: " . oldHash . ")ã€‚")
                            }
                        }

                        GlobalFileList := folderPath
                        GlobalComment := folderName
                        AddDebugLog("ProcessSingleFolder - æ­£åœ¨åŒæ­¥æ›´æ–°åçš„æ–‡ä»¶å¤¹åˆ° Database è¡¨...")
                        newID := SavePathMerged()
                        if (newID > 0) {
                            FolderStates[folderPath] := folderState
                            FolderStates[folderPath].processedTime := A_Now
                            AddDebugLog("ProcessSingleFolder - åŒæ­¥æˆåŠŸï¼Œè·å¾—æ–°ID: " . newID)

                            UpdateLinkSQL := "UPDATE æ³¨å†Œç™»è®°è·¯å¾„ SET ID = ?, ä¸»è¡¨åç§° = 'Database' WHERE è·¯å¾„ = ?;"
                            if (!SQLiteDB.ExecuteWithParams(UpdateLinkSQL, [newID, folderPath])) {
                                ErrorMsg := SQLiteDB._ErrMsg()
                                AddDebugLog("ProcessSingleFolder - é”™è¯¯: å…³è”æ›´æ–°åæ–‡ä»¶å¤¹è®°å½•IDå¤±è´¥ - " . ErrorMsg)
                            } else {
                                AddDebugLog("ProcessSingleFolder - æˆåŠŸå…³è”ID " . newID . " åˆ°è·¯å¾„ " . folderPath)
                            }
                        } else {
                            AddDebugLog("ProcessSingleFolder - é”™è¯¯: åŒæ­¥å¤±è´¥ï¼Œæœªè·å¾—æ–°IDã€‚")
                        }
                    }
                } else {
                    AddDebugLog("ProcessSingleFolder - æ–‡ä»¶å¤¹çŠ¶æ€æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°: " . folderPath)
                }
            }

            if (!CommitSafeTransaction("ProcessSingleFolder")) {
                ErrorMsg := SQLiteDB._ErrMsg()
                AddDebugLog("ProcessSingleFolder - é”™è¯¯: æäº¤äº‹åŠ¡å¤±è´¥ - " . ErrorMsg)
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212640 æäº¤äº‹åŠ¡å¤±è´¥: %ErrorMsg%
                RollbackSafeTransaction("ProcessSingleFolder")
                Return false
            }
        } catch e {
            ErrorMsg := e.Message
            AddDebugLog("ProcessSingleFolder - å¼‚å¸¸: " . ErrorMsg)
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212641 ProcessSingleFolderå¼‚å¸¸: %ErrorMsg%
            RollbackSafeTransaction("ProcessSingleFolder")
            Return false
        }
    } else if (ProcessingContext = "Clipboard") {
        ProcessFolderToHistoryTable(folderPath)
    }

    AddDebugLog("ProcessSingleFolder - å¤„ç†å®Œæˆ: " . folderPath)
    Return true
}

; ===========================================
; å¤„ç†å•ä¸ªæ–‡ä»¶
; ===========================================
ProcessSingleFile(filePath) {
    Global SQLiteDB, DBPath, FolderStates, ProcessingContext
    AddDebugLog("ProcessSingleFile - å¼€å§‹å¤„ç†æ–‡ä»¶: " . filePath)

    if (!FileExist(filePath) || InStr(FileExist(filePath), "D")) {
        AddDebugLog("ProcessSingleFile - æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç›®å½•: " . filePath)
        Return false
    }

    if (!CheckDBUnlocked(DBPath)) {
        AddDebugLog("ProcessSingleFile - é”™è¯¯: æ•°æ®åº“è¢«é”å®šã€‚")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212505 æ•°æ®åº“è¢«é”å®š
        Return false
    }

    if (!SQLiteDB) {
        SQLiteDB := New SQLiteDB()
        if (!SQLiteDB.OpenDB(DBPath)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            AddDebugLog("ProcessSingleFile - é”™è¯¯: æ‰“å¼€æ•°æ®åº“å¤±è´¥ - " . ErrorMsg)
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4122461 æ‰“å¼€æ•°æ®åº“å¤±è´¥: %ErrorMsg%
            Return false
        }
    }

    FileGetSize, fileSize, %filePath%
    FileGetTime, fileTime, %filePath%, M
    SplitPath, filePath, fileName, , fileExt

    Identifier := GetFileTypeSymbol(filePath, fileExt)
    sizeText := FormatSize(fileSize)
    AddDebugLog("ProcessSingleFile - æ–‡ä»¶çŠ¶æ€: " . fileName . ", å¤§å°: " . sizeText)

    try {
        if (ProcessingContext = "WatchDir") {
            transactionStarted := BeginSafeTransaction("ProcessSingleFile")
            if (!transactionStarted) {
                AddDebugLog("ProcessSingleFile - é”™è¯¯: äº‹åŠ¡å¼€å¯å¤±è´¥ã€‚")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212510 äº‹åŠ¡å¼€å§‹å¤±è´¥
                Return false
            }

            try {
                ; æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦å·²ç™»è®°
                CheckFileSQL := "SELECT Local_ID FROM æ³¨å†Œç™»è®°è·¯å¾„ WHERE è·¯å¾„ = ?;"
                CheckFileResult := {}
                if (!SQLiteDB.GetTable(CheckFileSQL, CheckFileResult, [filePath])) {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("ProcessSingleFile - é”™è¯¯: æŸ¥è¯¢æ–‡ä»¶ç™»è®°çŠ¶æ€å¤±è´¥ - " . ErrorMsg)
                    MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212511 æŸ¥è¯¢æ–‡ä»¶å¤±è´¥: %ErrorMsg%
                    RollbackSafeTransaction("ProcessSingleFile")
                    Return false
                }

                if (CheckFileResult.RowCount = 0) {
                    AddDebugLog("ProcessSingleFile - æ–°æ–‡ä»¶ï¼Œæœªç™»è®°ï¼Œæ­£åœ¨å¤„ç†: " . filePath)
                    ; === è·¯å¾„æœªç™»è®°ï¼Œéœ€è¦å¤„ç† ===

                    ; 1. å…ˆç™»è®°è·¯å¾„ï¼ˆLocal_ID è‡ªå¢ï¼Œä¸éœ€è¦æ‰‹åŠ¨æŒ‡å®šï¼‰
                    InsertFileSQL := "INSERT INTO æ³¨å†Œç™»è®°è·¯å¾„ (æ ‡è¯†, æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶åç§°, è·¯å¾„, æ–‡ä»¶å¤¹å¤§å°, è¯¦ç»†èµ„æ–™, æ–‡ä»¶æ•°é‡, è®¿é—®æ—¶é—´) VALUES (?, ?, ?, ?, ?, ?, datetime('now', 'localtime'));"
                    InsertSuccess := false
                    if (SQLiteDB.ExecuteWithParams) {
                        InsertSuccess := SQLiteDB.ExecuteWithParams(InsertFileSQL, [Identifier, fileName, filePath, sizeText, filePath, 1])
                    } else {
                        EscapedIdentifier := StrReplace(Identifier, "'", "''")
                        EscapedFileName := StrReplace(fileName, "'", "''")
                        EscapedFilePath := StrReplace(filePath, "'", "''")
                        EscapedSizeText := StrReplace(sizeText, "'", "''")
                        FallbackSQL := "INSERT INTO æ³¨å†Œç™»è®°è·¯å¾„ (æ ‡è¯†, æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶åç§°, è·¯å¾„, æ–‡ä»¶å¤¹å¤§å°, è¯¦ç»†èµ„æ–™, æ–‡ä»¶æ•°é‡, è®¿é—®æ—¶é—´) VALUES ('" . EscapedIdentifier . "', '" . EscapedFileName . "', '" . EscapedFilePath . "', '" . EscapedSizeText . "', '" . EscapedFilePath . "', 1, datetime('now', 'localtime'));"
                        InsertSuccess := SQLiteDB.Exec(FallbackSQL)
                    }

                    if (!InsertSuccess) {
                        ErrorMsg := SQLiteDB._ErrMsg()
                        AddDebugLog("ProcessSingleFile - é”™è¯¯: ç™»è®°æ–°æ–‡ä»¶å¤±è´¥ - " . ErrorMsg)
                        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212530 ç™»è®°æ–‡ä»¶å¤±è´¥: %ErrorMsg%
                        RollbackSafeTransaction("ProcessSingleFile")
                        Return false
                    }

                    ; 2. ä¿å­˜çŠ¶æ€
                    FolderStates[filePath] := {totalSize: fileSize, lastModified: fileTime, fileCount: 1, fileList: filePath}

                    ; 3. åŒæ­¥åˆ°Databaseä¸»è¡¨ï¼ˆè¿™æ‰æ˜¯çœŸæ­£çš„æ•°æ®ï¼‰
                    AddDebugLog("ProcessSingleFile - æ­£åœ¨åŒæ­¥æ–°æ–‡ä»¶åˆ° Database è¡¨...")
                    newID := ProcessFileToDatabase(filePath, fileName, fileExt, fileSize)
                    if (newID > 0) {
                        AddDebugLog("ProcessSingleFile - åŒæ­¥æˆåŠŸï¼Œè·å¾—æ–°ID: " . newID)

                        ; 4. å°†æ–°IDæ›´æ–°å›æ³¨å†Œç™»è®°è·¯å¾„è¡¨
                        UpdateLinkSQL := "UPDATE æ³¨å†Œç™»è®°è·¯å¾„ SET ID = ?, ä¸»è¡¨åç§° = 'Database' WHERE è·¯å¾„ = ?;"
                        if (!SQLiteDB.ExecuteWithParams(UpdateLinkSQL, [newID, filePath])) {
                            ErrorMsg := SQLiteDB._ErrMsg()
                            AddDebugLog("ProcessSingleFile - é”™è¯¯: å…³è”æ–°æ–‡ä»¶è®°å½•IDå¤±è´¥ - " . ErrorMsg)
                        } else {
                            AddDebugLog("ProcessSingleFile - æˆåŠŸå…³è”ID " . newID . " åˆ°è·¯å¾„ " . filePath)
                        }
                    } else {
                        AddDebugLog("ProcessSingleFile - é”™è¯¯: åŒæ­¥å¤±è´¥ï¼Œæœªè·å¾—æ–°IDã€‚")
                    }

                } else {
                    ; === è·¯å¾„å·²ç™»è®°ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–° ===
                    needsUpdate := false
                    oldState := {}
                    if (!FolderStates.HasKey(filePath)) {
                        needsUpdate := true
                        AddDebugLog("ProcessSingleFile - æ–‡ä»¶å·²ç™»è®°ï¼Œä½†æ— ç¼“å­˜çŠ¶æ€ï¼Œéœ€è¦æ›´æ–°ã€‚")
                    } else {
                        oldState := FolderStates[filePath]
                        if (fileSize != oldState.totalSize || fileTime != oldState.lastModified) {
                            needsUpdate := true
                            AddDebugLog("ProcessSingleFile - æ–‡ä»¶çŠ¶æ€å˜åŒ–ï¼Œéœ€è¦æ›´æ–°ã€‚æ—§çŠ¶æ€: å¤§å° " . oldState.totalSize . "å­—èŠ‚ã€‚æ–°çŠ¶æ€: å¤§å° " . fileSize . "å­—èŠ‚ã€‚")
                        }
                    }

                    if (needsUpdate) {
                        AddDebugLog("ProcessSingleFile - æ­£åœ¨æ›´æ–°å·²ç™»è®°çš„æ–‡ä»¶ä¿¡æ¯: " . filePath)

                        ; 1. å…ˆä»ç™»è®°è¡¨è·å–ä¸»è¡¨ID
                        GetIDSQL := "SELECT ID FROM æ³¨å†Œç™»è®°è·¯å¾„ WHERE è·¯å¾„ = ?;"
                        IDResult := {}
                        dbID := 0
                        if (SQLiteDB.GetTable(GetIDSQL, IDResult, [filePath]) && IDResult.RowCount > 0) {
                            dbID := IDResult.Rows[1][1]
                        }

                        ; 2. æ›´æ–°æ³¨å†Œç™»è®°è·¯å¾„è¡¨
                        UpdateRegisterSQL := "UPDATE æ³¨å†Œç™»è®°è·¯å¾„ SET æ ‡è¯† = ?, æ–‡ä»¶å¤¹æˆ–æ–‡ä»¶åç§° = ?, æ–‡ä»¶å¤¹å¤§å° = ?, è¯¦ç»†èµ„æ–™ = ?, æ–‡ä»¶æ•°é‡ = 1, è®¿é—®æ—¶é—´ = datetime('now', 'localtime') WHERE è·¯å¾„ = ?;"
                        if (!SQLiteDB.ExecuteWithParams(UpdateRegisterSQL, [Identifier, fileName, sizeText, filePath, filePath])) {
                            ErrorMsg := SQLiteDB._ErrMsg()
                            AddDebugLog("ProcessSingleFile - é”™è¯¯: æ›´æ–°æ–‡ä»¶ç™»è®°ä¿¡æ¯å¤±è´¥ - " . ErrorMsg)
                            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212560 æ›´æ–°æ–‡ä»¶ç™»è®°å¤±è´¥: %ErrorMsg%
                            RollbackSafeTransaction("ProcessSingleFile")
                            Return false
                        }

                        if (dbID > 0) {
                            ; 3. å¦‚æœæœ‰IDï¼Œç›´æ¥æ›´æ–°Databaseä¸»è¡¨
                            AddDebugLog("ProcessSingleFile - æ‰¾åˆ°å…³è”ID: " . dbID . "ï¼Œæ­£åœ¨ç›´æ¥æ›´æ–° Database è¡¨...")
                            newHash := Crypt.Hash.Str(filePath . fileSize, "SHA256", "UTF-8")
                            newContent := "[æ–‡ä»¶] " . fileName . " | å¤§å°: " . sizeText
                            baseFileName := fileName
                            if (fileExt != "") {
                                baseFileName := SubStr(fileName, 1, StrLen(fileName) - StrLen(fileExt) - 1)
                            }

                            UpdateMainDBSQL := "UPDATE Database SET å“ˆå¸Œå€¼ = ?, å­—èŠ‚ = ?, å†…å®¹ = ?, å¤‡æ³¨ = ?, æ ‡ç­¾ = ?, ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime') WHERE ID = ?;"
                            if (!SQLiteDB.ExecuteWithParams(UpdateMainDBSQL, [newHash, sizeText, newContent, fileName, baseFileName, dbID])) {
                                ErrorMsg := SQLiteDB._ErrMsg()
                                AddDebugLog("ProcessSingleFile - é”™è¯¯: ç›´æ¥æ›´æ–° Database è¡¨å¤±è´¥ - " . ErrorMsg)
                                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212561 æ›´æ–° Database è¡¨å¤±è´¥: %ErrorMsg%
                                RollbackSafeTransaction("ProcessSingleFile")
                                Return false
                            } else {
                                AddDebugLog("ProcessSingleFile - Database è¡¨æ›´æ–°æˆåŠŸã€‚")
                                FolderStates[filePath] := {totalSize: fileSize, lastModified: fileTime, fileCount: 1, fileList: filePath}
                            }
                        } else {
                            ; 4. å¦‚æœæ²¡æœ‰IDï¼ˆæ—§æ•°æ®ï¼‰ï¼Œåˆ™å›é€€åˆ°åˆ é™¤+æ’å…¥çš„é€»è¾‘ä»¥å®ç°å…¼å®¹
                            AddDebugLog("ProcessSingleFile - æœªæ‰¾åˆ°å…³è”IDï¼Œå›é€€åˆ°åˆ é™¤/æ’å…¥é€»è¾‘ã€‚")

                            if (oldState.totalSize) {
                                oldHash := Crypt.Hash.Str(filePath . oldState.totalSize, "SHA256", "UTF-8")
                                DeleteSQL := "DELETE FROM Database WHERE å“ˆå¸Œå€¼ = ?;"
                                if (!SQLiteDB.ExecuteWithParams(DeleteSQL, [oldHash])) {
                                    ErrorMsg := SQLiteDB._ErrMsg()
                                    AddDebugLog("ProcessSingleFile - è­¦å‘Š: åˆ é™¤æ—§æ–‡ä»¶è®°å½•å¤±è´¥ (å“ˆå¸Œ: " . oldHash . ") - " . ErrorMsg)
                                } else {
                                    AddDebugLog("ProcessSingleFile - å·²ä» Database è¡¨åˆ é™¤æ—§è®°å½• (å“ˆå¸Œ: " . oldHash . ")ã€‚")
                                }
                            }

                            newID := ProcessFileToDatabase(filePath, fileName, fileExt, fileSize)
                            if (newID > 0) {
                                FolderStates[filePath] := {totalSize: fileSize, lastModified: fileTime, fileCount: 1, fileList: filePath}
                                AddDebugLog("ProcessSingleFile - åŒæ­¥æ›´æ–°æˆåŠŸï¼Œè·å¾—æ–°ID: " . newID)

                                UpdateLinkSQL := "UPDATE æ³¨å†Œç™»è®°è·¯å¾„ SET ID = ?, ä¸»è¡¨åç§° = 'Database' WHERE è·¯å¾„ = ?;"
                                if (!SQLiteDB.ExecuteWithParams(UpdateLinkSQL, [newID, filePath])) {
                                    ErrorMsg := SQLiteDB._ErrMsg()
                                    AddDebugLog("ProcessSingleFile - é”™è¯¯: å…³è”æ›´æ–°åæ–‡ä»¶è®°å½•IDå¤±è´¥ - " . ErrorMsg)
                                } else {
                                    AddDebugLog("ProcessSingleFile - æˆåŠŸå…³è”ID " . newID . " åˆ°è·¯å¾„ " . filePath)
                                }
                            } else {
                                AddDebugLog("ProcessSingleFile - é”™è¯¯: åŒæ­¥æ›´æ–°å¤±è´¥ï¼Œæœªè·å¾—æ–°IDã€‚")
                            }
                        }
                    } else {
                        AddDebugLog("ProcessSingleFile - æ–‡ä»¶çŠ¶æ€æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°: " . filePath)
                    }
                }

                if (!CommitSafeTransaction("ProcessSingleFile")) {
                    ErrorMsg := SQLiteDB._ErrMsg()
                    AddDebugLog("ProcessSingleFile - é”™è¯¯: æäº¤äº‹åŠ¡å¤±è´¥ - " . ErrorMsg)
                    MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212540 æäº¤äº‹åŠ¡å¤±è´¥: %ErrorMsg%
                    RollbackSafeTransaction("ProcessSingleFile")
                    Return false
                }
            } catch e {
                ErrorMsg := e.Message
                AddDebugLog("ProcessSingleFile - å†…éƒ¨å¼‚å¸¸: " . ErrorMsg)
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212541 ProcessSingleFileå¼‚å¸¸: %ErrorMsg%
                RollbackSafeTransaction("ProcessSingleFile")
                Return false
            }
        } else if (ProcessingContext = "Clipboard") {
            ProcessFileToHistoryTable(filePath, fileName, fileExt, fileSize)
        }
    } catch e {
        eMessage := e.Message
        AddDebugLog("ProcessSingleFile - å¤–éƒ¨å¼‚å¸¸: " . eMessage)
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212580 ProcessSingleFileå¼‚å¸¸: %eMessage%
        if (TransactionActive && TransactionOwner = "ProcessSingleFile") {
            RollbackSafeTransaction("ProcessSingleFile")
        }
        Return false
    }
    AddDebugLog("ProcessSingleFile - å¤„ç†å®Œæˆ: " . filePath)
    Return true
}

; ===========================================
; è¾…åŠ©å‡½æ•°
; ===========================================

RegisterAndValidateFolders() {
    Global SQLiteDB
    try {
        CheckFoldersSQL := "SELECT è·¯å¾„, è¯¦ç»†èµ„æ–™ FROM æ³¨å†Œç™»è®°è·¯å¾„;"
        CheckFoldersResult := {}
        if (SQLiteDB.GetTable(CheckFoldersSQL, CheckFoldersResult) && CheckFoldersResult.RowCount >= 1) {
            Loop, % CheckFoldersResult.RowCount {
                path := CheckFoldersResult.Rows[A_Index][1]
                details := CheckFoldersResult.Rows[A_Index][2]
                if (!FileExist(path)) {
                    DeleteSQL := "DELETE FROM æ³¨å†Œç™»è®°è·¯å¾„ WHERE è·¯å¾„ = ?;"
                    if (!SQLiteDB.ExecuteWithParams(DeleteSQL, [path])) {
                        ErrorMsg := SQLiteDB._ErrMsg()
                        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212117 åˆ é™¤æ— æ•ˆè·¯å¾„å¤±è´¥: %ErrorMsg%
                    }
                    continue
                }
                if (InStr(FileExist(path), "D") && details != "") {
                    validDetails := ""
                    StringSplit, fileList, details, `n
                    Loop, %fileList0% {
                        filePath := fileList%A_Index%
                        if (FileExist(filePath) && !InStr(FileExist(filePath), "D")) {
                            validDetails .= (validDetails = "" ? "" : "`n") . filePath
                        }
                    }
                    if (validDetails != details) {
                        UpdateDetailsSQL := "UPDATE æ³¨å†Œç™»è®°è·¯å¾„ SET è¯¦ç»†èµ„æ–™ = ? WHERE è·¯å¾„ = ?;"
                        if (!SQLiteDB.ExecuteWithParams(UpdateDetailsSQL, [validDetails, path])) {
                            ErrorMsg := SQLiteDB._ErrMsg()
                            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212118 æ›´æ–°æ–‡ä»¶å¤¹è¯¦ç»†èµ„æ–™å¤±è´¥: %ErrorMsg%
                        }
                    }
                }
            }
        }
    } catch e {
        eMessage := e.Message
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212119 RegisterAndValidateFolderså¼‚å¸¸: %eMessage%
    }
}

GetFolderState(folderPath) {
    state := {}
    state.fileCount := 0
    state.totalSize := 0
    state.lastModified := 0
    state.fileList := ""

    Loop, Files, %folderPath%\*, F
    {
        filePath := A_LoopFileFullPath
        if (FileExist(filePath) && !InStr(FileExist(filePath), "D")) {
            state.fileList .= (state.fileList = "" ? "" : "`n") . filePath
            state.fileCount++

            FileGetSize, fileSize, %filePath%
            if (fileSize != "") {
                state.totalSize += fileSize
            }

            FileGetTime, fileTime, %filePath%, M
            if (fileTime > state.lastModified) {
                state.lastModified := fileTime
            }
        }
    }

    Return state
}

FormatSize(size) {
    if (size >= 1073741824)
        Return Round(size / 1073741824, 1) . " GB"
    else if (size >= 1048576)
        Return Round(size / 1048576, 1) . " MB"
    else if (size >= 1024)
        Return Round(size / 1024, 1) . " KB"
    else if (size > 0)
        Return size . " B"
    else
        Return "0 B"
}

; ===========================================
; å¤„ç†æ–‡ä»¶å¤¹åˆ°å†å²æ•°æ®è¡¨
; ===========================================
ProcessFolderToHistoryTable(folderPath) {
    Global SQLiteDB

    SplitPath, folderPath, folderName
    folderState := GetFolderState(folderPath)
    totalSize := folderState.totalSize
    validFiles := folderState.fileCount
    sizeText := FormatSize(totalSize)

    WinGet, ActiveID, ID, A
    WinGetTitle, WindowTitle, ahk_id %ActiveID%
    SourceWindow := WindowTitle ? WindowTitle : "æœªçŸ¥çª—å£"

    Identifier := "ğŸ“"
    Format := "ğŸ“"
    Tag := ""
    PathOrLink := folderState.fileList
    Content := "[æ–‡ä»¶å¤¹] æ–‡ä»¶æ•°é‡: " . validFiles . " | å¤§å°: " . sizeText . "`n" . folderPath
    Remark := folderName
    HashValue := Crypt.Hash.Str(folderPath . totalSize . validFiles, "SHA256", "UTF-8")

    CheckHashSQL := "SELECT 1 FROM å†å²æ•°æ® WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
    CheckHashResult := {}
    if (SQLiteDB.GetTable(CheckHashSQL, CheckHashResult, [HashValue]) && CheckHashResult.RowCount >= 1) {
        Return false
    }

    transactionStarted := BeginSafeTransaction("ProcessFolderToHistoryTable")

    try {
        InsertSQL := "INSERT INTO å†å²æ•°æ® (å“ˆå¸Œå€¼, å­—èŠ‚, æ•°æ®æ¥æºçª—å£, æ ‡ç­¾, æ ‡è¯†, ç±»å‹) VALUES (?, ?, ?, ?, ?, ?);"
        InsertSuccess := false
        if (SQLiteDB.ExecuteWithParams) {
            InsertSuccess := SQLiteDB.ExecuteWithParams(InsertSQL, [HashValue, sizeText, SourceWindow, Tag, Identifier, Format])
        } else {
            EscapedHashValue := StrReplace(HashValue, "'", "''")
            EscapedSizeText := StrReplace(sizeText, "'", "''")
            EscapedSourceWindow := StrReplace(SourceWindow, "'", "''")
            EscapedTag := StrReplace(Tag, "'", "''")
            EscapedIdentifier := StrReplace(Identifier, "'", "''")
            EscapedFormat := StrReplace(Format, "'", "''")
            FallbackSQL := "INSERT INTO å†å²æ•°æ® (å“ˆå¸Œå€¼, å­—èŠ‚, æ•°æ®æ¥æºçª—å£, æ ‡ç­¾, æ ‡è¯†, ç±»å‹) VALUES ('" . EscapedHashValue . "', '" . EscapedSizeText . "', '" . EscapedSourceWindow . "', '" . EscapedTag . "', '" . EscapedIdentifier . "', '" . EscapedFormat . "');"
            InsertSuccess := SQLiteDB.Exec(FallbackSQL)
        }

        if (!InsertSuccess) {
            ErrorMsg := SQLiteDB._ErrMsg()
            if (transactionStarted) {
                RollbackSafeTransaction("ProcessFolderToHistoryTable")
            }
            Return false
        }

        LastID := 0
        if (SQLiteDB.GetTable("SELECT last_insert_rowid();", Result)) {
            LastID := Result.Rows[1][1]
        } else {
            ErrorMsg := SQLiteDB._ErrMsg()
            if (transactionStarted) {
                RollbackSafeTransaction("ProcessFolderToHistoryTable")
            }
            Return false
        }

        UpdateSQL := "UPDATE å†å²æ•°æ® SET å¤‡æ³¨ = ?, å†…å®¹ = ?, [è·¯å¾„/é“¾æ¥] = ?, ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime') WHERE ID = ?;"
        UpdateSuccess := false
        if (SQLiteDB.ExecuteWithParams) {
            UpdateSuccess := SQLiteDB.ExecuteWithParams(UpdateSQL, [Remark, Content, PathOrLink, LastID])
        } else {
            EscapedRemark := StrReplace(Remark, "'", "''")
            EscapedContent := StrReplace(Content, "'", "''")
            EscapedPathOrLink := StrReplace(PathOrLink, "'", "''")
            FallbackSQL := "UPDATE å†å²æ•°æ® SET å¤‡æ³¨ = '" . EscapedRemark . "', å†…å®¹ = '" . EscapedContent . "', [è·¯å¾„/é“¾æ¥] = '" . EscapedPathOrLink . "', ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime') WHERE ID = " . LastID . ";"
            UpdateSuccess := SQLiteDB.Exec(FallbackSQL)
        }

        if (!UpdateSuccess) {
            ErrorMsg := SQLiteDB._ErrMsg()
            if (transactionStarted) {
                RollbackSafeTransaction("ProcessFolderToHistoryTable")
            }
            Return false
        }

        if (transactionStarted && !CommitSafeTransaction("ProcessFolderToHistoryTable")) {
            ErrorMsg := SQLiteDB._ErrMsg()
            RollbackSafeTransaction("ProcessFolderToHistoryTable")
            Return false
        }

        SB_SetText("å·²ä¿å­˜æ–‡ä»¶å¤¹åˆ°å†å²æ•°æ®è¡¨ - æ–‡ä»¶å¤¹: " . folderName)
    } catch e {
        ErrorMsg := e.message
        if (transactionStarted) {
            RollbackSafeTransaction("ProcessFolderToHistoryTable")
        }
        Return false
    }

    Return true
}

; ===========================================
; å¤„ç†æ–‡ä»¶åˆ°å†å²æ•°æ®è¡¨
; ===========================================
ProcessFileToHistoryTable(filePath, fileName, fileExt, fileSize) {
    Global SQLiteDB

    sizeText := FormatSize(fileSize)
    Identifier := GetFileTypeSymbol(filePath, fileExt)
    musicExts := "mp3,aac,m4a,ogg,flac,alac,ape,wav,aiff,dsf,dff,mid"
    Format := (InStr(musicExts, fileExt) || (fileExt = "m4a" && InStr(filePath, "ALAC"))) ? ("ğŸ“, " . Identifier . ", " . fileExt) : ("ğŸ“, " . (fileExt ? fileExt : "unknown"))

    WinGet, ActiveID, ID, A
    WinGetTitle, WindowTitle, ahk_id %ActiveID%
    SourceWindow := WindowTitle ? WindowTitle : "æœªçŸ¥çª—å£"

    Tag := ""
    PathOrLink := filePath
    Content := "[æ–‡ä»¶] " . fileName . " | å¤§å°: " . sizeText
    Remark := fileName
    HashValue := Crypt.Hash.Str(filePath . fileSize, "SHA256", "UTF-8")

    CheckHashSQL := "SELECT 1 FROM å†å²æ•°æ® WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
    CheckHashResult := {}
    if (SQLiteDB.GetTable(CheckHashSQL, CheckHashResult, [HashValue]) && CheckHashResult.RowCount >= 1) {
        Return false
    }

    transactionStarted := BeginSafeTransaction("ProcessFileToHistoryTable")

    try {
        InsertSQL := "INSERT INTO å†å²æ•°æ® (å“ˆå¸Œå€¼, å­—èŠ‚, æ•°æ®æ¥æºçª—å£, æ ‡ç­¾, æ ‡è¯†, ç±»å‹) VALUES (?, ?, ?, ?, ?, ?);"
        InsertSuccess := false
        if (SQLiteDB.ExecuteWithParams) {
            InsertSuccess := SQLiteDB.ExecuteWithParams(InsertSQL, [HashValue, sizeText, SourceWindow, Tag, Identifier, Format])
        } else {
            EscapedHashValue := StrReplace(HashValue, "'", "''")
            EscapedSizeText := StrReplace(sizeText, "'", "''")
            EscapedSourceWindow := StrReplace(SourceWindow, "'", "''")
            EscapedTag := StrReplace(Tag, "'", "''")
            EscapedIdentifier := StrReplace(Identifier, "'", "''")
            EscapedFormat := StrReplace(Format, "'", "''")
            FallbackSQL := "INSERT INTO å†å²æ•°æ® (å“ˆå¸Œå€¼, å­—èŠ‚, æ•°æ®æ¥æºçª—å£, æ ‡ç­¾, æ ‡è¯†, ç±»å‹) VALUES ('" . EscapedHashValue . "', '" . EscapedSizeText . "', '" . EscapedSourceWindow . "', '" . EscapedTag . "', '" . EscapedIdentifier . "', '" . EscapedFormat . "');"
            InsertSuccess := SQLiteDB.Exec(FallbackSQL)
        }

        if (!InsertSuccess) {
            ErrorMsg := SQLiteDB._ErrMsg()
            if (transactionStarted) {
                RollbackSafeTransaction("ProcessFileToHistoryTable")
            }
            Return false
        }

        LastID := 0
        if (SQLiteDB.GetTable("SELECT last_insert_rowid();", Result)) {
            LastID := Result.Rows[1][1]
        } else {
            ErrorMsg := SQLiteDB._ErrMsg()
            if (transactionStarted) {
                RollbackSafeTransaction("ProcessFileToHistoryTable")
            }
            Return false
        }

        UpdateSQL := "UPDATE å†å²æ•°æ® SET å¤‡æ³¨ = ?, å†…å®¹ = ?, [è·¯å¾„/é“¾æ¥] = ?, ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime') WHERE ID = ?;"
        UpdateSuccess := false
        if (SQLiteDB.ExecuteWithParams) {
            UpdateSuccess := SQLiteDB.ExecuteWithParams(UpdateSQL, [Remark, Content, PathOrLink, LastID])
        } else {
            EscapedRemark := StrReplace(Remark, "'", "''")
            EscapedContent := StrReplace(Content, "'", "''")
            EscapedPathOrLink := StrReplace(PathOrLink, "'", "''")
            FallbackSQL := "UPDATE å†å²æ•°æ® SET å¤‡æ³¨ = '" . EscapedRemark . "', å†…å®¹ = '" . EscapedContent . "', [è·¯å¾„/é“¾æ¥] = '" . EscapedPathOrLink . "', ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime') WHERE ID = " . LastID . ";"
            UpdateSuccess := SQLiteDB.Exec(FallbackSQL)
        }

        if (!UpdateSuccess) {
            ErrorMsg := SQLiteDB._ErrMsg()
            if (transactionStarted) {
                RollbackSafeTransaction("ProcessFileToHistoryTable")
            }
            Return false
        }

        if (transactionStarted && !CommitSafeTransaction("ProcessFileToHistoryTable")) {
            ErrorMsg := SQLiteDB._ErrMsg()
            RollbackSafeTransaction("ProcessFileToHistoryTable")
            Return false
        }

        SB_SetText("å·²ä¿å­˜æ–‡ä»¶åˆ°å†å²æ•°æ®è¡¨ - æ–‡ä»¶: " . fileName)
    } catch e {
        ErrorMsg := e.message
        if (transactionStarted) {
            RollbackSafeTransaction("ProcessFileToHistoryTable")
        }
        Return false
    }

    Return true
}

; ===========================================
; å¤„ç†æ–‡ä»¶åˆ°Databaseè¡¨
; ===========================================
ProcessFileToDatabase(filePath, fileName, fileExt, fileSize) {
    Global SQLiteDB, FolderStates

    sizeText := FormatSize(fileSize)
    Identifier := GetFileTypeSymbol(filePath, fileExt)
    musicExts := "mp3,aac,m4a,ogg,flac,alac,ape,wav,aiff,dsf,dff,mid"
    Format := (InStr(musicExts, fileExt) || (fileExt = "m4a" && InStr(filePath, "ALAC"))) ? ("ğŸ“, " . Identifier . ", " . fileExt) : ("ğŸ“, " . (fileExt ? fileExt : "unknown"))
    textPreview := "[æ–‡ä»¶] " . fileName . " | å¤§å°: " . sizeText
    groupName := ""
    SplitPath, filePath, , dirPath
    SplitPath, dirPath, groupName
    if (groupName = "") {
        groupName := "é»˜è®¤åˆ†ç»„"
    }
    comment := fileName
    HashValue := Crypt.Hash.Str(filePath . fileSize, "SHA256", "UTF-8")

    baseFileName := fileName
    if (fileExt != "") {
        baseFileName := SubStr(fileName, 1, StrLen(fileName) - StrLen(fileExt) - 1)
    }

    CheckHashSQL := "SELECT ID FROM Database WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
    CheckHashResult := {}
    if (SQLiteDB.GetTable(CheckHashSQL, CheckHashResult, [HashValue]) && CheckHashResult.RowCount >= 1) {
        existingID := CheckHashResult.Rows[1][1]
        SB_SetText("æ–‡ä»¶å†…å®¹å·²å­˜åœ¨ (ID: " . existingID . ")ï¼Œè·³è¿‡æ’å…¥ï¼Œç›´æ¥å…³è”ã€‚")
        AddDebugLog("ProcessFileToDatabase - å“ˆå¸Œå€¼ " . HashValue . " å·²å­˜åœ¨ï¼Œå¯¹åº”ID: " . existingID . "ã€‚è·³è¿‡æ’å…¥ã€‚")
        Return existingID
    }

    transactionStarted := BeginSafeTransaction("ProcessFileToDatabase_Insert")

    InsertSQL := "INSERT INTO Database (å“ˆå¸Œå€¼, å­—èŠ‚, æ ‡ç­¾, æ ‡è¯†, ç±»å‹, åˆ†ç»„, å¤‡æ³¨, å†…å®¹, å­—ç¬¦, è¡Œæ•°, æ•°é‡, æ”¶è—, ç¦åˆ , åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 1, 1, 1, 1, 1, datetime('now', 'localtime'), datetime('now', 'localtime'));"
    InsertSuccess := false
    if (SQLiteDB.ExecuteWithParams) {
        InsertSuccess := SQLiteDB.ExecuteWithParams(InsertSQL, [HashValue, sizeText, baseFileName, Identifier, Format, groupName, comment, textPreview])
    } else {
        EscapedHashValue := StrReplace(HashValue, "'", "''")
        EscapedSizeText := StrReplace(sizeText, "'", "''")
        EscapedBaseFileName := StrReplace(baseFileName, "'", "''")
        EscapedIdentifier := StrReplace(Identifier, "'", "''")
        EscapedFormat := StrReplace(Format, "'", "''")
        EscapedGroupName := StrReplace(groupName, "'", "''")
        EscapedComment := StrReplace(comment, "'", "''")
        EscapedTextPreview := StrReplace(textPreview, "'", "''")
        FallbackSQL := "INSERT INTO Database (å“ˆå¸Œå€¼, å­—èŠ‚, æ ‡ç­¾, æ ‡è¯†, ç±»å‹, åˆ†ç»„, å¤‡æ³¨, å†…å®¹, å­—ç¬¦, è¡Œæ•°, æ•°é‡, æ”¶è—, ç¦åˆ , åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´) VALUES ('" . EscapedHashValue . "', '" . EscapedSizeText . "', '" . EscapedBaseFileName . "', '" . EscapedIdentifier . "', '" . EscapedFormat . "', '" . EscapedGroupName . "', '" . EscapedComment . "', '" . EscapedTextPreview . "', 1, 1, 1, 1, 1, datetime('now', 'localtime'), datetime('now', 'localtime'));"
        InsertSuccess := SQLiteDB.Exec(FallbackSQL)
    }

    if (!InsertSuccess) {
        ErrorMsg := SQLiteDB._ErrMsg()
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212552 %ErrorMsg%
        if (transactionStarted) {
            RollbackSafeTransaction("ProcessFileToDatabase_Insert")
        }
        Return 0
    }

    LastID := 0
    if (SQLiteDB.GetTable("SELECT last_insert_rowid();", Result)) {
        LastID := Result.Rows[1][1]
    }

    if (transactionStarted && !CommitSafeTransaction("ProcessFileToDatabase_Insert")) {
        ErrorMsg := SQLiteDB._ErrMsg()
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212553
        RollbackSafeTransaction("ProcessFileToDatabase_Insert")
        Return 0
    }

    SB_SetText("å·²ä¿å­˜æ–‡ä»¶è®°å½• - æ–‡ä»¶: " . fileName)
    Return LastID
}

; ===========================================
; SavePathMergedå‡½æ•°ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
; ===========================================
SavePathMerged() {
    Global SQLiteDB, ClipboardLock, retryCount, GlobalFileList, GlobalComment

    ; è¿™ä¸ªå‡½æ•°ç°åœ¨ä¸å†å¤„ç†å®šæ—¶é‡è¯•é€»è¾‘ï¼Œè°ƒç”¨æ–¹éœ€è¦ç¡®ä¿åœ¨è°ƒç”¨å‰ClipboardLockæ˜¯è§£é”çš„
    if (ClipboardLock) {
        AddDebugLog("SavePathMerged - è­¦å‘Š: ClipboardLock å·²è¢«é”å®šï¼Œè·³è¿‡æ‰§è¡Œã€‚")
        Return 0
    }
    ClipboardLock := 1

    folderPath := GlobalFileList
    GlobalFileList := ""

    if (folderPath = "" || !InStr(FileExist(folderPath), "D")) {
        ClipboardLock := 0
        Return 0
    }

    SplitPath, folderPath, folderName
    folderState := GetFolderState(folderPath)
    totalSize := folderState.totalSize
    validFiles := folderState.fileCount
    sizeText := FormatSize(totalSize)
    Identifier := "ğŸ“"
    Format := "ğŸ“"
    textPreview := "[æ–‡ä»¶å¤¹] æ–‡ä»¶æ•°é‡: " . validFiles . " | å¤§å°: " . sizeText . "`n" . folderPath
    groupName := ""
    SplitPath, folderPath, , parentPath
    SplitPath, parentPath, groupName
    if (groupName = "") {
        groupName := "é»˜è®¤åˆ†ç»„"
    }
    comment := GlobalComment ? GlobalComment : folderName
    HashValue := Crypt.Hash.Str(folderPath . totalSize . validFiles, "SHA256", "UTF-8")

    CheckHashSQL := "SELECT ID FROM Database WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
    CheckHashResult := {}
    if (SQLiteDB.GetTable(CheckHashSQL, CheckHashResult, [HashValue]) && CheckHashResult.RowCount >= 1) {
        existingID := CheckHashResult.Rows[1][1]
        SB_SetText("æ–‡ä»¶å¤¹å†…å®¹å·²å­˜åœ¨ (ID: " . existingID . ")ï¼Œè·³è¿‡æ’å…¥ï¼Œç›´æ¥å…³è”ã€‚")
        AddDebugLog("SavePathMerged - å“ˆå¸Œå€¼ " . HashValue . " å·²å­˜åœ¨ï¼Œå¯¹åº”ID: " . existingID . "ã€‚è·³è¿‡æ’å…¥ã€‚")
        ClipboardLock := 0
        Return existingID
    }

    transactionStarted := BeginSafeTransaction("SavePathMerged_Insert")

    InsertSQL := "INSERT INTO Database (å“ˆå¸Œå€¼, å­—èŠ‚, æ ‡ç­¾, æ ‡è¯†, ç±»å‹, åˆ†ç»„, å¤‡æ³¨, å†…å®¹, å­—ç¬¦, è¡Œæ•°, æ•°é‡, æ”¶è—, ç¦åˆ , åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 1, 1, datetime('now', 'localtime'), datetime('now', 'localtime'));"
    InsertSuccess := false
    if (SQLiteDB.ExecuteWithParams) {
        InsertSuccess := SQLiteDB.ExecuteWithParams(InsertSQL, [HashValue, sizeText, folderName, Identifier, Format, groupName, comment, textPreview, validFiles, validFiles, validFiles])
    } else {
        EscapedHashValue := StrReplace(HashValue, "'", "''")
        EscapedSizeText := StrReplace(sizeText, "'", "''")
        EscapedFolderName := StrReplace(folderName, "'", "''")
        EscapedIdentifier := StrReplace(Identifier, "'", "''")
        EscapedFormat := StrReplace(Format, "'", "''")
        EscapedGroupName := StrReplace(groupName, "'", "''")
        EscapedComment := StrReplace(comment, "'", "''")
        EscapedTextPreview := StrReplace(textPreview, "'", "''")
        FallbackSQL := "INSERT INTO Database (å“ˆå¸Œå€¼, å­—èŠ‚, æ ‡ç­¾, æ ‡è¯†, ç±»å‹, åˆ†ç»„, å¤‡æ³¨, å†…å®¹, å­—ç¬¦, è¡Œæ•°, æ•°é‡, æ”¶è—, ç¦åˆ , åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´) VALUES ('" . EscapedHashValue . "', '" . EscapedSizeText . "', '" . EscapedFolderName . "', '" . EscapedIdentifier . "', '" . EscapedFormat . "', '" . EscapedGroupName . "', '" . EscapedComment . "', '" . EscapedTextPreview . "', " . validFiles . ", " . validFiles . ", " . validFiles . ", 1, 1, datetime('now', 'localtime'), datetime('now', 'localtime'));"
        InsertSuccess := SQLiteDB.Exec(FallbackSQL)
    }

    if (!InsertSuccess) {
        ErrorMsg := SQLiteDB._ErrMsg()
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212201
        if (transactionStarted) {
            RollbackSafeTransaction("SavePathMerged_Insert")
        }
        ClipboardLock := 0
        Return 0
    }

    LastID := 0
    if (SQLiteDB.GetTable("SELECT last_insert_rowid();", Result)) {
        LastID := Result.Rows[1][1]
    }

    if (transactionStarted && !CommitSafeTransaction("SavePathMerged_Insert")) {
        ErrorMsg := SQLiteDB._ErrMsg()
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š212209
        RollbackSafeTransaction("SavePathMerged_Insert")
        ClipboardLock := 0
        Return 0
    }

    SB_SetText("å·²ä¿å­˜æ–‡ä»¶å¤¹è®°å½• - æ–‡ä»¶å¤¹: " . folderName)
    ClipboardLock := 0

    ; è¿”å›æ–°æ’å…¥çš„è®°å½•ID
    Return LastID
}

WriteData1014() {
    Global SQLiteDB, DBPath, ClipboardLock, ProcessingContext, g_CurrentRecord, ContentCache, G_last_insert_rowid
    AddDebugLog("[WriteData1014] å¼€å§‹")
    ClipboardLock := 1
    ProcessingContext := "WriteData1014"

    WinGetTitle, WindowTitle, A
    if (RegExMatch(WindowTitle, "(.+?)\s*-\s*(.+)$", Match)) {
        AppName := Trim(Match2)
    } else {
        AppName := WindowTitle ? WindowTitle : "æœªçŸ¥åº”ç”¨"
    }
    WindowDetail := WindowTitle ? WindowTitle : ""
    Group := ""  ; æ— åˆ†ç»„
    DataType := 1  ; æ–‡æœ¬
    Identifier := "" ; Identifier := "ğŸ“„"
    Format := "CF_UNICODETEXT,æ–‡æœ¬"

    FinalID := ""  ; ç”¨äºfinallyå’Œåˆ†ç±»å­—å…¸_Oneï¼ˆæœ€åä¸€ä¸ªIDï¼‰
    InsertedCount := 0
    FailedCount := 0
    try {
        if (!CheckDBUnlocked(DBPath)) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š455988 æ•°æ®åº“è¢«å ç”¨ï¼Œè¯·ç¨åå†è¯•
            AddDebugLog("[WriteData1014] æ•°æ®åº“è¢«å ç”¨")
            Return
        }

        if (!SQLiteDB) {
            SQLiteDB := New SQLiteDB()
            if (!SQLiteDB.OpenDB(DBPath)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š753594 æ•°æ®åº“æ‰“å¼€å¤±è´¥: %ErrorMsg%
                AddDebugLog("[WriteData1014] æ‰“å¼€æ•°æ®åº“å¤±è´¥: " . ErrorMsg)
                Return
            }
        }

        ; æ£€æŸ¥æ•°æ®æ”¶é›†è¡¨å’Œå…³è”è¡¨å­˜åœ¨ï¼ˆå‚è€ƒClipboardChangedï¼‰
        CheckSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ•°æ®æ”¶é›†';"
        CheckResult := {}
        if (!SQLiteDB.GetTable(CheckSQL, CheckResult) || CheckResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š233830 æ•°æ®æ”¶é›†è¡¨ä¸å­˜åœ¨ï¼
            AddDebugLog("[WriteData1014] æ•°æ®æ”¶é›†è¡¨ä¸å­˜åœ¨")
            Return
        }
        CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ•°æ®æ”¶é›†_å…³è”å±æ€§';"
        PropTableResult := {}
        if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5400063 æ•°æ®æ”¶é›†_å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            Return
        }
        CheckAssocTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='å…³è”å±æ€§è¡¨';"
        AssocTableResult := {}
        if (!SQLiteDB.GetTable(CheckAssocTableSQL, AssocTableResult) || AssocTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š7531900 å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            Return
        }

        GetColumnsSQL := "PRAGMA table_info(æ•°æ®æ”¶é›†);"
        ColumnsResult := {}
        RequiredFields := ["å¤‡æ³¨", "å†…å®¹", "ç½®é¡¶", "ç½®é¡¶ç´¢å¼•", "æ”¶è—", "ç¦åˆ ", "æ˜Ÿçº§", "æ ‡ç­¾", "åˆ†ç»„", "ç±»å‹", "åˆ›å»ºæ—¶é—´", "ä¿®æ”¹æ—¶é—´", "è®¿é—®æ—¶é—´", "è®¿é—®æ¬¡æ•°", "æ›´æ–°æ¬¡æ•°", "å­—èŠ‚", "å­—ç¬¦", "è¡Œæ•°", "æ•°é‡", "æ ‡è¯†", "çª—å£è¯¦æƒ…", "åº”ç”¨åç§°", "å“ˆå¸Œå€¼", "æ’åº", "æ ‡è®°çŠ¶æ€"]
        MissingFields := []
        if (SQLiteDB.GetTable(GetColumnsSQL, ColumnsResult)) {
            ExistingColumns := []
            Loop, % ColumnsResult.RowCount {
                ExistingColumns.Insert(ColumnsResult.Rows[A_Index][2])
            }
            for index, field in RequiredFields {
                if (!ArrayContains(ExistingColumns, field)) {
                    MissingFields.Insert(field)
                }
            }
            if (MissingFields.MaxIndex() > 0) {
                MissingFieldsList := Join(MissingFields, ", ")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š2741609 æ•°æ®æ”¶é›†è¡¨ç¼ºå°‘å¿…è¦å­—æ®µï¼š%MissingFieldsList%
                Return
            }
        } else {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1840275 æŸ¥è¯¢è¡¨ç»“æ„å¤±è´¥: %ErrorMsg%
            Return
        }

        Sleep, 100  ; é˜²å¡é¡¿ï¼Œå‚è€ƒClipboardChanged

        if (!BeginSafeTransaction("WriteData1014-Batch")) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1928523 å¼€å§‹æ‰¹é‡äº‹åŠ¡å¤±è´¥ï¼
            Return
        }

        ; å¤„ç†ContentCacheä¸­çš„æ¯ä¸ªå†…å®¹ï¼ˆæŒ‰è¡Œå­˜å‚¨ï¼Œç»Ÿä¸€äº‹åŠ¡å†…ï¼‰
        for index, ClipData in ContentCache {
            ; æ¸…ç†å†…å®¹
            ClipData := RegExReplace(ClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", "")
            ClipData := Trim(ClipData)
            if (ClipData = "" || StrLen(ClipData) > 5000000) {
                FailedCount++
                continue
            }

            ; åŒè¯­åˆ†ç¦»å¤„ç†
            chineseText := ""
            nonChineseText := ""
            hasThai := false
            Tag := ""
            Loop, Parse, ClipData
            {
                char := A_LoopField
                if (IsChinese(char) || RegExMatch(char, "\d") || RegExMatch(char, "\p{P}"))
                    chineseText .= char
                else
                    nonChineseText .= char
                if (IsThai(char))
                    hasThai := true
            }

            Remark := chineseText != "" ? chineseText : SubStr(nonChineseText, 1, 1000)
            Remark := RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ")
            Content := nonChineseText

            if (hasThai) {
                Tag := "æ³°æ–‡"
            }

            ; è®¡ç®—å­—èŠ‚ (åŸºäº Content)
            ByteCount := StrPut(Content, "UTF-8") - 1
            Bytes := ""
            if (ByteCount > 0) {
                if (ByteCount < 1024)
                    Bytes := ByteCount . " B"
                else if (ByteCount < 1024 * 1024)
                    Bytes := Round(ByteCount / 1024,2) . " KB"
                else if (ByteCount < 1024 * 1024 * 1024)
                    Bytes := Round(ByteCount / (1024 * 1024),2) . " MB"
                else
                    Bytes := Round(ByteCount / (1024 * 1024 * 1024),2) . " GB"
            }

            try {
                HashValue := Crypt.Hash.Str(nonChineseText, "SHA256")
            } catch e {
                eMessage := e.Message
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š542882 è®¡ç®—å“ˆå¸Œå€¼å¤±è´¥: %eMessage%
                FailedCount++
                continue
            }

            MaxSortSQL := "SELECT COALESCE(MAX(æ’åº), 0) + 1 AS NewSort FROM æ•°æ®æ”¶é›†;"
            MaxSortResult := {}
            NewSortValue := 1
            if (!SQLiteDB.GetTable(MaxSortSQL, MaxSortResult)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5917034 è·å–æœ€å¤§æ’åºå€¼å¤±è´¥: %ErrorMsg%
                FailedCount++
                continue
            }
            if (MaxSortResult.RowCount > 0) {
                NewSortValue := MaxSortResult.Rows[1][1]
            }

            ExistingID := ""
            CheckSQL := "SELECT ID FROM æ•°æ®æ”¶é›† WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
            CheckResult := {}
            if (SQLiteDB.GetTable(CheckSQL, CheckResult, [HashValue]) && CheckResult.RowCount >= 1) {
                ExistingID := CheckResult.Rows[1][1]
            }

            if (StrLen(Content) > 1000000) {
                Content := SubStr(Content, 1, 1000000)
            }
            if (StrLen(Remark) > 1000) {
                Remark := SubStr(Remark, 1, 1000)
            }
            HashValue := HashValue ? HashValue : ""
            Bytes := Bytes ? Bytes : ""
            WindowDetail := WindowDetail ? WindowDetail : ""
            Identifier := Identifier ? Identifier : ""
            Format := Format ? Format : ""
            NewSortValue := NewSortValue ? NewSortValue : 1
            Remark := Remark ? RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            Content := Content ? RegExReplace(Content, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            Group := Group ? RegExReplace(Group, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            AppName := AppName ? RegExReplace(AppName, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : "æœªçŸ¥åº”ç”¨"

            EscapedHashValue := StrReplace(HashValue, "'", "''")
            EscapedBytes := StrReplace(Bytes, "'", "''")
            EscapedWindowDetail := StrReplace(WindowDetail, "'", "''")
            EscapedIdentifier := StrReplace(Identifier, "'", "''")
            EscapedFormat := StrReplace(Format, "'", "''")
            EscapedRemark := StrReplace(Remark, "'", "''")
            EscapedContent := StrReplace(Content, "'", "''")
            EscapedGroup := StrReplace(Group, "'", "''")
            EscapedAppName := StrReplace(AppName, "'", "''")
            EscapedClipData := StrReplace(nonChineseText, "'", "''")

            Success := false
            RetryCount := 3
            LocalG_last_insert_rowid := ""
            if (ExistingID != "") {
                UpdateSQL := "UPDATE æ•°æ®æ”¶é›† SET æ’åº = " . NewSortValue . ", æ›´æ–°æ¬¡æ•° = COALESCE(æ›´æ–°æ¬¡æ•°, 0) + 1, ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime'), è®¿é—®æ—¶é—´ = datetime('now', 'localtime'), å¤‡æ³¨ = '" . EscapedRemark . "', å†…å®¹ = '" . EscapedContent . "', å­—èŠ‚ = '" . EscapedBytes . "', çª—å£è¯¦æƒ… = '" . EscapedWindowDetail . "', åˆ†ç»„ = '" . EscapedGroup . "', åº”ç”¨åç§° = '" . EscapedAppName . "', ç¦åˆ  = 1 WHERE ID = " . ExistingID . ";"
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(UpdateSQL)) {
                        Success := true
                        FinalID := ExistingID  ; æ›´æ–°ä¸ºå½“å‰
                        LocalG_last_insert_rowid := ExistingID
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }

                DeleteDataSQL := "DELETE FROM Data_æ•°æ®æ”¶é›† WHERE lParentID = " . FinalID . ";"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(DeleteDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }

                InsertDataSQL := "INSERT INTO Data_æ•°æ®æ”¶é›† (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", 'CF_UNICODETEXT', '" . EscapedClipData . "');"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }
            } else {
                InsertMainSQL := "INSERT INTO æ•°æ®æ”¶é›† (å“ˆå¸Œå€¼, å­—èŠ‚, çª—å£è¯¦æƒ…, æ’åº, æ›´æ–°æ¬¡æ•°, åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´, è®¿é—®æ—¶é—´, å¤‡æ³¨, å†…å®¹, åˆ†ç»„, åº”ç”¨åç§°, ç¦åˆ ) VALUES ('" . EscapedHashValue . "', '" . EscapedBytes . "', '" . EscapedWindowDetail . "', " . NewSortValue . ", 0, datetime('now', 'localtime'), datetime('now', 'localtime'), datetime('now', 'localtime'), '" . EscapedRemark . "', '" . EscapedContent . "', '" . EscapedGroup . "', '" . EscapedAppName . "', 1);"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertMainSQL)) {
                        Success := true
                        FinalID := SQLiteDB.LastInsertRowID  ; ç”¨LastInsertRowIDè·å–ID
                        LocalG_last_insert_rowid := FinalID
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }

                InsertDataSQL := "INSERT INTO Data_æ•°æ®æ”¶é›† (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", 'CF_UNICODETEXT', '" . EscapedClipData . "');"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }
            }

            ; å±æ€§æ’å…¥ (åŠ Tagï¼Œå‚è€ƒClipboardChangedï¼Œç”¨DataID)
            Attributes := []
            Attributes.Push({Format: "æ˜Ÿçº§", Value: "0"})
            if (Tag != "") {
                Attributes.Push({Format: "å…³é”®å­—", Value: Tag})
            }
            if (Group != "") {
                Attributes.Push({Format: "åˆ†ç»„", Value: Group})
            }
            if (AppName != "" && AppName != "æœªçŸ¥åº”ç”¨") {
                Attributes.Push({Format: "åº”ç”¨åç§°", Value: AppName})
                Tags := []
                if (RegExMatch(AppName, "^(.+?)\s*-\s*(.+)$", Match)) {
                    FirstPart := Trim(Match1)
                    SecondPart := Trim(Match2)
                    if (!RegExMatch(FirstPart, "\.[a-zA-Z0-9]{1,4}$")) {
                        Tags.Push(FirstPart)
                    }
                    if (SecondPart = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(SecondPart)
                    }
                } else {
                    if (AppName = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(AppName)
                    }
                }
                for idx, TagItem in Tags {
                    if (TagItem != "" && TagItem != "æœªçŸ¥åº”ç”¨") {
                        Attributes.Push({Format: "å…³é”®å­—", Value: TagItem})
                    }
                }
            }
            if (Identifier != "") {
                Attributes.Push({Format: "æ ‡è¯†", Value: Identifier})
            }
            if (Format != "") {
                Attributes.Push({Format: "ç±»å‹", Value: Format})
            }

            LocalAttrErrors := 0
            for idx, attr in Attributes {
                if (attr.Value = "" || (attr.Format = "æ˜Ÿçº§" && attr.Value = "0")) {
                    continue
                }
                EscapedFormat := StrReplace(attr.Format, "'", "''")
                EscapedValue := StrReplace(attr.Value, "'", "''")
                InsertAttributeSQL := "INSERT INTO æ•°æ®æ”¶é›†_å…³è”å±æ€§ (lParentID, Format, Value) VALUES (" . FinalID . ", '" . EscapedFormat . "', '" . EscapedValue . "');"
                AddDebugLog("[WriteData1014] å°è¯•ç›´æ¥æ’å…¥å±æ€§: " . InsertAttributeSQL)
                if (!SQLiteDB.Exec(InsertAttributeSQL)) {
                    LocalAttrErrors++
                    AddDebugLog("[WriteData1014] ç›´æ¥æ’å…¥å±æ€§å¤±è´¥: " . SQLiteDB._ErrMsg())
                }
            }
            if (LocalAttrErrors > 0) {
                AddDebugLog("[WriteData1014] å±æ€§æ’å…¥è­¦å‘Š: " . LocalAttrErrors . " ä¸ªå¤±è´¥ for ID " . FinalID)
            }

            ; éªŒè¯å±æ€§ï¼ˆç”¨IDï¼‰
            AttrCount := VerifyAllAttributes(FinalID, "æ•°æ®æ”¶é›†")  ; è°ƒæ•´ä¸ºID + è¡¨å
            if (AttrCount < 0) {
                AddDebugLog("[WriteData1014] å±æ€§éªŒè¯å¤±è´¥ for ID " . FinalID)
            }

            ; æ›´æ–°å…¨å±€IDï¼ˆå½“å‰è¡Œï¼‰
            if (LocalG_last_insert_rowid != "") {
                G_last_insert_rowid := LocalG_last_insert_rowid
            }

            InsertedCount++
            AddDebugLog("[WriteData1014] æˆåŠŸå¤„ç†è¡Œ " . index . "ï¼ŒID: " . FinalID)
        }

        ; ç»Ÿä¸€æäº¤äº‹åŠ¡ï¼ˆå‚è€ƒTogglePinnedæ‰¹é‡ï¼‰
        if (!CommitSafeTransaction("WriteData1014-Batch")) {
            RollbackSafeTransaction("WriteData1014-Batch")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4338280 æ‰¹é‡äº‹åŠ¡æäº¤å¤±è´¥ï¼æˆåŠŸ %InsertedCount% æ¡ï¼Œå¤±è´¥ %FailedCount% æ¡
            Return
        }

        ; åˆ†ç±»å­—å…¸_Oneï¼ˆæœ€åæ’å…¥IDä¸ºæœ€åä¸€ä¸ªFinalIDï¼‰
        DeleteRecordSQL := "DELETE FROM åˆ†ç±»å­—å…¸_One WHERE Category_Main = 'æœ€åæ’å…¥ID';"
        if (!SQLiteDB.Exec(DeleteRecordSQL)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š6839150 åˆ é™¤åˆ†ç±»å­—å…¸_Oneå¤±è´¥: %ErrorMsg%
            Return
        }

        InsertRecordSQL := "INSERT OR REPLACE INTO åˆ†ç±»å­—å…¸_One (Category_Main, Category_Sub, Record_Value) VALUES ('æœ€åæ’å…¥ID', '', " . (FinalID ? FinalID : "NULL") . ");"
        if (!SQLiteDB.Exec(InsertRecordSQL)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5307196 æ’å…¥åˆ†ç±»å­—å…¸_Oneå¤±è´¥: %ErrorMsg%
            Return
        }

        SB_SetText("WriteData1014: æ‰¹é‡æ’å…¥å®Œæˆï¼ŒæˆåŠŸ " . InsertedCount . " æ¡" . (FailedCount > 0 ? "ï¼Œå¤±è´¥ " . FailedCount . " æ¡" : ""))
        AddDebugLog("[WriteData1014] æ‰¹é‡å®Œæˆ: æˆåŠŸ " . InsertedCount . "ï¼Œå¤±è´¥ " . FailedCount)
    } catch e {
        eMessage := e.Message
        RollbackSafeTransaction("WriteData1014-Batch")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4851383 WriteData1014 å¼‚å¸¸: %eMessage%
        SB_SetText("WriteData1014: æ‰¹é‡å¼‚å¸¸ï¼Œå¤±è´¥ " . FailedCount . " æ¡")
    } finally {
        ; ç¼“å­˜å½“å‰è®°å½•ï¼ˆæœ€åä¸€ä¸ªï¼‰
        g_CurrentRecord.ID := G_last_insert_rowid
        g_CurrentRecord.TableName := "æ•°æ®æ”¶é›†"

        ; æŒä¹…åŒ–CurrentRecordï¼ˆé‡è¯•ï¼Œå‚è€ƒClipboardChangedï¼Œç®€åŒ–ï¼‰
        RetryPersist := 2
        while (RetryPersist > 0) {
            try {
                SQL := "INSERT OR REPLACE INTO åˆ†ç±»å­—å…¸_One (Category_Main, Category_Sub, Record_Value) VALUES ('CurrentRecord', '', " . (FinalID ? FinalID : "NULL") . ");"
                if (SQLiteDB.Exec(SQL)) {
                    break
                }
            } catch e {
                ErrorMsg := e.Message
            }
            Sleep, 50
            RetryPersist--
        }

        SB_SetText("WriteData1014: å¡«å……ç¼“å­˜ ID=" . SubStr(FinalID, 1, 8) . "..." . (InsertedCount > 0 ? " (æˆåŠŸ " . InsertedCount . ")" : ""))

        ProcessingContext := ""
        if (ClipboardLock = 1) {
            ClipboardLock := 0
            PostMessage, 0x0400 + 1, 0, 0, , ahk_class AutoHotkey
        }
        LoadData()
        SaveDataTip()
        SetTimer, WatchDatabaseDir, 3000
    }

    AddDebugLog("[WriteData1014] ç»“æŸ")
}

;===================|===================

WriteData1015() {
    Global SQLiteDB, DBPath, ClipboardLock, ProcessingContext, g_CurrentRecord, ContentCache, G_last_insert_rowid
    ClipboardLock := 1
    ProcessingContext := "WriteData1015"

    WinGetTitle, WindowTitle, A
    if (RegExMatch(WindowTitle, "(.+?)\s*-\s*(.+)$", Match)) {
        AppName := Trim(Match2)
    } else {
        AppName := WindowTitle ? WindowTitle : "æœªçŸ¥åº”ç”¨"
    }
    WindowDetail := WindowTitle ? WindowTitle : ""
    Group := ""
    DataType := 1
    Identifier := ""
    Format := "CF_UNICODETEXT,æ–‡æœ¬"

    FinalID := ""
    InsertedCount := 0
    FailedCount := 0
    try {
        if (!CheckDBUnlocked(DBPath)) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š274754 æ•°æ®åº“è¢«å ç”¨ï¼Œè¯·ç¨åå†è¯•
            Return
        }

        if (!SQLiteDB) {
            SQLiteDB := New SQLiteDB()
            if (!SQLiteDB.OpenDB(DBPath)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š882623 æ•°æ®åº“æ‰“å¼€å¤±è´¥: %ErrorMsg%
                Return
            }
        }

        CheckSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ•°æ®æ”¶é›†';"
        CheckResult := {}
        if (!SQLiteDB.GetTable(CheckSQL, CheckResult) || CheckResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š972832 æ•°æ®æ”¶é›†è¡¨ä¸å­˜åœ¨ï¼
            Return
        }
        CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ•°æ®æ”¶é›†_å…³è”å±æ€§';"
        PropTableResult := {}
        if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5407851 æ•°æ®æ”¶é›†_å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            Return
        }
        CheckAssocTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='å…³è”å±æ€§è¡¨';"
        AssocTableResult := {}
        if (!SQLiteDB.GetTable(CheckAssocTableSQL, AssocTableResult) || AssocTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š6676530 å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            Return
        }

        GetColumnsSQL := "PRAGMA table_info(æ•°æ®æ”¶é›†);"
        ColumnsResult := {}
        RequiredFields := ["å¤‡æ³¨", "å†…å®¹", "ç½®é¡¶", "ç½®é¡¶ç´¢å¼•", "æ”¶è—", "ç¦åˆ ", "æ˜Ÿçº§", "æ ‡ç­¾", "åˆ†ç»„", "ç±»å‹", "åˆ›å»ºæ—¶é—´", "ä¿®æ”¹æ—¶é—´", "è®¿é—®æ—¶é—´", "è®¿é—®æ¬¡æ•°", "æ›´æ–°æ¬¡æ•°", "å­—èŠ‚", "å­—ç¬¦", "è¡Œæ•°", "æ•°é‡", "æ ‡è¯†", "çª—å£è¯¦æƒ…", "åº”ç”¨åç§°", "å“ˆå¸Œå€¼", "æ’åº", "æ ‡è®°çŠ¶æ€"]
        MissingFields := []
        if (SQLiteDB.GetTable(GetColumnsSQL, ColumnsResult)) {
            ExistingColumns := []
            Loop, % ColumnsResult.RowCount {
                ExistingColumns.Insert(ColumnsResult.Rows[A_Index][2])
            }
            for index, field in RequiredFields {
                if (!ArrayContains(ExistingColumns, field)) {
                    MissingFields.Insert(field)
                }
            }
            if (MissingFields.MaxIndex() > 0) {
                MissingFieldsList := Join(MissingFields, ", ")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5145204 æ•°æ®æ”¶é›†è¡¨ç¼ºå°‘å¿…è¦å­—æ®µï¼š%MissingFieldsList%
                Return
            }
        } else {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5209176 æŸ¥è¯¢è¡¨ç»“æ„å¤±è´¥: %ErrorMsg%
            Return
        }

        Sleep, 100

        if (!BeginSafeTransaction("WriteData1015-Batch")) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1933330 å¼€å§‹æ‰¹é‡äº‹åŠ¡å¤±è´¥ï¼
            Return
        }

        for index, ClipData in ContentCache {
            ClipData := RegExReplace(ClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", "")
            ClipData := Trim(ClipData)
            if (ClipData = "" || StrLen(ClipData) > 5000000) {
                FailedCount++
                continue
            }

            chineseText := ""
            nonChineseText := ""
            hasThai := false
            Tag := ""
            Loop, Parse, ClipData
            {
                char := A_LoopField
                if (IsChinese(char) || RegExMatch(char, "\d") || RegExMatch(char, "\p{P}"))
                    chineseText .= char
                else
                    nonChineseText .= char
                if (IsThai(char))
                    hasThai := true
            }

            Remark := chineseText != "" ? chineseText : SubStr(nonChineseText, 1, 1000)
            Remark := RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ")
            Content := nonChineseText

            if (hasThai) {
                Tag := "æ³°æ–‡"
            }

            ByteCount := StrPut(Content, "UTF-8") - 1
            Bytes := ""
            if (ByteCount > 0) {
                if (ByteCount < 1024)
                    Bytes := ByteCount . " B"
                else if (ByteCount < 1024 * 1024)
                    Bytes := Round(ByteCount / 1024,2) . " KB"
                else if (ByteCount < 1024 * 1024 * 1024)
                    Bytes := Round(ByteCount / (1024 * 1024),2) . " MB"
                else
                    Bytes := Round(ByteCount / (1024 * 1024 * 1024),2) . " GB"
            }

            try {
                HashValue := Crypt.Hash.Str(nonChineseText, "SHA256")
            } catch e {
                eMessage := e.Message
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š968710 è®¡ç®—å“ˆå¸Œå€¼å¤±è´¥: %eMessage%
                FailedCount++
                continue
            }

            MaxSortSQL := "SELECT COALESCE(MAX(æ’åº), 0) + 1 AS NewSort FROM æ•°æ®æ”¶é›†;"
            MaxSortResult := {}
            NewSortValue := 1
            if (!SQLiteDB.GetTable(MaxSortSQL, MaxSortResult)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š202508 è·å–æœ€å¤§æ’åºå€¼å¤±è´¥: %ErrorMsg%
                FailedCount++
                continue
            }
            if (MaxSortResult.RowCount > 0) {
                NewSortValue := MaxSortResult.Rows[1][1]
            }

            ExistingID := ""
            CheckSQL := "SELECT ID FROM æ•°æ®æ”¶é›† WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
            CheckResult := {}
            if (SQLiteDB.GetTable(CheckSQL, CheckResult, [HashValue]) && CheckResult.RowCount >= 1) {
                ExistingID := CheckResult.Rows[1][1]
            }

            if (StrLen(Content) > 1000000) {
                Content := SubStr(Content, 1, 1000000)
            }
            if (StrLen(Remark) > 1000) {
                Remark := SubStr(Remark, 1, 1000)
            }
            HashValue := HashValue ? HashValue : ""
            Bytes := Bytes ? Bytes : ""
            WindowDetail := WindowDetail ? WindowDetail : ""
            Identifier := Identifier ? Identifier : ""
            Format := Format ? Format : ""
            NewSortValue := NewSortValue ? NewSortValue : 1
            Remark := Remark ? RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            Content := Content ? RegExReplace(Content, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            Group := Group ? RegExReplace(Group, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            AppName := AppName ? RegExReplace(AppName, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : "æœªçŸ¥åº”ç”¨"

            EscapedHashValue := StrReplace(HashValue, "'", "''")
            EscapedBytes := StrReplace(Bytes, "'", "''")
            EscapedWindowDetail := StrReplace(WindowDetail, "'", "''")
            EscapedIdentifier := StrReplace(Identifier, "'", "''")
            EscapedFormat := StrReplace(Format, "'", "''")
            EscapedRemark := StrReplace(Remark, "'", "''")
            EscapedContent := StrReplace(Content, "'", "''")
            EscapedGroup := StrReplace(Group, "'", "''")
            EscapedAppName := StrReplace(AppName, "'", "''")
            EscapedClipData := StrReplace(nonChineseText, "'", "''")

            Success := false
            RetryCount := 3
            LocalG_last_insert_rowid := ""
            if (ExistingID != "") {
                UpdateSQL := "UPDATE æ•°æ®æ”¶é›† SET æ’åº = " . NewSortValue . ", æ›´æ–°æ¬¡æ•° = COALESCE(æ›´æ–°æ¬¡æ•°, 0) + 1, ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime'), è®¿é—®æ—¶é—´ = datetime('now', 'localtime'), å¤‡æ³¨ = '" . EscapedRemark . "', å†…å®¹ = '" . EscapedContent . "', å­—èŠ‚ = '" . EscapedBytes . "', çª—å£è¯¦æƒ… = '" . EscapedWindowDetail . "', åˆ†ç»„ = '" . EscapedGroup . "', åº”ç”¨åç§° = '" . EscapedAppName . "', ç¦åˆ  = 1 WHERE ID = " . ExistingID . ";"
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(UpdateSQL)) {
                        Success := true
                        FinalID := ExistingID
                        LocalG_last_insert_rowid := ExistingID
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }

                DeleteDataSQL := "DELETE FROM Data_æ•°æ®æ”¶é›† WHERE lParentID = " . FinalID . ";"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(DeleteDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }

                InsertDataSQL := "INSERT INTO Data_æ•°æ®æ”¶é›† (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", 'CF_UNICODETEXT', '" . EscapedClipData . "');"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }
            } else {
                InsertMainSQL := "INSERT INTO æ•°æ®æ”¶é›† (å“ˆå¸Œå€¼, å­—èŠ‚, çª—å£è¯¦æƒ…, æ’åº, æ›´æ–°æ¬¡æ•°, åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´, è®¿é—®æ—¶é—´, å¤‡æ³¨, å†…å®¹, åˆ†ç»„, åº”ç”¨åç§°, ç¦åˆ ) VALUES ('" . EscapedHashValue . "', '" . EscapedBytes . "', '" . EscapedWindowDetail . "', " . NewSortValue . ", 0, datetime('now', 'localtime'), datetime('now', 'localtime'), datetime('now', 'localtime'), '" . EscapedRemark . "', '" . EscapedContent . "', '" . EscapedGroup . "', '" . EscapedAppName . "', 1);"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertMainSQL)) {
                        Success := true
                        FinalID := SQLiteDB.LastInsertRowID
                        LocalG_last_insert_rowid := FinalID
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }

                InsertDataSQL := "INSERT INTO Data_æ•°æ®æ”¶é›† (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", 'CF_UNICODETEXT', '" . EscapedClipData . "');"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }
            }

            Attributes := []
            Attributes.Push({Format: "æ˜Ÿçº§", Value: "0"})
            if (Tag != "") {
                Attributes.Push({Format: "å…³é”®å­—", Value: Tag})
            }
            if (Group != "") {
                Attributes.Push({Format: "åˆ†ç»„", Value: Group})
            }
            if (AppName != "" && AppName != "æœªçŸ¥åº”ç”¨") {
                Attributes.Push({Format: "åº”ç”¨åç§°", Value: AppName})
                Tags := []
                if (RegExMatch(AppName, "^(.+?)\s*-\s*(.+)$", Match)) {
                    FirstPart := Trim(Match1)
                    SecondPart := Trim(Match2)
                    if (!RegExMatch(FirstPart, "\.[a-zA-Z0-9]{1,4}$")) {
                        Tags.Push(FirstPart)
                    }
                    if (SecondPart = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(SecondPart)
                    }
                } else {
                    if (AppName = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(AppName)
                    }
                }
                for idx, t in Tags {
                    if (t != "" && t != "æœªçŸ¥åº”ç”¨") {
                        Attributes.Push({Format: "å…³é”®å­—", Value: t})
                    }
                }
            }
            if (Identifier != "") {
                Attributes.Push({Format: "æ ‡è¯†", Value: Identifier})
            }
            if (Format != "") {
                Attributes.Push({Format: "ç±»å‹", Value: Format})
            }

            LocalAttrErrors := 0
            for idx, attr in Attributes {
                if (attr.Value = "" || (attr.Format = "æ˜Ÿçº§" && attr.Value = "0")) {
                    continue
                }
                EscapedFormat := StrReplace(attr.Format, "'", "''")
                EscapedValue := StrReplace(attr.Value, "'", "''")
                InsertAttributeSQL := "INSERT INTO æ•°æ®æ”¶é›†_å…³è”å±æ€§ (lParentID, Format, Value) VALUES (" . FinalID . ", '" . EscapedFormat . "', '" . EscapedValue . "');"
                AddDebugLog("[WriteData1015] å°è¯•ç›´æ¥æ’å…¥å±æ€§: " . InsertAttributeSQL)
                if (!SQLiteDB.Exec(InsertAttributeSQL)) {
                    LocalAttrErrors++
                    AddDebugLog("[WriteData1015] ç›´æ¥æ’å…¥å±æ€§å¤±è´¥: " . SQLiteDB._ErrMsg())
                }
            }

            AttrCount := VerifyAllAttributes(FinalID, "æ•°æ®æ”¶é›†")
            if (AttrCount < 0) {
                ;
            }

            if (LocalG_last_insert_rowid != "") {
                G_last_insert_rowid := LocalG_last_insert_rowid
            }

            InsertedCount++
        }

        if (!CommitSafeTransaction("WriteData1015-Batch")) {
            RollbackSafeTransaction("WriteData1015-Batch")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4341889 æ‰¹é‡äº‹åŠ¡æäº¤å¤±è´¥ï¼æˆåŠŸ %InsertedCount% æ¡ï¼Œå¤±è´¥ %FailedCount% æ¡
            Return
        }

        ; === ä¿å­˜æœ€åæ’å…¥IDï¼šCategory_Main = Category_Sub = 'æœ€åæ’å…¥ID' ===
        DeleteRecordSQL := "DELETE FROM ""åˆ†ç±»å­—å…¸_One"" WHERE ""Category_Main"" = 'æœ€åæ’å…¥ID' AND ""Category_Sub"" = 'æœ€åæ’å…¥ID';"
        SQLiteDB.Exec(DeleteRecordSQL)

        LastIDValue := (G_last_insert_rowid ? G_last_insert_rowid : "")
        InsertRecordSQL := "INSERT OR REPLACE INTO ""åˆ†ç±»å­—å…¸_One"" "       ; "åˆ†ç±»å­—å…¸_One"å·²ä¿®æ”¹
                         . "(""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('æœ€åæ’å…¥ID', 'æœ€åæ’å…¥ID', ?, 1, datetime('now','localtime'));"

        if (SQLiteDB.ExecuteWithParams) {
            SQLiteDB.ExecuteWithParams(InsertRecordSQL, [LastIDValue])
        } else {
            EscapedLastID := StrReplace(LastIDValue, "'", "''")
            FallbackSQL := "INSERT OR REPLACE INTO ""åˆ†ç±»å­—å…¸_One"" "
                         . "(""Category_Main"", ""Category_Sub"", ""Record_Value"", ""Flag_Status"", ""Update_Time"") "
                         . "VALUES ('æœ€åæ’å…¥ID', 'æœ€åæ’å…¥ID', '" . EscapedLastID . "', 1, datetime('now','localtime'));"
            SQLiteDB.Exec(FallbackSQL)
        }

        SB_SetText("WriteData1015: æ‰¹é‡æ’å…¥å®Œæˆï¼ŒæˆåŠŸ " . InsertedCount . " æ¡" . (FailedCount > 0 ? "ï¼Œå¤±è´¥ " . FailedCount . " æ¡" : ""))
    } catch e {
        eMessage := e.Message
        RollbackSafeTransaction("WriteData1015-Batch")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4856558 WriteData1015 å¼‚å¸¸: %eMessage%
        SB_SetText("WriteData1015: æ‰¹é‡å¼‚å¸¸ï¼Œå¤±è´¥ " . FailedCount . " æ¡")
    } finally {
        g_CurrentRecord.ID := G_last_insert_rowid
        g_CurrentRecord.TableName := "æ•°æ®æ”¶é›†"

        SB_SetText("WriteData1015: å¡«å……ç¼“å­˜ ID=" . SubStr(FinalID, 1, 8) . "..." . (InsertedCount > 0 ? " (æˆåŠŸ " . InsertedCount . ")" : ""))

        ProcessingContext := ""
        if (ClipboardLock = 1) {
            ClipboardLock := 0
            PostMessage, 0x0400 + 1, 0, 0, , ahk_class AutoHotkey
        }
        LoadData()
        SaveDataTip()
        SetTimer, WatchDatabaseDir, 3000
    }
}

;===================|===================

WriteData1016() {
    Global SQLiteDB, DBPath, ClipboardLock, ProcessingContext, g_CurrentRecord, ContentCache, G_last_insert_rowid
    AddDebugLog("[WriteData1016] å¼€å§‹")
    ClipboardLock := 1
    ProcessingContext := "WriteData1016"

    WinGetTitle, WindowTitle, A
    if (RegExMatch(WindowTitle, "(.+?)\s*-\s*(.+)$", Match)) {
        AppName := Trim(Match2)
    } else {
        AppName := WindowTitle ? WindowTitle : "æœªçŸ¥åº”ç”¨"
    }
    WindowDetail := WindowTitle ? WindowTitle : ""
    Group := ""  ; æ— åˆ†ç»„
    DataType := 1  ; æ–‡æœ¬
    Identifier := "" ; Identifier := "ğŸ“„"
    Format := "CF_UNICODETEXT,æ–‡æœ¬"

    FinalID := ""  ; ç”¨äºfinallyå’Œåˆ†ç±»å­—å…¸_Oneï¼ˆæœ€åä¸€ä¸ªIDï¼‰
    InsertedCount := 0
    FailedCount := 0
    try {
        if (!CheckDBUnlocked(DBPath)) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š912808 æ•°æ®åº“è¢«å ç”¨ï¼Œè¯·ç¨åå†è¯•
            Return
        }

        if (!SQLiteDB) {
            SQLiteDB := New SQLiteDB()
            if (!SQLiteDB.OpenDB(DBPath)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š430657 æ•°æ®åº“æ‰“å¼€å¤±è´¥: %ErrorMsg%
                Return
            }
        }

        ; æ£€æŸ¥æ•°æ®æ”¶é›†è¡¨å’Œå…³è”è¡¨å­˜åœ¨ï¼ˆå‚è€ƒClipboardChangedï¼‰
        CheckSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ•°æ®æ”¶é›†';"
        CheckResult := {}
        if (!SQLiteDB.GetTable(CheckSQL, CheckResult) || CheckResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š850420 æ•°æ®æ”¶é›†è¡¨ä¸å­˜åœ¨ï¼
            Return
        }
        CheckPropTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='æ•°æ®æ”¶é›†_å…³è”å±æ€§';"
        PropTableResult := {}
        if (!SQLiteDB.GetTable(CheckPropTableSQL, PropTableResult) || PropTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5411518 æ•°æ®æ”¶é›†_å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            Return
        }
        CheckAssocTableSQL := "SELECT name FROM sqlite_master WHERE type='table' AND name='å…³è”å±æ€§è¡¨';"
        AssocTableResult := {}
        if (!SQLiteDB.GetTable(CheckAssocTableSQL, AssocTableResult) || AssocTableResult.RowCount = 0) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1929759 å…³è”å±æ€§è¡¨ä¸å­˜åœ¨ï¼
            Return
        }

        GetColumnsSQL := "PRAGMA table_info(æ•°æ®æ”¶é›†);"
        ColumnsResult := {}
        RequiredFields := ["å¤‡æ³¨", "å†…å®¹", "ç½®é¡¶", "ç½®é¡¶ç´¢å¼•", "æ”¶è—", "ç¦åˆ ", "æ˜Ÿçº§", "æ ‡ç­¾", "åˆ†ç»„", "ç±»å‹", "åˆ›å»ºæ—¶é—´", "ä¿®æ”¹æ—¶é—´", "è®¿é—®æ—¶é—´", "è®¿é—®æ¬¡æ•°", "æ›´æ–°æ¬¡æ•°", "å­—èŠ‚", "å­—ç¬¦", "è¡Œæ•°", "æ•°é‡", "æ ‡è¯†", "çª—å£è¯¦æƒ…", "åº”ç”¨åç§°", "å“ˆå¸Œå€¼", "æ’åº", "æ ‡è®°çŠ¶æ€"]
        MissingFields := []
        if (SQLiteDB.GetTable(GetColumnsSQL, ColumnsResult)) {
            ExistingColumns := []
            Loop, % ColumnsResult.RowCount {
                ExistingColumns.Insert(ColumnsResult.Rows[A_Index][2])
            }
            for index, field in RequiredFields {
                if (!ArrayContains(ExistingColumns, field)) {
                    MissingFields.Insert(field)
                }
            }
            if (MissingFields.MaxIndex() > 0) {
                MissingFieldsList := Join(MissingFields, ", ")
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š9153746 æ•°æ®æ”¶é›†è¡¨ç¼ºå°‘å¿…è¦å­—æ®µï¼š%MissingFieldsList%
                Return
            }
        } else {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š5158123 æŸ¥è¯¢è¡¨ç»“æ„å¤±è´¥: %ErrorMsg%
            Return
        }

        Sleep, 100  ; é˜²å¡é¡¿ï¼Œå‚è€ƒClipboardChanged

        if (!BeginSafeTransaction("WriteData1016-Batch")) {
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1936036 å¼€å§‹æ‰¹é‡äº‹åŠ¡å¤±è´¥ï¼
            Return
        }

        ; å¤„ç†ContentCacheä¸­çš„æ¯å¯¹å†…å®¹ï¼ˆå¶æ•°è¡Œåˆå¹¶å¤„ç†ï¼Œç»Ÿä¸€äº‹åŠ¡å†…ï¼‰
        total := ContentCache.MaxIndex()
        Loop, % total//2 {
            i := (A_Index-1)*2+1
            line1 := ContentCache[i]
            line2 := ContentCache[i+1]
            ClipData := line1 . line2

            ; æ¸…ç†å†…å®¹
            ClipData := RegExReplace(ClipData, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", "")
            ClipData := Trim(ClipData)
            if (ClipData = "" || StrLen(ClipData) > 5000000) {
                FailedCount++
                continue
            }

            ; åŒè¯­åˆ†ç¦»å¤„ç†
            chineseText := ""
            nonChineseText := ""
            hasThai := false
            Tag := ""
            Loop, Parse, ClipData
            {
                char := A_LoopField
                if (IsChinese(char) || RegExMatch(char, "\d") || RegExMatch(char, "\p{P}"))
                    chineseText .= char
                else
                    nonChineseText .= char
                if (IsThai(char))
                    hasThai := true
            }

            Remark := chineseText != "" ? chineseText : SubStr(nonChineseText, 1, 1000)
            Remark := RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ")
            Content := nonChineseText

            if (hasThai) {
                Tag := "æ³°æ–‡"
            }

            ; è®¡ç®—å­—èŠ‚ (åŸºäº Content)
            ByteCount := StrPut(Content, "UTF-8") - 1
            Bytes := ""
            if (ByteCount > 0) {
                if (ByteCount < 1024)
                    Bytes := ByteCount . " B"
                else if (ByteCount < 1024 * 1024)
                    Bytes := Round(ByteCount / 1024,2) . " KB"
                else if (ByteCount < 1024 * 1024 * 1024)
                    Bytes := Round(ByteCount / (1024 * 1024),2) . " MB"
                else
                    Bytes := Round(ByteCount / (1024 * 1024 * 1024),2) . " GB"
            }

            try {
                HashValue := Crypt.Hash.Str(nonChineseText, "SHA256")
            } catch e {
                eMessage := e.Message
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š688037 è®¡ç®—å“ˆå¸Œå€¼å¤±è´¥: %eMessage%
                FailedCount++
                continue
            }

            MaxSortSQL := "SELECT COALESCE(MAX(æ’åº), 0) + 1 AS NewSort FROM æ•°æ®æ”¶é›†;"
            MaxSortResult := {}
            NewSortValue := 1
            if (!SQLiteDB.GetTable(MaxSortSQL, MaxSortResult)) {
                ErrorMsg := SQLiteDB._ErrMsg()
                MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š1759036 è·å–æœ€å¤§æ’åºå€¼å¤±è´¥: %ErrorMsg%
                FailedCount++
                continue
            }
            if (MaxSortResult.RowCount > 0) {
                NewSortValue := MaxSortResult.Rows[1][1]
            }

            ExistingID := ""
            CheckSQL := "SELECT ID FROM æ•°æ®æ”¶é›† WHERE å“ˆå¸Œå€¼ = ? LIMIT 1;"
            CheckResult := {}
            if (SQLiteDB.GetTable(CheckSQL, CheckResult, [HashValue]) && CheckResult.RowCount >= 1) {
                ExistingID := CheckResult.Rows[1][1]
            }

            if (StrLen(Content) > 1000000) {
                Content := SubStr(Content, 1, 1000000)
            }
            if (StrLen(Remark) > 1000) {
                Remark := SubStr(Remark, 1, 1000)
            }
            HashValue := HashValue ? HashValue : ""
            Bytes := Bytes ? Bytes : ""
            WindowDetail := WindowDetail ? WindowDetail : ""
            Identifier := Identifier ? Identifier : ""
            Format := Format ? Format : ""
            NewSortValue := NewSortValue ? NewSortValue : 1
            Remark := Remark ? RegExReplace(Remark, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            Content := Content ? RegExReplace(Content, "[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            Group := Group ? RegExReplace(Group, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : ""
            AppName := AppName ? RegExReplace(AppName, "[\r\n\x00-\x08\x0B\x0C\x0E-\x1F\x7F]", " ") : "æœªçŸ¥åº”ç”¨"

            EscapedHashValue := StrReplace(HashValue, "'", "''")
            EscapedBytes := StrReplace(Bytes, "'", "''")
            EscapedWindowDetail := StrReplace(WindowDetail, "'", "''")
            EscapedIdentifier := StrReplace(Identifier, "'", "''")
            EscapedFormat := StrReplace(Format, "'", "''")
            EscapedRemark := StrReplace(Remark, "'", "''")
            EscapedContent := StrReplace(Content, "'", "''")
            EscapedGroup := StrReplace(Group, "'", "''")
            EscapedAppName := StrReplace(AppName, "'", "''")
            EscapedClipData := StrReplace(nonChineseText, "'", "''")

            Success := false
            RetryCount := 3
            LocalG_last_insert_rowid := ""
            if (ExistingID != "") {
                UpdateSQL := "UPDATE æ•°æ®æ”¶é›† SET æ’åº = " . NewSortValue . ", æ›´æ–°æ¬¡æ•° = COALESCE(æ›´æ–°æ¬¡æ•°, 0) + 1, ä¿®æ”¹æ—¶é—´ = datetime('now', 'localtime'), è®¿é—®æ—¶é—´ = datetime('now', 'localtime'), å¤‡æ³¨ = '" . EscapedRemark . "', å†…å®¹ = '" . EscapedContent . "', å­—èŠ‚ = '" . EscapedBytes . "', çª—å£è¯¦æƒ… = '" . EscapedWindowDetail . "', åˆ†ç»„ = '" . EscapedGroup . "', åº”ç”¨åç§° = '" . EscapedAppName . "', ç¦åˆ  = 1 WHERE ID = " . ExistingID . ";"
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(UpdateSQL)) {
                        Success := true
                        FinalID := ExistingID  ; æ›´æ–°ä¸ºå½“å‰
                        LocalG_last_insert_rowid := ExistingID
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }

                DeleteDataSQL := "DELETE FROM Data_æ•°æ®æ”¶é›† WHERE lParentID = " . FinalID . ";"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(DeleteDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }

                InsertDataSQL := "INSERT INTO Data_æ•°æ®æ”¶é›† (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", 'CF_UNICODETEXT', '" . EscapedClipData . "');"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }
            } else {
                InsertMainSQL := "INSERT INTO æ•°æ®æ”¶é›† (å“ˆå¸Œå€¼, å­—èŠ‚, çª—å£è¯¦æƒ…, æ’åº, æ›´æ–°æ¬¡æ•°, åˆ›å»ºæ—¶é—´, ä¿®æ”¹æ—¶é—´, è®¿é—®æ—¶é—´, å¤‡æ³¨, å†…å®¹, åˆ†ç»„, åº”ç”¨åç§°, ç¦åˆ ) VALUES ('" . EscapedHashValue . "', '" . EscapedBytes . "', '" . EscapedWindowDetail . "', " . NewSortValue . ", 0, datetime('now', 'localtime'), datetime('now', 'localtime'), datetime('now', 'localtime'), '" . EscapedRemark . "', '" . EscapedContent . "', '" . EscapedGroup . "', '" . EscapedAppName . "', 1);"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertMainSQL)) {
                        Success := true
                        FinalID := SQLiteDB.LastInsertRowID  ; ç”¨LastInsertRowIDè·å–ID
                        LocalG_last_insert_rowid := FinalID
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }

                InsertDataSQL := "INSERT INTO Data_æ•°æ®æ”¶é›† (lParentID, strClipBoardFormat, ooData) VALUES (" . FinalID . ", 'CF_UNICODETEXT', '" . EscapedClipData . "');"
                RetryCount := 3
                Success := false
                while (RetryCount > 0) {
                    if (SQLiteDB.Exec(InsertDataSQL)) {
                        Success := true
                        break
                    }
                    ErrorMsg := SQLiteDB._ErrMsg()
                    if (InStr(ErrorMsg, "SQLITE_BUSY")) {
                        Sleep, 100
                        RetryCount--
                        continue
                    }
                    break
                }
                if (!Success) {
                    FailedCount++
                    continue
                }
            }

            ; å±æ€§æ’å…¥ (åŠ Tagï¼Œå‚è€ƒClipboardChangedï¼Œç”¨DataID)
            Attributes := []
            Attributes.Push({Format: "æ˜Ÿçº§", Value: "0"})
            if (Tag != "") {
                Attributes.Push({Format: "å…³é”®å­—", Value: Tag})
            }
            if (Group != "") {
                Attributes.Push({Format: "åˆ†ç»„", Value: Group})
            }
            if (AppName != "" && AppName != "æœªçŸ¥åº”ç”¨") {
                Attributes.Push({Format: "åº”ç”¨åç§°", Value: AppName})
                Tags := []
                if (RegExMatch(AppName, "^(.+?)\s*-\s*(.+)$", Match)) {
                    FirstPart := Trim(Match1)
                    SecondPart := Trim(Match2)
                    if (!RegExMatch(FirstPart, "\.[a-zA-Z0-9]{1,4}$")) {
                        Tags.Push(FirstPart)
                    }
                    if (SecondPart = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(SecondPart)
                    }
                } else {
                    if (AppName = "Google Chrome") {
                        Tags.Push("Chrome")
                    } else {
                        Tags.Push(AppName)
                    }
                }
                for idx, t in Tags {
                    if (t != "" && t != "æœªçŸ¥åº”ç”¨") {
                        Attributes.Push({Format: "å…³é”®å­—", Value: t})
                    }
                }
            }
            if (Identifier != "") {
                Attributes.Push({Format: "æ ‡è¯†", Value: Identifier})
            }
            if (Format != "") {
                Attributes.Push({Format: "ç±»å‹", Value: Format})
            }

            LocalAttrErrors := 0
            for idx, attr in Attributes {
                if (attr.Value = "" || (attr.Format = "æ˜Ÿçº§" && attr.Value = "0")) {
                    continue
                }
                EscapedFormat := StrReplace(attr.Format, "'", "''")
                EscapedValue := StrReplace(attr.Value, "'", "''")
                InsertAttributeSQL := "INSERT INTO æ•°æ®æ”¶é›†_å…³è”å±æ€§ (lParentID, Format, Value) VALUES (" . FinalID . ", '" . EscapedFormat . "', '" . EscapedValue . "');"
                AddDebugLog("[WriteData1016] å°è¯•ç›´æ¥æ’å…¥å±æ€§: " . InsertAttributeSQL)
                if (!SQLiteDB.Exec(InsertAttributeSQL)) {
                    LocalAttrErrors++
                    AddDebugLog("[WriteData1016] ç›´æ¥æ’å…¥å±æ€§å¤±è´¥: " . SQLiteDB._ErrMsg())
                }
            }
            if (LocalAttrErrors > 0) {
                AddDebugLog("[WriteData1016] å±æ€§æ’å…¥è­¦å‘Š: " . LocalAttrErrors . " ä¸ªå¤±è´¥ for ID " . FinalID)
            }

            ; éªŒè¯å±æ€§ï¼ˆç”¨IDï¼‰
            AttrCount := VerifyAllAttributes(FinalID, "æ•°æ®æ”¶é›†")  ; è°ƒæ•´ä¸ºID + è¡¨å
            if (AttrCount < 0) {
                AddDebugLog("[WriteData1016] å±æ€§éªŒè¯å¤±è´¥ for ID " . FinalID)
            }

            ; æ›´æ–°å…¨å±€IDï¼ˆå½“å‰è¡Œï¼‰
            if (LocalG_last_insert_rowid != "") {
                G_last_insert_rowid := LocalG_last_insert_rowid
            }

            InsertedCount++
            AddDebugLog("[WriteData1016] æˆåŠŸå¤„ç†å¯¹ " . A_Index . "ï¼ŒID: " . FinalID)
        }

        ; ç»Ÿä¸€æäº¤äº‹åŠ¡ï¼ˆå‚è€ƒTogglePinnedæ‰¹é‡ï¼‰
        if (!CommitSafeTransaction("WriteData1016-Batch")) {
            RollbackSafeTransaction("WriteData1016-Batch")
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4344295 æ‰¹é‡äº‹åŠ¡æäº¤å¤±è´¥ï¼æˆåŠŸ %InsertedCount% æ¡ï¼Œå¤±è´¥ %FailedCount% æ¡
            Return
        }

        ; åˆ†ç±»å­—å…¸_Oneï¼ˆæœ€åæ’å…¥IDä¸ºæœ€åä¸€ä¸ªFinalIDï¼‰
        DeleteRecordSQL := "DELETE FROM åˆ†ç±»å­—å…¸_One WHERE Category_Main = 'æœ€åæ’å…¥ID';"
        if (!SQLiteDB.Exec(DeleteRecordSQL)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š7291456 åˆ é™¤åˆ†ç±»å­—å…¸_Oneå¤±è´¥: %ErrorMsg%
            Return
        }

        InsertRecordSQL := "INSERT OR REPLACE INTO åˆ†ç±»å­—å…¸_One (Category_Main, Category_Sub, Record_Value) VALUES ('æœ€åæ’å…¥ID', '', " . (FinalID ? FinalID : "NULL") . ");"
        if (!SQLiteDB.Exec(InsertRecordSQL)) {
            ErrorMsg := SQLiteDB._ErrMsg()
            MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š8592666 æ’å…¥åˆ†ç±»å­—å…¸_Oneå¤±è´¥: %ErrorMsg%
            Return
        }

        SB_SetText("WriteData1016: æ‰¹é‡æ’å…¥å®Œæˆï¼ŒæˆåŠŸ " . InsertedCount . " æ¡" . (FailedCount > 0 ? "ï¼Œå¤±è´¥ " . FailedCount . " æ¡" : ""))
        AddDebugLog("[WriteData1016] æ‰¹é‡å®Œæˆ: æˆåŠŸ " . InsertedCount . "ï¼Œå¤±è´¥ " . FailedCount)
    } catch e {
        eMessage := e.Message
        RollbackSafeTransaction("WriteData1016-Batch")
        MsgBox, 16, é”™è¯¯, é”™è¯¯ IDï¼š4901779 WriteData1016 å¼‚å¸¸: %eMessage%
        SB_SetText("WriteData1016: æ‰¹é‡å¼‚å¸¸ï¼Œå¤±è´¥ " . FailedCount . " æ¡")
    } finally {
        ; ç¼“å­˜å½“å‰è®°å½•ï¼ˆæœ€åä¸€ä¸ªï¼‰
        g_CurrentRecord.ID := G_last_insert_rowid
        g_CurrentRecord.TableName := "æ•°æ®æ”¶é›†"

        ; æŒä¹…åŒ–CurrentRecordï¼ˆé‡è¯•ï¼Œå‚è€ƒClipboardChangedï¼Œç®€åŒ–ï¼‰
        RetryPersist := 2
        while (RetryPersist > 0) {
            try {
                SQL := "INSERT OR REPLACE INTO åˆ†ç±»å­—å…¸_One (Category_Main, Category_Sub, Record_Value) VALUES ('CurrentRecord', '', " . (FinalID ? FinalID : "NULL") . ");"
                if (SQLiteDB.Exec(SQL)) {
                    break
                }
            } catch e {
                ErrorMsg := e.Message
            }
            Sleep, 50
            RetryPersist--
        }

        SB_SetText("WriteData1016: å¡«å……ç¼“å­˜ ID=" . SubStr(FinalID, 1, 8) . "..." . (InsertedCount > 0 ? " (æˆåŠŸ " . InsertedCount . ")" : ""))

        ProcessingContext := ""
        if (ClipboardLock = 1) {
            ClipboardLock := 0
            PostMessage, 0x0400 + 1, 0, 0, , ahk_class AutoHotkey
        }
        LoadData()
        SaveDataTip()
        SetTimer, WatchDatabaseDir, 3000
    }

    AddDebugLog("[WriteData1016] ç»“æŸ")
}
